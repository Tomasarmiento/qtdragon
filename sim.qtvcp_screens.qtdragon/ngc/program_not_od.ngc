;


(**********************************************************************)
(***** CALCULATIONS BASED ON COUPLING DIMENSIONS                  *****)
(**********************************************************************)

;CALCULATIONS BASED ON COUPLING DIMENSIONS - START

    ;**** VALUES LOADED BY THE OPERATOR FROM DE PANEL ****
    #<_od_raw_diameter>= 666
    #<_od_machined_diameter>= 666
    #<_id_diameter>= 666

    #<_raw_coupling_length>= 666
    #<_op10_coupling_length>= 666
    #<_final_coupling_length>= 666

    #<_lathe_axial_stopper>= 666



    ;**** VALUES OF DE COUPLING USED AS MASTER (TO OBTAIN THE FIRST DIMENSIONS) ****
    ; IN THIS CASE THE COUPLING WAS OF D148.4 x L 240 ****
    #<_reference_diameter>= 148.4 
    #<_reference_length>= 240 



    ;**** "PS" REFERS TO PARKING (USES RAW DIAMETER) & BLOWER (USES RAW & FINAL DIAMETER) ****

    ;VALUE OBTAINED BY THE CALCULATIONS OF THE EXCEL FILE, WITH THE INPUT DIMENSIONS OF THE REFERENCE COUPLING
    ; IN THIS CASE THE COUPLING WAS OF D148.4 x L 240
    #<_d_reference_height_ps>= 70.83

    ;CALCULATED VALUES WRITEN HERE BY PYTHON MASTER OBTAINED BASED IN THE INFORMATION LOADED BY THE OPERATOR IN DE PANEL 
    #<_d_raw_height_ps>= 341.862911121
    #<_d_machined_height_ps>= 341.862911121

    ;DIAMETER CORRECTIONS
    #<_d_raw_height_correction_ps>= [#<_d_raw_height_ps>-#<_d_reference_height_ps>] ;correction when raw diameter is used
    #<_d_machined_height_correction_ps>= [#<_d_machined_height_ps>-#<_d_reference_height_ps>] ;correction when machined diameter is used



    ;**** "CD" REFERS TO LOAD (USES RAW DIAMETER) & UNLOAD (USES FINAL DIAMETER) ****

    ;VALUE OBTAINED BY THE CALCULATIONS OF THE EXCEL FILE, WITH THE INPUT DIMENSIONS OF THE REFERENCE COUPLING
    ; IN THIS CASE THE COUPLING WAS OF D148.4 x L 240
    #<_d_reference_height_cd>= 90.58

    ;CALCULATED VALUES WRITEN HERE BY PYTHON MASTER OBTAINED BASED IN THE INFORMATION LOADED BY THE OPERATOR IN DE PANEL 
    #<_d_raw_height_cd>= 406.517938058
    #<_d_machined_height_cd>= 406.517938058

    ;DIAMETER CORRECTIONS
    #<_d_raw_height_correction_cd>= [#<_d_raw_height_cd>-#<_d_reference_height_cd>] ;correction when raw diameter is used
    #<_d_machined_height_correction_cd>= [#<_d_machined_height_cd>-#<_d_reference_height_cd>] ;correction when machined diameter is used

;CALCULATIONS BASED ON COUPLING DIMENSIONS - END




o<call_parameters> CALL

;MEASURED POSITION POINTS explanation - START

    ;ALL THE VALUS WITH THE "ENTER Y" NAME GO DIRECTLY TO THE FINAL CENTER AT THE Y COORDINATE

    ; ********** Parking  ********** 
    ; (raw couplings)

    ;#<_parking_plate_to_gripper_down_x> = with gripper down - is the X coordinate of the unit stop plate (as if the gripper sheetmetal with compressed springs would be at the plate)
    ;#<_parking_gripper_down_enter_y> = with gripper down - is at the center of the unit in the Y coordinate
    ;#<_parking_gripper_down_z_reference> = with gripper down - is at the center of the reference coupling installed in the unit, the Z coordinate

    ;#<_parking_plate_to_gripper_up_x> = with gripper up - is the X coordinate of the unit stop plate (as if the gripper sheetmetal with compressed springs would be at the plate)
    ;#<_parking_gripper_up_enter_y> = with gripper up - is at the center of the unit in the Y coordinate
    ;#<_parking_gripper_up_z_reference> = with gripper up - is at the center of the reference coupling installed in the unit, the Z coordinate


    ; ********** Blower gripper_down ********** 
    ; (machined couplings)

    ;#<_blower_plate_to_gripper_down_x> = with gripper down - is the X coordinate of the unit stop plate (as if the gripper sheetmetal with compressed springs would be at the plate)
    ;#<_blower_enter_y> = with gripper down - is at the center of the unit in the Y coordinate
    ;#<_blower_gripper_down_z_reference> = with gripper down - is at the center of the reference coupling installed in the unit, the Z coordinate
    

    ; ********** Load Gripper down **********
    ; (raw couplings)

    ;#<_load_plate_to_gripper_down_x> = with gripper down - is the X coordinate of the unit stop plate (as if the gripper sheetmetal with compressed springs would be at the plate)    
    ;#<_load_enter_y> = with gripper down - is at the center of the unit in the Y coordinate
    ;#<_load_gripper_down_z_reference> = with gripper down - is at the center of the reference coupling installed in the unit, the Z coordinate


    ; ********** Unload gripper_down ********** 
    ; (machined couplings) 
    
    ;#<_unload_plate_to_gripper_down_x> = with gripper down - is the X coordinate of the unit stop plate (as if the gripper sheetmetal with compressed springs would be at the plate)
    ;#<_unload_enter_y> = with gripper down - is at the center of the unit in the Y coordinate
    ;#<_unload_gripper_down_z_reference> = with gripper down - is at the center of the reference coupling installed in the unit, the Z coordinate
 

    ; ********** Tumbler  ********** 
    ;(we say that always uses raw diameter couplings because is the bigest diameter, anyway is centered)
    
    ;#<_tumbler_gripper_down_jaws_center_x> = with gripper down - is the X coordinate of the unit center (as if the gripper sheetmetal with compressed springs would be at the center of the jaws thickness)
    ;#<_tumbler_enter_down_y> = with gripper down - is at the center of the unit in the Y coordinate
    ;#<_tumbler_gripper_down_z> = with gripper down - is at the center of the unit in the Z coordinate

    ;#<_tumbler_gripper_up_jaws_center_x> = with gripper up - is the X coordinate of the unit center (as if the gripper sheetmetal with compressed springs would be at the center of the jaws thickness)
    ;#<_tumbler_enter_up_y> = with gripper up - is at the center of the unit in the Y coordinate
    ;#<_tumbler_gripper_up_z> = with gripper up - is at the center of the unit in the Z coordinate


    ; ********** Lathe **********
    ; we consider the couplings with raw length
    ; and the differents lengths from raw, op10 and op20 (finished)
    ; are absorbed by the measuring routine
    ; *** REVIEW

    ;#<_lathe_chuck_front_to_gripper_down_x> = with gripper down - is the X coordinate of the front of the chuck as if the gripper sheetmetal with compressed springs would be there with 3mm of light
    ;#<_lathe_gripper_down_center_y> = with gripper down - is at the center of the lathe chuck in the Y coordinate
    ;#<_lathe_gripper_down_center_z> = with gripper down - is at the center of the lathe chuck in the Z coordinate

    ;#<_lathe_chuck_front_to_gripper_up_x> = with gripper up - is the coordinate of the front of the chuck as if the gripper sheetmetal with compressed springs would be there with 3mm of light
    ;#<_lathe_gripper_up_center_y> = with gripper up - is at the center of the lathe chuck in the Y coordinate
    ;#<_lathe_gripper_up_center_z> = with gripper up - is at the center of the lathe chuck in the Z coordinate

;MEASURED POSITION POINTS explanation - END




;(**********************************************************************)
;(***** DEFINED POSITIONS & DIMENSIONS                             *****)
;(**********************************************************************)

;DEFINED POSITIONS & DIMENSIONS - START

    ; ********** SERVICE POSITION **********
    #<_x_service_position> = 1000
    #<_y_service_position> = 0
    #<_z_service_position> = 750



    ; ********** SAFE POSITION **********
    #<_y_secure_position> = 0
    #<_z_secure_position> = 1350



    ; ********** MEASURING **********
    #<_offset_after_measuring> = 4
    #<_measuring_limit> = 20



    ; ********** UNLOAD **********
    #<_unload_light>=3


    
    ; ********** Parking  ********** 
    ; (raw couplings)
    #<_parking_offset_x_measuring>=4
    #<_parking_z_offset>=8
    #<_parking_gripper_up_x_error_accepted>=6
    #<_parking_gripper_down_x_error_accepted>=6



    ; ********** Blower gripper_down ********** 
    ; (machined couplings)
    #<_blower_offset_x_measuring>=4
    #<_blower_z_offset>=6
    #<_blower_gripper_down_x_error_accepted>=6



    ; ********** Load Gripper down **********
    ; (raw couplings)
    #<_load_offset_x_measuring>=4
    #<_load_z_offset>=5
    #<_load_gripper_down_x_error_accepted>=6



    ; ********** Unload gripper_down ********** 
    ; (machined couplings)
    #<_unload_z_offset>=5



    ; ********** Tumbler  ********** 
    ;(we say that always uses raw diameter couplings because is the bigest diameter, anyway is centered)
    #<_tumbler_offset_x_measuring>=10
    #<_tumbler_x_error_accepted>=6
    #<_tumbler_x_displacement>=20



    ; ********** Lathe **********
    ; we consider the couplings with raw length
    ; and the differents lengths from raw, op10 and op20 (finished)
    ; are absorbed by the measuring routine
    #<_lathe_offset_x_measuring>=6
    #<_lathe_gripper_down_x_error_accepted>=6

;DEFINED POSITIONS & DIMENSIONS - END




;(**********************************************************************)
;(***** RELATIVE POSITION POINTS                                   *****)
;(**********************************************************************)

;RELATIVE POSITION POINTS - START

    ; ********** Parking  ********** 
    ; (raw couplings)

    #<_parking_enter_x_over_bars>=[#<_parking_plate_to_gripper_down_x> + 352]
    #<_parking_enter_z>=[#<_parking_gripper_down_z_reference> + 52]

    #<_parking_aproximates_x>=[#<_parking_plate_to_gripper_down_x> + 322]

    #<_parking_enter_x_free>=[#<_parking_plate_to_gripper_down_x> + 522]
    
    #<_parking_gripper_down_unload_x_calculated>=[#<_parking_plate_to_gripper_down_x> + #<_unload_light> + #<_raw_coupling_length>]
    #<_parking_gripper_down_load_x_calculated>=[#<_parking_plate_to_gripper_down_x> + #<_raw_coupling_length>]
    #<_parking_gripper_down_z_calculated>=[#<_parking_gripper_down_z_reference> + #<_d_raw_height_correction_ps>]
    
    #<_parking_gripper_up_unload_x_calculated>=[#<_parking_plate_to_gripper_up_x> + #<_unload_light> + #<_raw_coupling_length>]
    #<_parking_gripper_up_load_x_calculated>=[#<_parking_plate_to_gripper_up_x> + #<_raw_coupling_length>]
    #<_parking_gripper_up_z_calculated>=[#<_parking_gripper_up_z_reference> + #<_d_raw_height_correction_ps>]



    ; ********** Blower gripper_down ********** 
    ; (machined couplings)

    #<_blower_enter_x>=[#<_blower_plate_to_gripper_down_x> + 511]

    #<_blower_aproximates_x>=[#<_blower_plate_to_gripper_down_x> + 301]
    
    #<_blower_gripper_down_unload_x_calculated>=[#<_blower_plate_to_gripper_down_x> + #<_unload_light> + #<_final_coupling_length>]
    #<_blower_gripper_down_load_x_calculated>=[#<_blower_plate_to_gripper_down_x> + #<_final_coupling_length>]
    #<_blower_gripper_down_z_calculated_machined>=[#<_blower_gripper_down_z_reference> + #<_d_machined_height_correction_ps>]



    ; ********** Load Gripper down **********
    ; (raw couplings)

    #<_load_enter_x>=[#<_load_plate_to_gripper_down_x> + 423]
    
    #<_load_aproximates_x>=[#<_load_plate_to_gripper_down_x> + 323] 

    #<_load_gripper_down_x_calculated>=[#<_load_plate_to_gripper_down_x> + #<_raw_coupling_length>] 
    #<_load_gripper_down_z_calculated>=[#<_load_gripper_down_z_reference> + #<_d_raw_height_correction_cd>]



    ; ********** Unload gripper_down ********** 
    ; (machined couplings)

    #<_unload_enter_x>=[#<_unload_plate_to_gripper_down_x> + 510]

    #<_unload_aproximates_x>=[#<_unload_plate_to_gripper_down_x> + 300]

    #<_unload_enter_intermediate_x>=[#<_unload_plate_to_gripper_down_x> + 330]
    #<_unload_enter_intermediate_Z>=[#<_unload_gripper_down_z_reference> + 127.6]

    #<_unload_gripper_down_x_calculated>=[#<_unload_plate_to_gripper_down_x> + #<_unload_light> + #<_final_coupling_length>]
    #<_unload_gripper_down_z_calculated>=[#<_unload_gripper_down_z_reference> + #<_d_machined_height_correction_cd>] ;always uses machined diameter


    ; ********** Tumbler  ********** 
    ;this center (Y & Z coordinates) does not change with the couplings diameter
    
    #<_tumbler_enter_x>=[#<_tumbler_gripper_down_jaws_center_x> + 350]

    #<_tumbler_gripper_down_unload_x_calculated>=[#<_tumbler_gripper_down_jaws_center_x> + #<_raw_coupling_length> / 2] ;the coupling loaded in the gripper, compressing gripper springs, it must be at the center of the tumbler
    
    #<_tumbler_gripper_down_load_x_calculated>=[#<_tumbler_gripper_down_jaws_center_x> + #<_raw_coupling_length> / 2] ;the coupling is at the center of the tumbler, and the Gantry aproximates until leaving 2mm gap between the plate and the sensor

    #<_tumbler_gripper_down_extracts>=[#<_tumbler_gripper_down_jaws_center_x> + 212]
    ;this dimension is the measurement that the coupling is extracted towards one end
    ;it always extracts them to the same dimension which is the maximum that the shortest coupling can be extracted
    ;thats enough to load it with gripper up
    ;it is: (X value with gripper at the center of the tumbler) + (shortest coupling length) - (thickness of tumbler jaws / 2)
    ;it is: 809+230-17=1022

    #<_tumbler_aproximates_down_x>=[#<_tumbler_gripper_down_jaws_center_x> + 240] ;we use extract X value + plus

    #<_tumbler_aproximates_up_x>=[#<_tumbler_gripper_up_jaws_center_x> + 240] ;we use extract X value + plus

    #<_tumbler_gripper_down_load_from_extract>=[#<_tumbler_gripper_down_jaws_center_x> + 215]
    ;from the previously extended end of the coupling (_tumbler_gripper_down_extracts), the Gantry aproximates until leaving 2mm gap between the plate and the sensor
    ;there is no length correction, because the dimension does not change with the couplng length variation, it is a fix dimension
    ;*** This value must be almost the same than _tumbler_gripper_down_extracts ***

    #<_tumbler_gripper_up_load_from_extract>=[#<_tumbler_gripper_up_jaws_center_x> + 215]
    ;from the previously extended end of the coupling (_tumbler_gripper_down_extracts), the Gantry aproximates until leaving 2mm gap between the plate and the sensor
    ;there is no length correction, because the dimension does not change with the couplng length variation, it is a fix dimension
    ;*** This value must be almost the same than _tumbler_gripper_down_extracts ***




    ; ********** Lathe **********
    ; we consider the couplings with raw length
    ; and the differents lengths from raw, op10 and op20 (finished)
    ; are absorbed by the measuring routine
    ; *** REVIEW

    #<_lathe_enter1_x>=[#<_lathe_chuck_front_to_gripper_down_x> + 523.7]
    #<_lathe_enter1_y>=[#<_lathe_gripper_down_center_y> - 96]
    #<_lathe_enter1_z>=[#<_lathe_gripper_down_center_z> + 12]

    #<_lathe_enter2_y>=[#<_lathe_gripper_down_center_y> - 179]
    #<_lathe_enter2_z>=[#<_lathe_gripper_down_center_z> + 202]

    #<_lathe_enter3_z>=[#<_lathe_gripper_up_center_z>+22]

    #<_lathe_gripper_down_aproximates_x>=[#<_lathe_chuck_front_to_gripper_down_x> + 414]
    #<_lathe_gripper_up_aproximates_x>=[#<_lathe_chuck_front_to_gripper_up_x> + 414]

    #<_lathe_gripper_down_x_calculated>=[#<_lathe_chuck_front_to_gripper_down_x> + #<_lathe_axial_stopper> + #<_raw_coupling_length>]
    #<_lathe_gripper_up_x_calculated>=[#<_lathe_chuck_front_to_gripper_up_x> + #<_lathe_axial_stopper> + #<_unload_light> + #<_raw_coupling_length>]

;RELATIVE POSITION POINTS - END




(**********************************************************************)
(***** VELOCITIES                                                 *****)
(**********************************************************************)

#<_VEL_FAST>=35000
#<_VEL_MEDIUM>=15000
#<_VEL_SLOW>=3000
#<_VEL_RTN_MEAS>=400





(**********************************************************************)
(***** HEADING                                                    *****)
(**********************************************************************)

G10 L2 P1 X0 Y0 Z0 ;offset G54
G90 ;absolute distance
G54 ;zero
G64 P1 ;path blending(cont)
;M68 E0 Q30 ;change acceleration X
;M68 E1 Q20 ;change acceleration Y
;M68 E2 Q10 ;change acceleration Z



(**********************************************************************)
(***************            PROGRAM SELECTOR            ***************)
(**********************************************************************)

;Program Selector

    m66 e01 l0 

    o430 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRINTING_VARIABLES> ] ;PRINT VARIABLES
        (debug, PRINT VARIABLES)
        ;(log, )
        M100 P180
        o180 CALL
        M02
    o430 ENDIF

    o435 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]DEBUGGING> ] ;DEBUG
        (debug, DEBUG)
        ;(log, )
        M100 P190
        o190 CALL
        M02
    o435 ENDIF

    o450 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]UNLOAD_PARKING> ] ;UNLOAD PARKING
        (debug, UNLOAD PARKING)
        ;(log, )
        M100 P220
        o220 CALL
        M02
    o450 ENDIF

    o460 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]UNLOAD_BLOWER> ] ;UNLOAD BLOWER
        (debug, UNLOAD BLOWER)
        ;(log, )
        M100 P250
        o250 CALL
        M02
    o460 ENDIF

    o475 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]UNLOAD_LATHE> ] ;UNLOAD LATHE
        (debug, UNLOAD LATHE)
        ;(log, )
        M100 P270
        o270 CALL
        M02
    o475 ENDIF

    o500 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]UNLOAD_TUMBLER_BEFORE_TURNING> ] ;UNLOAD TUMBLER BEFORE TURNING
        (debug, UNLOAD TUMBLER BEFORE TURNING)
        ;(log, )
        M100 P300
        o300 CALL
        M02
    o500 ENDIF

    o505 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]UNLOAD_TUMBLER_AFTER_TURNED> ] ;UNLOAD TUMBLER AFTER TURNED
        (debug, UNLOAD TUMBLER AFTER TURNED)
        ;(log, )
        M100 P310
        o310 CALL
        M02
    o505 ENDIF

    o525 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]UNLOAD_GRIPPER_UP> ] ;UNLOAD GRIPPER UP
        (debug, UNLOAD GRIPPER UP)
        ;(log, )
        M100 P320
        o320 CALL
        M02
    o525 ENDIF

    o550 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]UNLOAD_GRIPPER_DOWN> ] ;UNLOAD GRIPPER DOWN
        (debug, UNLOAD GRIPPER DOWN)
        ;(log, )
        M100 P350
        o350 CALL
        M02
    o550 ENDIF

    o575 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]SERVICE_POSITION> ] ;SERVICE POS
        (debug, SERVICE POS)
        ;(log, )
        M100 P370
        o370 CALL
        M02
    o575 ENDIF
    
    ;********************
    ;**** PRODUCTION ****
    ;********************

    o440 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRODUCTION_STEP0>] ;PRODUCTION step 0 CONDITION Gantry empty / Lathe empty
        (debug, PRODUCTION step 0)
        ;(log, )
        #<_step>=0
        M100 P4000
        o400 CALL
        M02
    o440 ENDIF
    
    o441 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRODUCTION_STEP1>] ;PRODUCTION step 1 CONDITION Gantry RAW MATERIAL GR UP / Lathe empty
        (debug, PRODUCTION step 1)
        ;(log, )  
        #<_step>=1
        M100 P4001
        o400 CALL
        M02
    o441 ENDIF

    o442 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRODUCTION_STEP2>] ;PRODUCTION step 2 CONDITION Gantry empty /Lathe OP10
        (debug, PRODUCTION step 2)
        ;(log, )  
        #<_step>=2
        M100 P4002
        o400 CALL
        M02
    o442 ENDIF

    o443 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRODUCTION_STEP3>] ;PRODUCTION step 3 CONDITION Gantry RAW MATERIAL GR UP /Lathe OP10
        (debug, PRODUCTION step 3)
        ;(log, )    
        #<_step>=3    
        M100 P4003
        o400 CALL
        M02
    o443 ENDIF

    o444 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRODUCTION_STEP4>] ;PRODUCTION step 4 CONDITION Gantry OP10 TURNED GR UP / Lathe OP10
        (debug, PRODUCTION step 4)
        ;(log, )     
        #<_step>=4   
        M100 P4004
        o400 CALL
        M02
    o444 ENDIF

    o445 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRODUCTION_STEP5>] ;PRODUCTION step 5 CONDITION Gantry OP10 TURNED GR UP / Lathe OP20 
        (debug, PRODUCTION step 5)
        ;(log, )
        #<_step>=5
        M100 P4005
        o400 CALL
        M02
    o445 ENDIF

    o446 IF [#5399 EQ #<_ini[SUBROUTINE_NUMBER_SELECTION]PRODUCTION_STEP6>] ;PRODUCTION step 6 CONDITION Gantry RAW MATERIAL GR UP / Lathe OP20
        (debug, PRODUCTION step 6)
        ;(log, )  
        #<_step>=6
        M100 P4006
        o400 CALL
        M02
    o446 ENDIF

    (debug, *** NO SELECTION FOUND ***)
    M02

;END



(**********************************************************************)
(***** DEBUG                                                      *****)
(**********************************************************************)

o190 SUB ; routines for debugging
    ;o800 CALL ;initializations
    ;o801 CALL ;checkings
    ;o1300 CALL ;LOAD gripper down
    ;o1200 CALL ;blower gripper down leaves
    ;o1250 CALL ;blower gripper down grabs
    ;o2100 CALL ;PARKING - GRIPPER DOWN LEAVE - GRIPPER UP GRAB
    ;o1100 CALL ;PARKING gripper up LEAVE
    ;o1050 CALL ;PARKING gripper down GRAB 
    ;o1500 CALL ;TUMBLER gripper start down - ends down
    ;o1350 CALL ;UNLOAD gripper down
    ;o1400 CALL ;TUMBLER gripper start down - ends up
    ;o3500 CALL ;TUMBLER gripper down grabs BEFORE TURNING
    ;o3550 CALL ;TUMBLER gripper down grabs AFTER TURNED
    ;o2150 CALL ; ----- OP20 -----
    ;o2200 CALL ; **** OP10 ****
    ;o3000 CALL ;LATHE STARTS - gripper down leaves coupling
    ;o3200 CALL ;LATHE PRODUCTION gripper down GRABS / gripper up LEAVES
    ;o3400 CALL ;LATHE ENDS - gripper down GRABS
    (debug, 30 seconds to end)
    G4 P30
    M02

o190 ENDSUB



(**********************************************************************)
(***** PRODUCTION PROGRAM WITH STEPS                              *****)
(**********************************************************************)
 
o400 SUB

    o800 CALL ;initializations
    o801 CALL ;checkings
    M100 P1

    ;*** STEP 0 - gantry empty / lathe empty ***
    o600 IF [#<_step> EQ 0]
        (debug, STEP 0 - gantry empty-lathe empty)

        (debug, 0 - checkings step 0)
        o802 CALL ;checkings step 0
        
        (debug, 0 - LOAD gripper down)
        o1300 CALL ;LOAD gripper down      
        
        #<_step>=1
    o600 ENDIF

    ;*** STEP 1 - gantry raw / lathe empty ***
    o601 IF [#<_step> EQ 1]
        (debug, STEP 1 - gantry raw-lathe empty)

        (debug, 1 - checkings step 1)
        o803 CALL ;checkings step 1
        
        (debug, 1 - LATHE STARTS - gripper down leaves coupling)
        o3000 CALL ;LATHE STARTS - gripper down leaves coupling
        o2200 CALL ; **** OP10 ****
        
        #<_step>=2
    o601 ENDIF

    ;*** STEP 2 - gantry empty / lathe op10 ***
    o602 IF [#<_step> EQ 2]
        (debug, STEP 2 - gantry empty-lathe op10)
        
        (debug, 2 - checkings step 2)
        o804 CALL ;checkings step 2
        
        (debug, 2 - LOAD gripper down)
        o1300 CALL ;LOAD gripper down
        
        (debug, 2 - PARKING - DOWN LEAVES - UP GRABS)
        o2100 CALL ;PARKING - DOWN LEAVES - UP GRABS
        
        #<_step>=3
    o602 ENDIF

    #<_end> = 0
    o604 WHILE [#<_end> EQ 0]

        ;*** STEP 3 -  gantry raw up / lathe op10 ***
        o606 IF [#<_step> EQ 3]
            (debug, STEP 3 -  gantry raw up / lathe op10)

            (debug, 3 - checkings step 3 to 6)
            o806 CALL ;checkings step 3 to 6
            
            (debug, 3 - LATHE PRODUCTION gripper down GRABS & gripper up LEAVES)
            o3200 CALL ;LATHE PRODUCTION gripper down GRABS & gripper up LEAVES
            o2200 CALL ; **** OP10 ****

            (debug, 3 - TUMBLER enter gripper down - exit gripper up)
            ;o1400 CALL ;TUMBLER enter gripper down - exit gripper up
            o1500 CALL ;TUMBLER gripper start down - ends down
            o2100 CALL ;PARKING - GRIPPER DOWN LEAVE - GRIPPER UP GRAB

            #<_step>=4
        o606 ENDIF
        
        ;*** STEP 4 - gantry op10T up / lathe op10 ***
        o608 IF [#<_step> EQ 4]
            (debug, STEP 4 - gantry op10T up / lathe op10)

            (debug, 4 - checkings step 3 to 6)
            o806 CALL ;checkings step 3 to 6
            
            (debug, 4 - LATHE PRODUCTION gripper down GRABS & gripper up LEAVES)
            o3200 CALL ;LATHE PRODUCTION gripper down GRABS / gripper up LEAVES
            o2150 CALL ; ----- OP20 -----
            
            (debug, 4 - TUMBLER enter gripper down - exit gripper up)
            ;o1400 CALL ;TUMBLER enter gripper down - exit gripper up
            o1500 CALL ;TUMBLER gripper start down - ends down
            o2100 CALL ;PARKING - GRIPPER DOWN LEAVE - GRIPPER UP GRAB            

            #<_step>=5
        o608 ENDIF

        ;*** STEP 5 - gantry op10T up / lathe op20 ***
        o610 IF [#<_step> EQ 5]
            (debug, STEP 5 - gantry op10T up / lathe op20)

            (debug, 5 - checkings step 3 to 6)
            o806 CALL ;checkings step 3 to 6

            (debug, 5 - LATHE PRODUCTION gripper down GRABS & gripper up LEAVES)
            o3200 CALL ;LATHE PRODUCTION gripper down GRABS / gripper up LEAVES
            o2150 CALL ; ----- OP20 -----

            (debug, 5 - BLOWER)
            o1200 CALL ;blower gripper down leaves
            o1250 CALL ;blower gripper down grabs
            
            (debug, 5 - UNLOAD gripper down)
            o1350 CALL ;UNLOAD gripper down
            
            (debug, 5 - LOAD gripper down)
            o1300 CALL ;LOAD gripper down
            
            (debug, 5 - PARKING - DOWN LEAVES - UP GRABS)
            o2100 CALL ;PARKING - DOWN LEAVES - UP GRABS

            #<_step>=6
        o610 ENDIF

        ;*** STEP 6 - gantry raw up / lathe op20 ***
        o612 IF [#<_step> EQ 6]
            (debug, STEP 6 - gantry raw up-lathe op20)
            
            (debug, 6 - checkings step 3 to 6)
            o806 CALL ;checkings step 3 to 6

            (debug, 6 - LATHE PRODUCTION gripper down GRABS & gripper up LEAVES)
            o3200 CALL ;LATHE PRODUCTION gripper down GRABS / gripper up LEAVES
            o2200 CALL ; **** OP10 ****
            
            (debug, 6 - BLOWER)
            o1200 CALL ;blower gripper down leaves
            o1250 CALL ;blower gripper down grabs

            (debug, 6 - UNLOAD gripper down)
            o1350 CALL ;UNLOAD gripper down

            ;LAST CYCLE signal
            M66 P49 L3 Q0.1	
            o614 IF [#5399 EQ 1] ; LAST CYCLE ON
                (debug, Last Cycle - gantry raw up-lathe op20)

                (debug, Last Cycle - LATHE ENDS - gripper down GRABS)
                o3400 CALL ;LATHE ENDS - gripper down GRABS

                (debug, Last Cycle - TUMBLER enter gripper down  - exit gripper down)
                O1500 CALL ;TUMBLER enter gripper down  - exit gripper down

                (debug, Last Cycle - LATHE STARTS - gripper down leaves coupling)
                o3000 CALL ;LATHE STARTS - gripper down leaves coupling
                o2150 CALL ; ----- OP20 -----

                (debug, Last Cycle - LATHE ENDS - gripper down GRABS)
                o3400 CALL ;LATHE ENDS - gripper down GRABS

                (debug, Last Cycle - BLOWER)
                o1200 CALL ;blower gripper down leaves
                o1250 CALL ;blower gripper down grabs

                (debug, Last Cycle - UNLOAD gripper down)
                o1350 CALL ;UNLOAD gripper down

                #<_step>=1
                #<_end>=1
                (debug, 30 seconds to end)
                G4 P30
                M02            

            o614 ELSE ; LAST CYCLE OFF
                (debug, STEP 6 Continues - gantry raw up-lathe op20)

                (debug, 6 - LOAD gripper down)
                o1300 CALL ;LOAD gripper down

                (debug, 6 - PARKING - DOWN LEAVES - UP GRABS)
                o2100 CALL ;PARKING - DOWN LEAVES - UP GRABS

                #<_step>=3
                #<_end>=0
            o614 ENDIF

        o612 ENDIF

    o604 ENDWHILE

    M02

o400 ENDSUB



(**********************************************************************)
(***** OTHER PARTIAL PROGRAMS                                     *****)
(**********************************************************************)

;PARTIAL PROGRAMS

    ;PRINT PARAMETERS
    o180 SUB
        (debug, <_parking_plate_to_gripper_down_x> = #<_parking_plate_to_gripper_down_x>)
        (debug, <_parking_gripper_down_enter_y> = #<_parking_gripper_down_enter_y>)
        (debug, <_parking_gripper_down_z_reference> = #<_parking_gripper_down_z_reference>)
        (debug, <_parking_plate_to_gripper_up_x> = #<_parking_plate_to_gripper_up_x>)
        (debug, <_parking_gripper_up_enter_y> = #<_parking_gripper_up_enter_y>)
        (debug, <_parking_gripper_up_z_reference> = #<_parking_gripper_up_z_reference>)
        (debug, <_parking_enter_x_over_bars> = #<_parking_enter_x_over_bars>)
        (debug, <_parking_enter_z> = #<_parking_enter_z>)
        (debug, <_parking_aproximates_x> = #<_parking_aproximates_x>)
        (debug, <_parking_enter_x_free> = #<_parking_enter_x_free>)
        (debug, <_parking_gripper_down_unload_x_calculated> = #<_parking_gripper_down_unload_x_calculated>)
        (debug, <_parking_gripper_down_load_x_calculated> = #<_parking_gripper_down_load_x_calculated>)
        (debug, <_parking_gripper_down_z_calculated> = #<_parking_gripper_down_z_calculated>)
        (debug, <_parking_gripper_up_unload_x_calculated> = #<_parking_gripper_up_unload_x_calculated>)
        (debug, <_parking_gripper_up_load_x_calculated> = #<_parking_gripper_up_load_x_calculated>)
        (debug, <_parking_gripper_up_z_calculated> = #<_parking_gripper_up_z_calculated>)
        (debug, <_parking_gripper_down_x_meas_ref> = #<_parking_gripper_down_x_meas_ref>)
        (debug, <_parking_gripper_up_x_meas_ref> = #<_parking_gripper_up_x_meas_ref>)

        (debug, <_blower_plate_to_gripper_down_x> = #<_blower_plate_to_gripper_down_x>)
        (debug, <_blower_enter_y> = #<_blower_enter_y>)
        (debug, <_blower_gripper_down_z_reference> = #<_blower_gripper_down_z_reference>)
        (debug, <_blower_enter_x> = #<_blower_enter_x>)
        (debug, <_blower_aproximates_x> = #<_blower_aproximates_x>)
        (debug, <_blower_gripper_down_unload_x_calculated> = #<_blower_gripper_down_unload_x_calculated>)
        (debug, <_blower_gripper_down_load_x_calculated> = #<_blower_gripper_down_load_x_calculated>)
        (debug, <_blower_gripper_down_z_calculated_machined> = #<_blower_gripper_down_z_calculated_machined>)
        (debug, <_blower_gripper_down_x_meas_ref_machined> = #<_blower_gripper_down_x_meas_ref_machined>)

        (debug, <_load_plate_to_gripper_down_x> = #<_load_plate_to_gripper_down_x>)
        (debug, <_load_enter_y> = #<_load_enter_y>)
        (debug, <_load_gripper_down_z_reference> = #<_load_gripper_down_z_reference>)
        (debug, <_load_enter_x> = #<_load_enter_x>)
        (debug, <_load_aproximates_x> = #<_load_aproximates_x>)
        (debug, <_load_gripper_down_x_calculated> = #<_load_gripper_down_x_calculated>)
        (debug, <_load_gripper_down_z_calculated> = #<_load_gripper_down_z_calculated>)
        (debug, <_load_gripper_down_x_meas_ref> = #<_load_gripper_down_x_meas_ref>)

        (debug, <_unload_plate_to_gripper_down_x> = #<_unload_plate_to_gripper_down_x>)
        (debug, <_unload_enter_y> = #<_unload_enter_y>)
        (debug, <_unload_gripper_down_z_reference> = #<_unload_gripper_down_z_reference>)
        (debug, <_unload_enter_x> = #<_unload_enter_x>)
        (debug, <_unload_aproximates_x> = #<_unload_aproximates_x>)
        (debug, <_unload_enter_intermediate_x> = #<_unload_enter_intermediate_x>)
        (debug, <_unload_enter_intermediate_Z> = #<_unload_enter_intermediate_Z>)
        (debug, <_unload_gripper_down_x_calculated> = #<_unload_gripper_down_x_calculated>)
        (debug, <_unload_gripper_down_z_calculated> = #<_unload_gripper_down_z_calculated>)

        (debug, <_tumbler_gripper_down_jaws_center_x> = #<_tumbler_gripper_down_jaws_center_x>)
        (debug, <_tumbler_enter_down_y> = #<_tumbler_enter_down_y>)
        (debug, <_tumbler_gripper_down_z> = #<_tumbler_gripper_down_z>)
        (debug, <_tumbler_gripper_up_jaws_center_x> = #<_tumbler_gripper_up_jaws_center_x>)
        (debug, <_tumbler_enter_up_y> = #<_tumbler_enter_up_y>)
        (debug, <_tumbler_gripper_up_z> = #<_tumbler_gripper_up_z>)
        (debug, <_tumbler_enter_x> = #<_tumbler_enter_x>)
        (debug, <_tumbler_gripper_down_unload_x_calculated> = #<_tumbler_gripper_down_unload_x_calculated>)
        (debug, <_tumbler_gripper_down_load_x_calculated> = #<_tumbler_gripper_down_load_x_calculated>)
        (debug, <_tumbler_gripper_down_extracts> = #<_tumbler_gripper_down_extracts>)
        (debug, <_tumbler_aproximates_down_x> = #<_tumbler_aproximates_down_x>)
        (debug, <_tumbler_aproximates_up_x> = #<_tumbler_aproximates_up_x>)
        (debug, <_tumbler_gripper_down_load_from_extract> = #<_tumbler_gripper_down_load_from_extract>)
        (debug, <_tumbler_gripper_up_load_from_extract> = #<_tumbler_gripper_up_load_from_extract>)
        (debug, <_tumbler_gripper_down_x_meas_ref> = #<_tumbler_gripper_down_x_meas_ref>)
        (debug, <_tumbler_gripper_up_x_meas_ref> = #<_tumbler_gripper_up_x_meas_ref>)

        (debug, <_lathe_chuck_front_to_gripper_down_x>  =  #<_lathe_chuck_front_to_gripper_down_x>)
        (debug, <_lathe_gripper_down_center_y>  =  #<_lathe_gripper_down_center_y>)
        (debug, <_lathe_gripper_down_center_z>  =  #<_lathe_gripper_down_center_z>)
        (debug, <_lathe_chuck_front_to_gripper_up_x>  =  #<_lathe_chuck_front_to_gripper_up_x>)
        (debug, <_lathe_gripper_up_center_y>  =  #<_lathe_gripper_up_center_y>)
        (debug, <_lathe_gripper_up_center_z>  =  #<_lathe_gripper_up_center_z>)
        (debug, <_lathe_enter1_x> = #<_lathe_enter1_x>)
        (debug, <_lathe_enter1_y> = #<_lathe_enter1_y>)
        (debug, <_lathe_enter1_z> = #<_lathe_enter1_z>)
        (debug, <_lathe_enter2_y> = #<_lathe_enter2_y>)
        (debug, <_lathe_enter2_z> = #<_lathe_enter2_z>)
        (debug, <_lathe_enter3_z> = #<_lathe_enter3_z>)
        (debug, <_lathe_gripper_down_aproximates_x> = #<_lathe_gripper_down_aproximates_x>)
        (debug, <_lathe_gripper_up_aproximates_x> = #<_lathe_gripper_up_aproximates_x>)
        (debug, <_lathe_gripper_down_x_calculated> = #<_lathe_gripper_down_x_calculated>)
        (debug, <_lathe_gripper_up_x_calculated> = #<_lathe_gripper_up_x_calculated>)
        (debug, <_lathe_gripper_down_x_meas_ref> = #<_lathe_gripper_down_x_meas_ref>)

        M02
    o180 ENDSUB

    ;UNLOAD PARKING
    o220 SUB
        o1050 CALL ; PARKING gripper down GRAB
        o1350 CALL ; UNLOAD gripper down
        (debug, 30 seconds to end)
        G4 P30
        M02
    o220 ENDSUB

    ;UNLOAD BLOWER
    o250 SUB
        o1250 CALL ; BLOWER GRIPPER DOWN GRAB
        o1350 CALL ; UNLOAD gripper down
        (debug, 30 seconds to end)
        G4 P30
        M02
    o250 ENDSUB

    ;UNLOAD LATHE
    o270 SUB
        o3400 CALL ; LATHE ENDS
        o1350 CALL ; UNLOAD gripper down
        (debug, 30 seconds to end)
        G4 P30
        M02
    o270 ENDSUB

    ;UNLOAD TUMBLER BEFORE TURNING
    o300 SUB
        o3500 CALL ; TUMBLER gripper down grabs BEFORE TURNING
        o1350 CALL ; UNLOAD gripper down
        (debug, 30 seconds to end)
        G4 P30
        M02
    o300 ENDSUB

    ;UNLOAD TUMBLER AFTER TURNED
    o310 SUB
        o3550 CALL ; TUMBLER gripper down grabs AFTER TURNED
        o1350 CALL ; UNLOAD gripper down
        (debug, 30 seconds to end)
        G4 P30
        M02
    o310 ENDSUB

    ;UNLOAD GRIPPER UP
    o320 SUB
        o1100 CALL ; PARKING gripper up LEAVE 
        o1050 CALL ; PARKING gripper down GRAB
        o1350 CALL ; UNLOAD gripper down
        (debug, 30 seconds to end)
        G4 P30
        M02
    o320 ENDSUB

    ;UNLOAD GRIPPER DOWN
    o350 SUB
        o1350 CALL ; UNLOAD gripper down
        (debug, 30 seconds to end)
        G4 P30
        M02
    o350 ENDSUB

    ;SERVICE POS
    o370 SUB

        ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o2105 IF [#5399 EQ -1]
            (debug, SERVICE POS - Gantry not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o2105 ENDIF

        G1 y#<_y_service_position>	        F#<_VEL_FAST>
        G1 x#<_x_service_position>	        F#<_VEL_FAST>
        G1 z#<_z_service_position>	        F#<_VEL_FAST>

        M02
    o370 ENDSUB

;END














;(**********************************************************************)
;(***** I/Os INITIALIZATION AND CHECKING                           *****)
;(**********************************************************************)

;INITIALIZATION SUBS

    o800 SUB ;FLAGS TO SET AT PRODUCTION ALL STEPS
            
        ;Flag 01 - Gantry in Load Routine to 0
        M65 P63

        ;Flag 02 - Gantry in UnLoad Routine to 0
        M65 P62

        ;Flag 03 - start blower to 0
        M65 P60

        ;Flag do NOT start blower python routine to 0 
        M65 P61

        ;Flag to measure with gripper down to 0
        M65 P59 

        ;Flag to measure with gripper up to 0
        M65 P58

        ;SET signal CYCLE START to 0
        M65 P50

        ;SET signal request answer to 0 (MFIN=0)
        M65 P52
    
        ;SET signal chuck clamp to 0
        M65 P43

        ;SET signal chuck unclamp to 0
        M65 P44

        ;SET signal spindle orientation 1 to 0
        M65 P46

        ;SET signal spindle orientation 2 to 0
        M65 P47

        ;CTRL_ch_of - okuma #operation finished - set 0
        M65 P53

        ;MOON ROOF signals to 0
        M65 P13
        M65 P14

        G4 P1
    o800 ENDSUB


    o801 SUB ;FLAGS TO REVIEW AT PRODUCTION ALL STEPS

        ;SAFE POSITION
            #5399 = 0
            o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
            o100 IF [#5399 EQ -1]
                (debug, INIT - Gantry not in Safe Position Y/Z coordinates)
                ;(log, )
                M02
            o100 ENDIF

        ;LOAD - Check sensor of vertical pneumatic up
            ;no tiene sentido porque puede estar abajo cargando
            ;M66 P06 L3 Q0.1
            ;o101 IF [#5399 EQ -1]
            ;    (debug, INIT - LOAD gripper down - Vertical Pneumatic is not up)
            ;    ;(log, )
            ;    M02
            ;o101 ENDIF

        ;LOAD - Check sensor of dumping pneumatic in load or idle position
            M66 P08 L3 Q0.1
            o102 IF [#5399 EQ -1]
                (debug, INIT - LOAD gripper down - Dumping pneumatic NOT in load or idle position)
                ;(log, )
                M02
            o102 ENDIF

        ;UNLOAD - Check sensor of vertical pneumatic up
            M66 P05 L3 Q0.1
            o103 IF [#5399 EQ -1]
                (debug, INIT - UNLOAD gripper down - Vertical Pneumatic is not up)
                ;(log, )
                M02
            o103 ENDIF

        ;UNLOAD -  Sensor of Coupling present in vertical - MUST BE NOT PRESENT
            M66 P15 L3 Q0.1 ; n/c
            o104 IF [#5399 EQ -1]
                (debug, INIT - UNLOAD gripper down - Coupling present in vertical)
                ;(log, )
                M02
            o104 ENDIF

        ;UNLOAD - Sensor of Unload Conveyor Complete - MUST BE NOT COMPLETE
            M66 P01 L3 Q0.1 
            o105 IF [#5399 EQ -1]
                (debug, INIT - Unload Conveyor is full)
                ;(log, )
                M02
            o105 ENDIF

        ;BLOWER - Open door sensor
            M66 P17 L3 Q0.1		
            o106 IF [#5399 EQ -1]
                (debug, INIT - BLOWER GRIPPER DOWN LEAVE - Door not opened)
                ;(log, )
                M02
            o106 ENDIF

        ;BLOWER - Blower air valve closed
            M66 P28 L4 Q0.1
            o107 IF [#5399 EQ -1]
                (debug, INIT - BLOWER GRIPPER DOWN LEAVE - Blower air valve opened)
                ;(log, )
                M02
            o107 ENDIF

        ;BLOWER - Coupling Presence Sensor - coupling must not be present
            M66 P16 L4 Q0.1
            o108 IF [#5399 EQ -1]
                (debug, INIT - BLOWER GRIPPER DOWN LEAVE - Coupling Present error)
                ;(log, )
                M02
            o108 ENDIF

        ;PARKING - Coupling Presence Sensor - coupling must not be present
            M66 P14 L3 Q0.1
            o109 IF [#5399 EQ -1]
                (debug, INIT - Parking - Present Coupling error)
                ;(log, )
                M02
            o109 ENDIF
        
        ;TUMBLER - Open Jaws Sensor
            M66 P13 L3 Q0.1
            o110 IF [#5399 EQ -1]
                (debug, INIT - Tumbler - Jaws are closed)
                ;(log, )
                M02
            o110 ENDIF

        ;TUMBLER - VERIFY SENSOR ROTATOR IN 0 DEGREES 
            M66 P10 L3 Q0.1
            o111 IF [#5399 EQ -1]
                (debug, INIT - Tumbler - Tumbler rotator not in 0 degrees)
                ;(log, )
                M02
            o111 ENDIF
        
        ;LATHE - Signal lathe in alarm - no_alarm=1 (n/c)
            M66 P46 L3 Q0.1	
            o118 IF [#5399 EQ -1]
                (debug, INIT LATHE - Okuma has an alarm)
                ;(log, )
                M02
            o118 ENDIF

        ;LATHE - CYCLE COMPLETE EN 1
            M66 P47 L3 Q0.1
            o119 IF [#5399 EQ -1]
                (debug, INIT LATHE -Error - Okuma has no Cyle Complete)
                ;(log, )
                M02
            o119 ENDIF

        ;LATHE - CYCLE STOP REQUEST EN 1
            M66 P50 L3 Q0.1
            o121 IF [#5399 EQ -1]
                (debug, INIT LATHE - Error - Okuma cycle stop activated)
                ;(log, )
                M02
            o121 ENDIF

        ;LATHE - REQUEST 1 (M180) = 0
            M66 P51 L4 Q0.1
            o122 IF [#5399 EQ -1]
                (debug, INIT LATHE - Okuma signal m180 is on)
                ;(log, )
                M02
            o122 ENDIF

        ;LATHE - REQUEST 2 (M181) = 0
            M66 P52 L4 Q0.1
            o123 IF [#5399 EQ -1]
                (debug, INIT LATHE - Okuma signal m180 is on)
                ;(log, )
                M02
            o123 ENDIF

        ;MASTER - VERIFY ROUTINE RUNNING
            M66 P62 L3 Q0.1
            o127 IF [#5399 EQ -1]
                (debug, INIT PYTHON ROUTINE not running)
                ;(log, )
                M02
            o127 ENDIF

        ;LAST CYCLE - signal is 0
            M66 P49 L4 Q1	
            o128 IF [#5399 EQ -1]
                (debug, INIT PYTHON - LAST CYCLE signal is 1)
                ;(log, )
                M02
            o128 ENDIF

        ;OPEN MOON ROOF
            M64 P13
            M65 P14

        ;VERIFY MOON ROOF OPEN SENSOR
            M66 P20 L3 Q10
            o129 IF [#5399 EQ -1]
                (debug, INIT - Moon Roof Open Sensor not present)
                ;(log, )
                M02
            o129 ENDIF
        
        ;MOON ROOF signals to 0
        M65 P13
        M65 P14

        (debug, INIT - WAIT UNTILL HOME POSITION)

        ;VERIFY Signal Machine Home position ON
            M66 P48 L3 Q5

            o131 while [#5399 EQ -1]
                ;Machine Home position ON
                M100 P48
                M66 P48 L3 Q1
            o131 endwhile
        
    o801 ENDSUB


    o802 SUB ;FLAGS TO REVIEW AT PRODUCTION STEP 0 (GRD empty - GRU empty - Chuck Open)

        ;gripper_down - Open Jaws Sensor
            M66 P25 L3 Q0.1		(Checks Open Jaws Sensor)
            o112 IF [#5399 EQ -1]
                (debug, INIT - ERROR: gripper down Open Jaws error)
                ;(log, )
                M02
            o112 ENDIF
            
        ;gripper_down - Coupling Presence Sensor - must be NOT present
            M66 P21 L3 Q0.1
            o113 IF [#5399 EQ -1]
                (debug, INIT - Gripper Down - Present Coupling error in Gripper Down)
                ;(log, )
                M02
            o113 ENDIF

        ;gripper_up - Open Jaws Sensor
            M66 P26 L3 Q0.1		(Checks Open Jaws Sensor)
            o114 IF [#5399 EQ -1]
                (debug, INIT - ERROR: gripper up Open Jaws error)
                ;(log, )
                M02
            o114 ENDIF

        ;gripper_up - Coupling Presence Sensor - must be NOT present
            M66 P22 L3 Q0.1
            o115 IF [#5399 EQ -1]
                (debug, INIT - Gripper Up - Present Coupling error in Gripper UP)
                ;(log, )
                M02
            o115 ENDIF
        
        ;LATHE - chuck open confirmation signal
            M66 P43 L3 Q0.1
            o124 IF [#5399 EQ -1]
                (debug, INIT LATHE - Okuma chuck with no open confirmation signal)
                ;(log, )
                M02
            o124 ENDIF
            
    o802 ENDSUB

    o803 SUB ;FLAGS TO REVIEW AT PRODUCTION STEP 1 (GRD raw - GRU empty - Chuck Open)

        ;gripper_down - Coupling Presence Sensor - must be present
            M66 P21 L4 Q0.1
            o150 IF [#5399 EQ -1]
                (debug, INIT - Gripper Down - Coupling not present in gripper down)
                ;(log, )
                M02
            o150 ENDIF

        ;gripper_up - Open Jaws Sensor
            M66 P26 L3 Q0.1		(Checks Open Jaws Sensor)
            o152 IF [#5399 EQ -1]
                (debug, INIT - ERROR: gripper up Open Jaws error)
                ;(log, )
                M02
            o152 ENDIF

        ;gripper_up - Coupling Presence Sensor - must NOT be present
            M66 P22 L3 Q0.1
            o153 IF [#5399 EQ -1]
                (debug, INIT - Gripper Up - Present Coupling error in Gripper UP)
                ;(log, )
                M02
            o153 ENDIF
        
        ;LATHE - chuck open confirmation signal
            M66 P43 L3 Q0.1
            o154 IF [#5399 EQ -1]
                (debug, INIT LATHE - Okuma chuck with no open confirmation signal)
                ;(log, )
                M02
            o154 ENDIF
            
    o803 ENDSUB

    o804 SUB ;FLAGS TO REVIEW AT PRODUCTION STEP 2 (GRD empty - GRU empty - Chuck Closed)

        ;gripper_down - Open Jaws Sensor
            M66 P25 L3 Q0.1		(Checks Open Jaws Sensor)
            o130 IF [#5399 EQ -1]
                (debug, INIT - ERROR: gripper down Open Jaws error)
                ;(log, )
                M02
            o130 ENDIF
            
        ;gripper_down - Coupling Presence Sensor - must be NOT present
            M66 P21 L3 Q0.1
            o132 IF [#5399 EQ -1]
                (debug, INIT - Gripper Down - Present Coupling error in Gripper Down)
                ;(log, )
                M02
            o132 ENDIF

        ;gripper_up - Open Jaws Sensor
            M66 P26 L3 Q0.1		(Checks Open Jaws Sensor)
            o134 IF [#5399 EQ -1]
                (debug, INIT - ERROR: gripper up Open Jaws error)
                ;(log, )
                M02
            o134 ENDIF

        ;gripper_up - Coupling Presence Sensor - must be NOT present
            M66 P22 L3 Q0.1
            o136 IF [#5399 EQ -1]
                (debug, INIT - Gripper Up - Present Coupling error in Gripper UP)
                ;(log, )
                M02
            o136 ENDIF
        
        ;Close Chuck Confirmation
            M66 P42 L3 Q10	
            o138 IF [#5399 EQ -1]
                (debug, INIT - NO Close Chuck Confirmation)
                ;(log, )
                M02
            o138 ENDIF

    o804 ENDSUB

    o806 SUB ;FLAGS TO REVIEW AT PRODUCTION STEP 3 TO 6 (GRD empty - GRU with part - Chuck Closed)

        ;gripper_down - Open Jaws Sensor
            M66 P25 L3 Q0.1		(Checks Open Jaws Sensor)
            o140 IF [#5399 EQ -1]
                (debug, INIT - ERROR: gripper down Open Jaws error)
                ;(log, )
                M02
            o140 ENDIF
            
        ;gripper_down - Coupling Presence Sensor - must be NOT present
            M66 P21 L3 Q0.1
            o142 IF [#5399 EQ -1]
                (debug, INIT - Gripper Down - Present Coupling error in Gripper Down)
                ;(log, )
                M02
            o142 ENDIF

        
        ;gripper_up - Coupling Presence Sensor - must be present
            M66 P22 L4 Q0.1
            o144 IF [#5399 EQ -1]
                (debug, INIT - Gripper Up - NOT Present Coupling in Gripper UP)
                ;(log, )
                M02
            o144 ENDIF

        ;Close Chuck Confirmation
            M66 P42 L3 Q10	
            o146 IF [#5399 EQ -1]
                (debug, INIT - NO Close Chuck Confirmation)
                ;(log, )
                M02
            o146 ENDIF    

    o806 ENDSUB

;END













(**********************************************************************)
(***** ROUTINE PARKING - GRIPPER DOWN LEAVE - GRIPPER UP GRAB     *****)
(**********************************************************************)

o2100 SUB

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o2105 IF [#5399 EQ -1]
            (debug, PARKING - Gantry not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o2105 ENDIF

    ;VERIFY TUMBLER - Open Jaws Sensor
        M66 P13 L3 Q0.1
        o2106 IF [#5399 EQ -1]
            (debug, PARKING - Tumbler Jaws are closed)
            ;(log, )
            M02
        o2106 ENDIF

    ;VERIFY SENSOR TUMBLER ROTATOR IN 0 DEGREES 
    ;(POSITION WITH CLEAN FACE, NO HOOSES OR CABLES)
        M66 P10 L3 Q0.1
        o2107 IF [#5399 EQ -1]
            (debug, PARKING - Tumbler rotator not in 0 degrees)
            ;(log, )
            M02
        o2107 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o2108 IF [#5399 EQ -1]
            (debug, PARKING - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o2108 ENDIF

    ;VERIFY PARKING COUPLING PRESENCE SENSOR - the coupling must not be present
        M66 P14 L3 Q0.1
        o2110 IF [#5399 EQ -1]
            (debug, PARKING - Present Coupling Error - It must be empty)
            ;(log, )
            M02
        o2110 ENDIF

    ;VERIFY GRIPPER DOWN COUPLING PRESENCE SENSOR - MUST BE PRESENT
        M66 P21 L4 Q0.1
        o2115 IF [#5399 EQ -1]
            (debug, PARKING - ERROR Coupling not present in gripper down)
            ;(log, )
            M02
        o2115 ENDIF

    G1 z#<_parking_enter_z>	F#<_VEL_FAST>
    G1 x#<_parking_enter_x_over_bars>	F#<_VEL_FAST>
    G1 y#<_parking_gripper_down_enter_y>	F#<_VEL_FAST>
    
    G1 z[#<_parking_gripper_down_z_calculated>+#<_parking_z_offset>] F#<_VEL_FAST>
    
    G1 x#<_parking_aproximates_x>	F#<_VEL_MEDIUM>
    
    G1 x#<_parking_gripper_down_unload_x_calculated>	F#<_VEL_SLOW>

    ;VERIFY PARKING COUPLING PRESENCE SENSOR - coupling must be present in parking
        M66 P14 L4 Q0.1
        o2120 IF [#5399 EQ -1]
            (debug, PARKING - Coupling not present in parking)
            ;(log, )
            M02
        o2120 ENDIF

    ;SUBROUTINE open gripper down
        o1700 CALL ;open gripper down
            o2125 IF [#5399 EQ -1]
                (debug, PARKING - ERROR IN ROUTINE GRIPPER DOWN OPEN)
                ;(log, )
                M02
            o2125 ENDIF  

    G1 x#<_parking_enter_x_free>	F#<_VEL_FAST>

    ;VERIFY PARKING COUPLING PRESENCE SENSOR - coupling must be present in parking
        M66 P14 L4 Q0.1
        o2130 IF [#5399 EQ -1]
            (debug, PARKING - Coupling not present in parking)
            ;(log, )
            M02
        o2130 ENDIF

    ;VERIFY GRIPPER DOWN COUPLING PRESENCE SENSOR - coupling must NOT be present
        M66 P21 L3 Q0.1
        o2135 IF [#5399 EQ -1]
            (debug, PARKING - ERROR - Coupling present in gripper down)
            ;(log, )
            M02
        o2135 ENDIF

    ;VERIFY GRIPPER UP COUPLING PRESENCE SENSOR - must NOT be present
        M66 P22 L3 Q0.1
        o2140 IF [#5399 EQ -1]
            (debug, PARKING - ERROR - Coupling present in gripper UP)
            ;(log, )
            M02
        o2140 ENDIF

        ;OPEN GRIPPER UP, ALSO CHECKS SENSOR FOR JAWS OPENED
        o1750 CALL ;OPEN GRIPPER UP
            o2145 IF [#5399 EQ -1]
                (debug, PARKING - ERROR - OPEN GRIPPER UP ROUTINE)
                ;(log, )
                M02
            o2145 ENDIF

    G1 y#<_parking_gripper_up_enter_y>	F#<_VEL_FAST>
    
    G1 z#<_parking_gripper_up_z_calculated>	F#<_VEL_FAST>
    
    G1 x#<_parking_enter_x_over_bars>	F#<_VEL_FAST>

    G1 x#<_parking_aproximates_x>	F#<_VEL_MEDIUM>
    
    G1 x[#<_parking_gripper_up_load_x_calculated>+#<_parking_offset_x_measuring>]	F#<_VEL_SLOW>
    
    ;GRIPPER UP MEASURING ROUTINE
        o1650 CALL ;measuring routine gripper up
            o2150 IF [#5399 EQ -1]
                (debug, PARKING - ERROR IN MEASURING GRIPPER UP ROUTINE)
                ;(log, )
                M02
            o2150 ENDIF
            #<_parking_gripper_up_x_error> = [#<_parking_gripper_up_x_meas_ref>-#<_gripper_up_value_measure>]
            (debug, PARKING GRIPPER UP - MEASURE DIF VS REF = #<_parking_gripper_up_x_error> )
            ;(log, )
            o2155 IF [ABS[#<_parking_gripper_up_x_error>] GT #<_parking_gripper_up_x_error_accepted>]
                (debug, PARKING gripper up - measurement length exceeded)
                ;(log, )
                ;M02
            o2155 ENDIF

    ;SUBROUTINE CLOSE GRIPPER UP WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1950 CALL ;cerrar pieza gripper up
            o2160 IF [#5399 EQ -1]
                (debug, PARKING - ERROR IN CLOSING GRIPPER UP WITH COUPLING)
                ;(log, )
                M02
            o2160 ENDIF

    ;describes diagonal movement in X & Z
    G1 x#<_parking_enter_x_over_bars> z[#<_parking_gripper_up_z_calculated>+#<_parking_z_offset>]	F#<_VEL_FAST>
    
    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>
    
    ;VERIFY PARKING COUPLING PRESENCE SENSOR - coupling must not be present
        M66 P14 L3 Q0.1
        o2165 IF [#5399 EQ -1]
            (debug, Parking - Present coupling in Parking)
            ;(log, )
            M02
        o2165 ENDIF

    ;VERIFY GRIPPER UP COUPLING PRESENCE SENSOR - coupling must be present
        M66 P22 L4 Q0.1
        o2170 IF [#5399 EQ -1]
            (debug, Parking - Coupling not present in Gripper Up)
            ;(log, )
            M02
        o2170 ENDIF

o2100 ENDSUB



(**********************************************************************)
(***** ROUTINE PARKING gripper down GRAB                          *****)
(***** MIDE                                                       *****)
(**********************************************************************)

o1050 SUB
    
    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1051 IF [#5399 EQ -1]
            (debug, Parking Grab GRD -  Gantry not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o1051 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1052 IF [#5399 EQ -1]
            (debug, Parking Grab GRD - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1052 ENDIF

    ;VERIFY PARKING COUPLING PRESENCE SENSOR - the coupling must be present
        M66 P14 L4 Q0.1
        o1055 IF [#5399 EQ -1]
            (debug, Parking Grab GRD - Present Coupling Error - must be present)
            ;(log, )
            M02
        o1055 ENDIF

    ;VERIFY TUMBLER - Open Jaws Sensor
        M66 P13 L3 Q0.1
        o1056 IF [#5399 EQ -1]
            (debug, Parking Grab GRD - Tumbler Jaws are closed)
            ;(log, )
            M02
        o1056 ENDIF

    ;VERIFY SENSOR TUMBLER ROTATOR IN 0 DEGREES 
    ;(POSITION WITH CLEAN FACE, NO HOOSES OR CABLES)
        M66 P10 L3 Q0.1
        o1057 IF [#5399 EQ -1]
            (debug, Parking Grab GRD - Tumbler rotator not in 0 degrees)
            ;(log, )
            M02
        o1057 ENDIF

    ;VERIFY GRIPPER DOWN COUPLING PRESENCE SENSOR - MUST NOT BE PRESENT
        M66 P21 L3 Q0.1
        o1060 IF [#5399 EQ -1]
            (debug, Parking Grab GRD - ERROR Coupling present in gripper down)
            ;(log, )
            M02
        o1060 ENDIF

    ;SUBROUTINE open gripper down
        o1700 CALL ;open gripper down
            o1065 IF [#5399 EQ -1]
                (debug, Parking Grab GRD - ERROR IN ROUTINE GRIPPER DOWN OPEN)
                ;(log, )
                M02
            o1065 ENDIF

    G1 x#<_parking_enter_x_free>	F#<_VEL_FAST>

    G1 z#<_parking_enter_z>	F#<_VEL_FAST>
    G1 y#<_parking_gripper_down_enter_y>	F#<_VEL_FAST>
    
    G1 z#<_parking_gripper_down_z_calculated>	F#<_VEL_FAST>
    
    G1 x#<_parking_aproximates_x>	F#<_VEL_MEDIUM>
    
    G1 x[#<_parking_gripper_down_load_x_calculated>+#<_parking_offset_x_measuring>]	F#<_VEL_SLOW>

    ;SUBROUTINE MEASURING GRIPPER DOWN
        o1600 CALL ;measuring routine gripper down
            o1070 IF [#5399 EQ -1]
                (debug, Parking Grab GRD - ERROR IN MEASURING ROUTINE)
                ;(log, )
                M02
            o1070 ENDIF
            #<_parking_gripper_down_x_error> = [#<_parking_gripper_down_x_meas_ref>-#<_gripper_down_value_measure>]
            (debug,  Parking Grab GRD - MEASURE DIF VS REF = #<_parking_gripper_down_x_error> )
            ;(log, )
            o1071 IF [ABS[#<_parking_gripper_down_x_error>] GT #<_parking_gripper_down_x_error_accepted>]
                (debug,  Parking Grab GRD - measurement length exceeded)
                ;(log, )
                ;M02
            o1071 ENDIF
    
    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o1075 IF [#5399 EQ -1]
                (debug,  Parking Grab GRD - close gripper with coupling error)
                ;(log, )
                M02
            o1075 ENDIF
    
    ;describes diagonal movement in X & Z
    G1 x#<_parking_enter_x_free> z[#<_parking_gripper_down_z_calculated>+#<_parking_z_offset>]	F#<_VEL_FAST>
    
    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;Parking Coupling Presence Sensor - coupling must not be present
        M66 P14 L3 Q0.1
        o1080 IF [#5399 EQ -1]
            (debug, Parking Grab GRD - Present coupling in parking)
            ;(log, )
            M02
        o1080 ENDIF
        
    ;VERIFY GRIPPER DOWN COUPLING PRESENCE SENSOR - coupling must be present
        M66 P21 L4 Q0.1
        o1085 IF [#5399 EQ -1]
            (debug, Parking Grab GRD - Coupling not present in Gripper down)
            ;(log, )
            M02
        o1085 ENDIF
    
o1050 ENDSUB



(**********************************************************************)
(***** ROUTINE PARKING gripper up LEAVE                           *****)
(**********************************************************************)

o1100 SUB
    
    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1105 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU- Gantry not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o1105 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1106 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1106 ENDIF

    ;VERIFY PARKING COUPLING PRESENCE SENSOR - the coupling must not be present
        M66 P14 L3 Q0.1
        o1110 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU - Present Coupling Error - It must be empty)
            ;(log, )
            M02
        o1110 ENDIF

    ;VERIFY TUMBLER - Open Jaws Sensor
        M66 P13 L3 Q0.1
        o1111 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU - Tumbler Jaws are closed)
            ;(log, )
            M02
        o1111 ENDIF

    ;VERIFY SENSOR TUMBLER ROTATOR IN 0 DEGREES 
    ;(POSITION WITH CLEAN FACE, NO HOOSES OR CABLES)
        M66 P10 L3 Q0.1
        o1112 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU  - Tumbler rotator not in 0 degrees)
            ;(log, )
            M02
        o1112 ENDIF

    ;VERIFY GRIPPER UP COUPLING PRESENCE SENSOR - coupling must be present
        M66 P22 L4 Q0.1
        o1115 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU - Coupling not present in Gripper Up)
            ;(log, )
            M02
        o1115 ENDIF
    
    G1 z#<_parking_enter_z>	F#<_VEL_FAST>
    G1 x#<_parking_enter_x_over_bars>	F#<_VEL_FAST>
    G1 y#<_parking_gripper_up_enter_y>	F#<_VEL_FAST>
    
    G1 z[#<_parking_gripper_up_z_calculated>+#<_parking_z_offset>]	F#<_VEL_FAST>
    
    G1 x#<_parking_aproximates_x>	F#<_VEL_MEDIUM>
    
    G1 x#<_parking_gripper_up_unload_x_calculated>	F#<_VEL_SLOW>
    
    ;VERIFY PARKING COUPLING PRESENCE SENSOR - the coupling must be present
        M66 P14 L4 Q0.1
        o1120 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU - Present Coupling Error - the coupling must be present)
            ;(log, )
            M02
        o1120 ENDIF
    
    ;OPEN GRIPPER UP, ALSO CHECKS SENSOR FOR JAWS OPENED
        o1750 CALL ;OPEN GRIPPER UP
            o1125 IF [#5399 EQ -1]
                (debug, PARKING Leave GRU - ERROR - OPEN GRIPPER UP ROUTINE)
                ;(log, )
                M02
            o1125 ENDIF
    
    G1 x#<_parking_enter_x_free>	F#<_VEL_FAST>
    
    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;VERIFY PARKING COUPLING PRESENCE SENSOR - the coupling must be present
        M66 P14 L4 Q0.1
        o1130 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU - Present Coupling Error - the coupling must be present)
            ;(log, )
            M02
        o1130 ENDIF

    ;VERIFY GRIPPER UP COUPLING PRESENCE SENSOR - must NOT be present
        M66 P22 L3 Q0.1
        o1135 IF [#5399 EQ -1]
            (debug, PARKING Leave GRU - ERROR - Coupling present in gripper UP)
            ;(log, )
            M02
        o1135 ENDIF
    
    
o1100 ENDSUB










(**********************************************************************)
(***** ROUTINE BLOWER GRIPPER DOWN LEAVE                          *****)
(**********************************************************************)

o1200 SUB

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1201 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o1201 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1202 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1202 ENDIF

    ;VERIFY Flag Blower Cloncluded in 0
        M66 P27 L4 Q10		(thctab.CTRL_blw_er | end routine python)
        o1205 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Flag Blower Conluded should be 0)
            ;(log, )
            M02
        o1205 ENDIF
    
    ;VERIFY Blower open door sensor
        M66 P17 L3 Q0.1
        o1210 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Door not opened)
            ;(log, )
            M02
        o1210 ENDIF

    ;VERIFY Blower present coupling sensor - coupling must not be present
        M66 P16 L4 Q0.1
        o1215 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Coupling present in Blower)
            ;(log, )
            M02
        o1215 ENDIF

    ;VERIFY Blower Air Valve Closed
        M66 P28 L4 Q0.1
        o1220 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Blower air valve opened)
            ;(log, )
            M02
        o1220 ENDIF

    ;VERIFY GRIPPER DOWN present coupling sensor - coupling must be present
        M66 P21 L4 Q0.1
        o1225 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Coupling NOT present in Gripper Down)
            ;(log, )
            M02
        o1225 ENDIF

    ;SUBROUTINE CLOSE GRIPPER UP
        o1850 CALL
            o1226 IF [#5399 EQ -1]
                (debug, BLOWER GRIPPER DOWN LEAVE - ERROR IN ROUTINE CLOSE GRIPPER UP)
                ;(log, )
                M02
            o1226 ENDIF

    ;Flag 03 - start blower to 0
        M65 P60

    ;Flag do NOT start blower python routine to 1
        M64 P61
    

    G1 x#<_blower_enter_x>	F#<_VEL_FAST>
    G1 y#<_blower_enter_y>	F#<_VEL_FAST>

    G1 z[#<_blower_gripper_down_z_calculated_machined>+#<_blower_z_offset>]	F#<_VEL_FAST>

    G1 x#<_blower_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x#<_blower_gripper_down_unload_x_calculated>	F#<_VEL_SLOW>

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o1231 IF [#5399 EQ -1]
                (debug, BLOWER GRIPPER DOWN LEAVE - ERROR ROUTINE OPEN GRIPPER DOWN)
                ;(log, )
                M02
            o1231 ENDIF

    ;VERIFY Blower present coupling sensor - coupling must not be present
        M66 P16 L3 Q0.1
        o1230 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Coupling NOT present in Blower)
            ;(log, )
            M02
        o1230 ENDIF

    G1 x#<_blower_enter_x>	F#<_VEL_FAST>

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;VERIFY Blower present coupling sensor - coupling must be present
        M66 P16 L3 Q0.1
        o1235 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Coupling NOT Present)
            ;(log, )
            M02
        o1235 ENDIF

    ;VERIFY GRIPPER DOWN present coupling sensor - coupling must NOT be present
        M66 P21 L3 Q0.1
        o1240 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN LEAVE - Present Coupling in Gripper Down)
            ;(log, )
            M02
        o1240 ENDIF

    ;Flag 03 - start blower to 1
        M64 P60

    ;Flag do NOT start blower python routine to 0
        M65 P61

o1200 ENDSUB


(**********************************************************************)
(***** ROUTINE BLOWER GRIPPER DOWN GRAB                           *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o1250 SUB

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1251 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - Not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o1251 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1252 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1252 ENDIF

    ;;VERIFY Flag Blower Cloncluded in 1
        M66 P27 L3 Q40
        o1270 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - Blower not conluded)
            ;(log, )
            M02
        o1270 ENDIF

    ;VERIFY Blower present coupling sensor - coupling must be present
        M66 P16 L3 Q0.1
        o1255 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB  - Coupling is not present)
            ;(log, )
            M02
        o1255 ENDIF

    ;VERIFY Blower open door sensor
        M66 P17 L3 Q0.1		(thctab.CTRL_blw_er | end routine python)
        o1260 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - Door not opened)
            ;(log, )
            M02
        o1260 ENDIF

    ;VERIFY Blower Air Valve Closed
        M66 P28 L4 Q0.1
        o1265 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - Blower air valve opened)
            ;(log, )
            M02
        o1265 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;OPEN gripper down
            o1266 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - ERROR EN ROUTINE OPEN GRIPPER DOWN)
            ;(log, )
            M02
            o1266 ENDIF

    ;VERIFY COUPLING NOT PRESENT IN GRIPPER UP - must NOT be present
        M66 P22 L3 Q0.1
        o1275 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - Error Present Coupling in Gripper Up)
            ;(log, )
            M02
        o1275 ENDIF

    ;SUBROUTINE CLOSE GRIPPER UP
        o1850 CALL ;close gripper up
            o1276 IF [#5399 EQ -1]
                (debug, BLOWER GRIPPER DOWN GRAB - ERROR IN ROUTINE CLOSE GRIPPER UP)
                ;(log, )
                M02
            o1276 ENDIF

    G1 x#<_blower_enter_x>	F#<_VEL_FAST>

    ;Flag do NOT start blower python routine to 1
        M64 P61

    G1 y#<_blower_enter_y>	F#<_VEL_FAST>

    G1 z#<_blower_gripper_down_z_calculated_machined>	F#<_VEL_FAST>

    G1 x#<_blower_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x[#<_blower_gripper_down_load_x_calculated>+#<_blower_offset_x_measuring>]	F#<_VEL_SLOW>

    ;SUBROUTINE MEASURING GRIPPER DOWN
        o1600 CALL ;measuring routine gripper down
            o1277 IF [#5399 EQ -1]
                (debug, BLOWER GRIPPER DOWN GRAB - ERROR IN MEASURING ROUTINE)
                ;(log, )
                M02
            o1277 ENDIF
            #<_blower_gripper_down_x_error> = [#<_blower_gripper_down_x_meas_ref_machined>-#<_gripper_down_value_measure>]
            (debug, BLOWER GRIPPER DOWN GRAB - MEASURE DIF VS REF = #<_blower_gripper_down_x_error> )
            ;(log, )
            o1278 IF [ABS[#<_blower_gripper_down_x_error>] GT #<_blower_gripper_down_x_error_accepted>]
                (debug, BLOWER GRIPPER DOWN GRAB - measurement length exceeded)
                ;(log, )
                ;M02
            o1278 ENDIF

    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o1279 IF [#5399 EQ -1]
                (debug, BLOWER GRIPPER DOWN GRAB - close gripper with coupling error)
                ;(log, )
                M02
            o1279 ENDIF

    G1 x#<_blower_enter_x> z[#<_blower_gripper_down_z_calculated_machined>+#<_blower_z_offset>] 	F#<_VEL_FAST>

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;VERIFY Blower present coupling sensor - coupling must not be present
        M66 P16 L4 Q0.1
        o1280 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - Error Coupling is Present)
            ;(log, )
            M02
        o1280 ENDIF

    ;VERIFY GRIPPER DOWN present coupling sensor - coupling must be present
        M66 P21 L4 Q0.1
        o1285 IF [#5399 EQ -1]
            (debug, BLOWER GRIPPER DOWN GRAB - NOT Present Coupling in Gripper Down)
            ;(log, )
            M02
        o1285 ENDIF

    ;Flag 03 - start blower to 0
        M65 P60

    ;Flag do NOT start blower python routine to 0
        M65 P61

    ;OPEN GRIPPER UP, ALSO CHECKS SENSOR FOR JAWS OPENED
        o1750 CALL ;OPEN GRIPPER UP
            o1286 IF [#5399 EQ -1]
                (debug, BLOWER GRIPPER DOWN GRAB - ERROR ROUTINE GRIPPER UP OPEN)
                ;(log, )
                M02
            o1286 ENDIF
    ;With this last step, the Gantry stays freezed until reads the sensor of opened jaws...
 

o1250 ENDSUB










(**********************************************************************)
(***** ROUTINE LOAD gripper down                                  *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o1300 SUB

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1301 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Not in safe position, Y/Z coordinates)
            ;(log, )
            M02
        o1301 ENDIF

    ;VERIFY SENSOR FOR COUPLING PRESENT IN GRIPPER DOWN - gripper must be empty
        M66 P21 L3 Q0.1
        o1302 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Present Coupling in Gripper Down)
            ;(log, )
            M02
        o1302 ENDIF

    ;VERIFY TUMBLER - Open Jaws Sensor
        M66 P13 L3 Q0.1
        o1303 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Error in Routin to open Tumbler Jaws)
            ;(log, )
            M02
        o1303 ENDIF

    ;VERIFY SENSOR TUMBLER ROTATOR IN 0 DEGREES 
    ;(POSITION WITH CLEAN FACE, NO HOOSES OR CABLES)
        M66 P10 L3 Q0.1
        o1304 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Tumbler rotator not in 0 degrees)
            ;(log, )
            M02
        o1304 ENDIF

    ;VERIFY Parking - Coupling Presence Sensor - coupling must not be present
        M66 P14 L3 Q0.1
        o1305 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Parking - Present coupling)
            ;(log, )
            M02
        o1305 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1306 IF [#5399 EQ -1]
            (debug, LOAD gripper down - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1306 ENDIF

    ;LOAD - Check sensor of dumping pneumatic in load or idle position
    ;    M66 P08 L3 Q0.1
    ;    o1307 IF [#5399 EQ -1]
    ;        (debug, LOAD gripper down - Dumping pneumatic NOT in load or idle position)
    ;        ;(log, )
    ;        M02
    ;    o1307 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o1308 IF [#5399 EQ -1]
                (debug, LOAD gripper down - Gripper open routine error)
                ;(log, )
                M02
            o1308 ENDIF

    G1 x#<_load_enter_x>	F#<_VEL_FAST>
    G1 y#<_load_enter_y>	F#<_VEL_FAST>

    ;VERIFY LOAD PRESENT COUPLING SENSOR
        M66 P07 L3 Q1 ; n/o

        o3031 while [#5399 EQ -1]
            ;VERIFY LOAD PRESENT COUPLING SENSOR
            M100 P13001 ; *** WAIT UNTILL THERE IS COUPLING TO LOAD ***
            M66 P07 L3 Q1 ; n/o
        o3031 endwhile

    ;VERIFY LOAD VERTICAL PNEUMATIC IS UP 
        M66 P06 L3 Q1
        o1310 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Vertical Pneumatic is not up)
            ;(log, )
            M02
        o1310 ENDIF

    ;VERIFY LOAD PRESENT COUPLING SENSOR
    ;    M66 P07 L3 Q1 ; n/o
    ;    o1315 IF [#5399 EQ -1]
    ;        (debug, LOAD gripper down - Coupling not present in load pneumatic vertical)
    ;        ;(log, )
    ;        M02
    ;    o1315 ENDIF

    G1 z#<_load_gripper_down_z_calculated>	F#<_VEL_FAST>

    ;SET Flag 01 Gantry in Load Routine to 1
       M64 P63

    G1 x#<_load_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x[#<_load_gripper_down_x_calculated>+#<_load_offset_x_measuring>]   F#<_VEL_SLOW>

    G4 P1

    ;GRIPPER DOWN MEASURING ROUTINE
        o1600 CALL ;measuring routine gripper down
            o1316 IF [#5399 EQ -1]
                (debug, LOAD GRIPPER DOWN - ERROR IN MEASURING GRIPPER DOWN ROUTINE)
                ;(log, )
                M02
            o1316 ENDIF
            #<_load_gripper_down_x_error> = [#<_load_gripper_down_x_meas_ref>-#<_gripper_down_value_measure>]
            (debug, LOAD GRIPPER DOWN - MEASURE DIF VS REF = #<_load_gripper_down_x_error> )
            ;(log, )
            o1317 IF [ABS[#<_load_gripper_down_x_error>] GT #<_load_gripper_down_x_error_accepted>]
                (debug, LOAD GRIPPER DOWN - measurement length exceeded error)
                ;(log, )
                ;M02
            o1317 ENDIF            

    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o1318 IF [#5399 EQ -1]
                (debug, LOAD GRIPPER DOWN - ERROR IN CLOSING GRIPPER DOWN WITH COUPLING)
                ;(log, )
                M02
            o1318 ENDIF

    G1 z[#<_load_gripper_down_z_calculated>+#<_load_z_offset>] F#<_VEL_FAST>

    G1 x#<_load_enter_x>	F#<_VEL_FAST>

    ;VERIFY LOAD VERTICAL COUPLING PRESENCE SENSOR - coupling must not be present
        M66 P07 L4 Q0.1
        o1320 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Present coupling in Load Vertcal Pneumatic)
            ;(log, )
            M02
        o1320 ENDIF

    ;VERIFY GRIPPER DOWN COUPLING PRESENCE SENSOR - coupling must be present
        M66 P21 L4 Q0.1
        o1325 IF [#5399 EQ -1]
            (debug, LOAD gripper down - Coupling not present in Gripper down)
            ;(log, )
            M02
        o1325 ENDIF

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;SET Flag 01 Gantry in Load Routine to 0
        M65 P63

o1300 ENDSUB


(**********************************************************************)
(***** ROUTINE UNLOAD gripper down                                *****)
(**********************************************************************)

o1350 SUB

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1351 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o1351 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1352 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1352 ENDIF

    ;VERIFY SENSOR FOR COUPLING PRESENT IN GRIPPER DOWN - gripper must be with a coupling
        M66 P21 L4 Q0.1
        o1355 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - not Present Coupling in Gripper Down)
            ;(log, )
            M02
        o1355 ENDIF

    ;TUMBLER - Open Jaws Sensor
        M66 P13 L3 Q0.1
        o1356 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Error in Routin to open Tumbler Jaws)
            ;(log, )
            M02
        o1356 ENDIF

    ;VERIFY SENSOR TUMBLER ROTATOR IN 0 DEGREES 
    ;(POSITION WITH CLEAN FACE, NO HOOSES OR CABLES)
        M66 P10 L3 Q10
        o1357 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Tumbler rotator not in 0 degrees)
            ;(log, )
            M02
        o1357 ENDIF

    ;Parking - Coupling Presence Sensor - coupling must not be present
        M66 P14 L3 Q0.1
        o1358 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Present coupling in parking)
            ;(log, )
            M02
        o1358 ENDIF

    G1 x#<_unload_enter_x>	F#<_VEL_FAST>
    G1 y#<_unload_enter_y>	F#<_VEL_FAST>

    ;VERIFY - If unload Conveyor is full
        M66 P01 L3 Q1 ; n/o

        o3031 while [#5399 EQ -1]
            ;VERIFY - If unload Conveyor is full
            M100 P13501 ; *** WAIT UNTILL OPERATOR UNLOAD PARTS FROM CONVEYOR ***
            M66 P01 L3 Q1 ; n/o
        o3031 endwhile

    G1 z#<_unload_enter_intermediate_z>	F#<_VEL_FAST>
    G1 x#<_unload_enter_intermediate_x>	F#<_VEL_FAST>

    G1 z[#<_unload_gripper_down_z_calculated>+#<_unload_z_offset>]	F#<_VEL_FAST>

    ;VERIFY UNLOAD VERTICAL PNEUMATIC IS UP 
        M66 P05 L3 Q10 ; waits unload routine time
        o1360 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Vertical Pneumatic is not up)
            ;(log, )
            M02
        o1360 ENDIF  

    ;VERIFY UNLOAD PRESENT COUPLING SENSOR IN VERTICAL PNEUMATIC - has to be empty
        M66 P15 L3 Q1 ; n/c
        o1365 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Coupling present in vertical)
            ;(log, )
            M02
        o1365 ENDIF

    ;SET Flag 02 Gantry in UnLoad Routine to 1 
        M64 P62

    G1 x#<_unload_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x#<_unload_gripper_down_x_calculated>	F#<_VEL_SLOW>

    ;VERIFY UNLOAD PRESENT COUPLING SENSOR IN VERTICAL PNEUMATIC - has to be with coupling
        M66 P15 L4 Q0.1 ; n/c
        o1370 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Coupling not present in vertical)
            ;(log, )
            M02
        o1370 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL  ;open gripper down
            o1371 IF [#5399 EQ -1]
                (debug, UNLOAD gripper down - Gripper open routine error)
                ;(log, )
                M02
            o1371 ENDIF

    G1 x#<_unload_enter_x>	F#<_VEL_FAST>

    ;VERIFY UNLOAD PRESENT COUPLING SENSOR IN VERTICAL PNEUMATIC - has to be with coupling
        M66 P15 L4 Q0.1 ; n/c
        o1375 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Coupling not present in vertical)
            ;(log, )
            M02
        o1375 ENDIF

    ;VERIFY GRIPPER DOWN COUPLING PRESENCE SENSOR - coupling must NOT be present
        M66 P21 L3 Q0.1
        o1380 IF [#5399 EQ -1]
            (debug, UNLOAD gripper down - Coupling present in Gripper down)
            ;(log, )
            M02
        o1380 ENDIF

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;SET Flag 02 Gantry in UnLoad Routine to 0
        M65 P62

o1350 ENDSUB









(**********************************************************************)
(***** ROUTINE TUMBLER gripper start down - ends up               *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o1400 SUB ;ROUTINE TUMBLER gripper start down - ends up

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1401 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o1401 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1402 IF [#5399 EQ -1]
            (debug, Tumbler down/up - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1402 ENDIF

    ;TUMBLER - Open Jaws Sensor
        M66 P13 L3 Q0.1
        o1405 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Jaws are not opened)
            ;(log, )
            M02
        o1405 ENDIF
    
    ;VERIFY SENSOR ROTATOR IN 0 DEGREES
        M66 P10 L3 Q0.1
        o1410 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Rotator not in 0 degrees)
            ;(log, )
            M02
        o1410 ENDIF

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must have coupling
        M66 P21 L4 Q0.1
        o1415 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Gripper Down - Coupling not present)
            ;(log, )
            M02
        o1415 ENDIF

    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    G1 y#<_tumbler_enter_down_y>	F#<_VEL_FAST>

    G1 z#<_tumbler_gripper_down_z>	F#<_VEL_FAST>

    G1 x#<_tumbler_aproximates_down_x>	F#<_VEL_FAST>

    G1 x[#<_tumbler_gripper_down_unload_x_calculated>+#<_tumbler_x_displacement>]	F#<_VEL_MEDIUM>

    ;CLOSE TUMBLER JAWS
        M64 P04
        M65 P03
        
    ;VERIFY TUMBLER SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        G04 p3

        M66 P13 L4 Q0.1 (Check signal of Jaws not opened)
        o1420 IF [#5399 EQ -1]
            (debug, Tumbler down/up - ERROR IN CLOSING JAWS WITH COUPLING - opened)
            ;(log, )
            M02
        o1420 ENDIF

        M66 P12 L4 Q0.1 (Check signal of Jaws not closed)
        o1425 IF [#5399 EQ -1]
            (debug, Tumbler down/up - ERROR IN CLOSING JAWS WITH COUPLING - closed)
            ;(log, )
            M02
        o1425 ENDIF
   
    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o1431 IF [#5399 EQ -1]
                (debug, Tumbler down/up - Gripper Down open routine error)
                ;(log, )
                M02
            o1431 ENDIF

    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    ;ROTATE TUMBLER 180 DEGREES
        M64 P01
        M65 P02

    ;VERIFY SENSOR ROTATOR IN 180 DEGREES
        M66 P11 L3 Q10
        o1435 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Rotator not in 180 degrees)
            ;(log, )
            M02
        o1435 ENDIF

    G1 x#<_tumbler_aproximates_down_x>	F#<_VEL_FAST>

    G1 x#<_tumbler_gripper_down_load_x_calculated>	F#<_VEL_SLOW>
    ;it goes to grab the coupling at the dimension if it would be turned by the middle of the coupling length
    ;but it turned with an offset off _tumbler_x_displacement, so the coupling wont be at the end of the gripper compressing the springs

    ;SUBROUTINE CLOSE GRD WITH COUPLING, NO PRESSING SHEETMETAL, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
    o1925 CALL  ;close gripper down with coupling
        o1438 IF [#5399 EQ -1]
            (debug, Tumbler down/up - ERROR CLOSING GRD WITH COUPLING, NO PRESSING SHEETMETAL)
            ;(log, )
            M02
        o1438 ENDIF

    ;OPEN TUMBLER JAWS
        M64 P03
        M65 P04
    
    ;VERIFY TUMBLER SENSORS JAWS OPEN
        M66 P13 L3 Q5
        o1440 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Jaws are not opened)
            ;(log, )
            M02
        o1440 ENDIF

    ; ************ OFFSET FROM CENTER ************

    G1 x[#<_tumbler_gripper_down_extracts>+#<_tumbler_x_displacement>]	F#<_VEL_FAST>
    ;to extract the coupling enda face to the point _tumbler_gripper_down_extracts 
    ;has to move with the plus off the previous offset that it was left before: _tumbler_x_displacement

    ;CLOSE TUMBLER JAW
        M64 P04
        M65 P03
        
    ;VERIFY TUMBLER SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        G04 p3

        M66 P13 L4 Q0.1 (Check signal of Jaws not opened)
        o1450 IF [#5399 EQ -1]
            (debug, Tumbler down/up - ERROR IN CLOSING JAWS WITH COUPLING - opened)
            ;(log, )
            M02
        o1450 ENDIF

        M66 P12 L4 Q0.1 (Check signal of Jaws not closed)
        o1455 IF [#5399 EQ -1]
            (debug, Tumbler down/up - ERROR IN CLOSING JAWS WITH COUPLING - closed)
            ;(log, )
            M02
        o1455 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o1456 IF [#5399 EQ -1]
                (debug, Tumbler down/up - Gripper Down open routine error)
                ;(log, )
                M02
            o1456 ENDIF
    
    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    G1 y#<_tumbler_enter_up_y>	F#<_VEL_FAST>

    G1 z#<_tumbler_gripper_up_z>	F#<_VEL_FAST>

    G1 x#<_tumbler_aproximates_up_x>	F#<_VEL_FAST>

    G1 x[#<_tumbler_gripper_up_load_from_extract>+#<_tumbler_offset_x_measuring>]	F#<_VEL_SLOW>

    ;GRIPPER UP MEASURING ROUTINE
        o1650 CALL  ;measuring routine gripper up
            o1460 IF [#5399 EQ -1]
                (debug, Tumbler down/up - ERROR IN MEASURING GRIPPER UP ROUTINE)
                ;(log, )
                M02
            o1460 ENDIF
            #<_tumbler_gripper_up_x_error> = [#<_tumbler_gripper_up_x_meas_ref>-#<_gripper_up_value_measure>]
            (debug, Tumbler down/up - MEASURE DIF VS REF = #<_tumbler_gripper_up_x_error> )
            ;(log, )
            o1465 IF [ABS[#<_tumbler_gripper_up_x_error>] GT #<_tumbler_x_error_accepted>]
                (debug, Tumbler down/up - measurement length exceeded error)
                ;(log, )
                ;M02
            o1465 ENDIF    

    ;SUBROUTINE CERRAR gripper up CON PIEZA, VERIFY gripper up SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1950 CALL ;cerrar pieza gripper up
            o1467 IF [#5399 EQ -1]
                (debug, ERROR EN ROUTINE TUMBLER UP GRAB)
                ;(log, )
                M02
            o1467 ENDIF

    ;OPEN TUMBLER JAWS
        M64 P03
        M65 P04
    
    ;VERIFY TUMBLER SENSORS JAWS OPEN
        M66 P13 L3 Q5
        o1469 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Jaws are not opened)
            ;(log, )
            M02
        o1469 ENDIF

    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    ;VERIFY GRIPPER UP SENSOR PRESENT COUPLING - must have coupling
        M66 P22 L4 Q0.1
        o1472 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Gripper Up - Coupling not present)
            ;(log, )
            M02
        o1472 ENDIF

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;ROTATE TUMBLER 0 DEGREES
        M64 P02
        M65 P01
    ;(NEXT CYCLE VERIFIES THE SENSORS)

o1400 ENDSUB


(**********************************************************************)
(***** ROUTINE TUMBLER gripper start down - ends down             *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o1500 SUB ;ROUTINE TUMBLER gripper start down - ends down

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o1551 IF [#5399 EQ -1]
            (debug, Tumbler down - Not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o1551 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o1552 IF [#5399 EQ -1]
            (debug, Tumbler down - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o1552 ENDIF

    ;TUMBLER - Open Jaws Sensor
        M66 P13 L3 Q0.1
        o1555 IF [#5399 EQ -1]
            (debug, Tumbler down - Jaws are not opened)
            ;(log, )
            M02
        o1555 ENDIF
    
    ;VERIFY SENSOR ROTATOR IN 0 DEGREES
        M66 P10 L3 Q0.1
        o1560 IF [#5399 EQ -1]
            (debug, Tumbler down - Rotator not in 0 degrees)
            ;(log, )
            M02
        o1560 ENDIF

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must have coupling
        M66 P21 L4 Q0.1
        o1565 IF [#5399 EQ -1]
            (debug, Tumbler down - Gripper Down - Coupling not present)
            ;(log, )
            M02
        o1565 ENDIF

    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    G1 y#<_tumbler_enter_down_y>	F#<_VEL_FAST>

    G1 z#<_tumbler_gripper_down_z>	F#<_VEL_FAST>

    G1 x#<_tumbler_aproximates_down_x>	F#<_VEL_FAST>

    G1 x[#<_tumbler_gripper_down_unload_x_calculated>+#<_tumbler_x_displacement>]	F#<_VEL_MEDIUM>

    ;CLOSE TUMBLER JAWS
        M64 P04
        M65 P03
        
    ;VERIFY TUMBLER SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        G04 p3

        M66 P13 L4 Q0.1 (Check signal of Jaws not opened)
        o1570 IF [#5399 EQ -1]
            (debug, Tumbler down - ERROR IN CLOSING JAWS WITH COUPLING - opened)
            ;(log, )
            M02
        o1570 ENDIF

        M66 P12 L4 Q0.1 (Check signal of Jaws not closed)
        o1575 IF [#5399 EQ -1]
            (debug, Tumbler down/up - ERROR IN CLOSING JAWS WITH COUPLING - closed)
            ;(log, )
            M02
        o1575 ENDIF
   
    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o1581 IF [#5399 EQ -1]
                (debug, Tumbler down - Gripper Down open routine error)
                ;(log, )
                M02
            o1581 ENDIF

    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    ;ROTATE TUMBLER 180 DEGREES
        M64 P01
        M65 P02

    ;VERIFY SENSOR ROTATOR IN 180 DEGREES
        M66 P11 L3 Q10
        o1585 IF [#5399 EQ -1]
            (debug, Tumbler down - Rotator not in 180 degrees)
            ;(log, )
            M02
        o1585 ENDIF

    G1 x#<_tumbler_aproximates_down_x>	F#<_VEL_FAST>

    G1 x#<_tumbler_gripper_down_load_x_calculated>	F#<_VEL_SLOW>
    ;it goes to grab the coupling at the dimension if it would be turned by the middle of the coupling length
    ;but it turned with an offset off _tumbler_x_displacement, so the coupling wont be at the end of the gripper compressing the springs

    ;SUBROUTINE CLOSE GRD WITH COUPLING, NO PRESSING SHEETMETAL, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
    o1925 CALL  ;close gripper down with coupling
        o1588 IF [#5399 EQ -1]
            (debug, Tumbler down - ERROR CLOSING GRD WITH COUPLING, NO PRESSING SHEETMETAL)
            ;(log, )
            M02
        o1588 ENDIF

    ;OPEN TUMBLER JAWS
        M64 P03
        M65 P04
    
    ;VERIFY TUMBLER SENSORS JAWS OPEN
        M66 P13 L3 Q5
        o1590 IF [#5399 EQ -1]
            (debug, Tumbler down - Jaws are not opened)
            ;(log, )
            M02
        o1590 ENDIF
    
    ; ************ OFFSET FROM CENTER ************

    G1 x[#<_tumbler_gripper_down_extracts>+#<_tumbler_x_displacement>]	F#<_VEL_FAST>
    ;to extract the coupling end face to the point _tumbler_gripper_down_extracts 
    ;has to move with the plus off the previous offset that it was left before: _tumbler_x_displacement

    ;CLOSE TUMBLER JAW
        M64 P04
        M65 P03
        
    ;VERIFY TUMBLER SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        G04 p3

        M66 P13 L4 Q0.1 (Check signal of Jaws not opened)
        o1591 IF [#5399 EQ -1]
            (debug, Tumbler down - ERROR IN CLOSING JAWS WITH COUPLING - opened)
            ;(log, )
            M02
        o1591 ENDIF

        M66 P12 L4 Q0.1 (Check signal of Jaws not closed)
        o1592 IF [#5399 EQ -1]
            (debug, Tumbler down - ERROR IN CLOSING JAWS WITH COUPLING - closed)
            ;(log, )
            M02
        o1592 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o1593 IF [#5399 EQ -1]
                (debug, Tumbler down - Gripper Down open routine error)
                ;(log, )
                M02
            o1593 ENDIF

    G1 x[#<_tumbler_gripper_down_load_from_extract>+#<_tumbler_offset_x_measuring>]	F#<_VEL_SLOW>
    
    ;GRIPPER DOWN MEASURING ROUTINE
        o1600 CALL ;measuring routine gripper down
            o1594 IF [#5399 EQ -1]
                (debug, Tumbler down - ERROR IN MEASURING GRIPPER DOWN ROUTINE)
                ;(log, )
                M02
            o1594 ENDIF
            #<_tumbler_gripper_down_x_error> = [#<_tumbler_gripper_down_x_meas_ref>-#<_gripper_down_value_measure>]
            (debug, Tumbler down - MEASURE DIF VS REF = #<_tumbler_gripper_down_x_error> )
            ;(log, )
            o1595 IF [ABS[#<_tumbler_gripper_down_x_error>] GT #<_tumbler_x_error_accepted>]
                (debug, Tumbler down - measurement length exceeded error)
                ;(log, )
                ;M02
            o1595 ENDIF

    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o1596 IF [#5399 EQ -1]
                (debug, Tumbler down - ERROR IN CLOSING GRIPPER DOWN WITH COUPLING)
                ;(log, )
                M02
            o1596 ENDIF

    ;OPEN TUMBLER JAWS
        M64 P03
        M65 P04
    
    ;VERIFY TUMBLER SENSORS JAWS OPEN
        M66 P13 L3 Q5
        o1597 IF [#5399 EQ -1]
            (debug, Tumbler down/up - Jaws are not opened)
            ;(log, )
            M02
        o1597 ENDIF

    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must have coupling
        M66 P21 L4 Q0.1
        o1598 IF [#5399 EQ -1]
            (debug, Tumbler down - Gripper Down - Coupling not present)
            ;(log, )
            M02
        o1598 ENDIF

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    ;ROTATE TUMBLER 0 DEGREES
        M64 P02
        M65 P01
    ;(NEXT CYCLE VERIFIES THE SENSORS)

o1500 ENDSUB


(**********************************************************************)
(***** ROUTINE TUMBLER gripper down grabs BEFORE TURNING          *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o3500 SUB ;ROUTINE TUMBLER gripper down grabs BEFORE TURNING

    #<_measuring_limit> = 40 ;we increase this limit

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o3502 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o3502 ENDIF
 
    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o3504 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o3504 ENDIF

    ;VERIFY SENSOR ROTATOR IN 0 DEGREES
        M66 P10 L3 Q0.1
        o3506 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Rotator not in 0 degrees)
            ;(log, )
            M02
        o3506 ENDIF

    ;VERIFY TUMBLER SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        G04 p3

        M66 P13 L4 Q0.1 (Check signal of Jaws not opened)
        o3508 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - ERROR IN CLOSING JAWS WITH COUPLING - opened)
            ;(log, )
            M02
        o3508 ENDIF

        M66 P12 L4 Q0.1 (Check signal of Jaws not closed)
        o3510 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - ERROR IN CLOSING JAWS WITH COUPLING - closed)
            ;(log, )
            M02
        o3510 ENDIF

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must NOT have coupling
        M66 P21 L3 Q0.1
        o3512 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Gripper Down - Coupling present)
            ;(log, )
            M02
        o3512 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o3514 IF [#5399 EQ -1]
                (debug, Tumbler down grabs - Gripper Down open routine error)
                ;(log, )
                M02
            o3514 ENDIF
   
    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    G1 y#<_tumbler_enter_down_y>	F#<_VEL_FAST>

    G1 z#<_tumbler_gripper_down_z>	F#<_VEL_FAST>

    G1 x#<_tumbler_aproximates_down_x>	F#<_VEL_FAST>

    G1 x[#<_tumbler_gripper_down_load_x_calculated>+#<_tumbler_x_displacement>+#<_tumbler_offset_x_measuring>]	F#<_VEL_SLOW>

    ;GRIPPER DOWN MEASURING ROUTINE
        o1600 CALL ;measuring routine gripper down
            o3516 IF [#5399 EQ -1]
                (debug, Tumbler down grabs - ERROR IN MEASURING GRIPPER DOWN ROUTINE)
                ;(log, )
                M02
            o3516 ENDIF
            #<_tumbler_gripper_down_x_error> = [#<_tumbler_gripper_down_x_meas_ref>-#<_gripper_down_value_measure>]
            (debug, Tumbler down - MEASURE DIF VS REF = #<_tumbler_gripper_down_x_error> )
            ;(log, )
            o3518 IF [ABS[#<_tumbler_gripper_down_x_error>] GT #<_tumbler_x_error_accepted>]
                (debug, Tumbler down grabs - measurement length exceeded error)
                ;(log, )
                ;M02
            o3518 ENDIF

    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o3520 IF [#5399 EQ -1]
                (debug, Tumbler down grabs - ERROR IN CLOSING GRIPPER DOWN WITH COUPLING)
                ;(log, )
                M02
            o3520 ENDIF

    ;OPEN TUMBLER JAWS
        M64 P03
        M65 P04
    
    ;VERIFY TUMBLER SENSORS JAWS OPEN
        M66 P13 L3 Q5
        o3522 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Jaws are not opened)
            ;(log, )
            M02
        o3522 ENDIF
   
    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must have coupling
        M66 P21 L4 Q0.1
        o3524 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Gripper Down - Coupling not present)
            ;(log, )
            M02
        o3524 ENDIF

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    #<_measuring_limit> = 20 ;we put it back to normal

o3500 ENDSUB


(**********************************************************************)
(***** ROUTINE TUMBLER gripper down grabs AFTER TURNED            *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o3550 SUB ;ROUTINE TUMBLER gripper down grabs AFTER TURNED

    #<_measuring_limit> = 40 ;we increase this limit

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
        o3552 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Not in Safe Position Y/Z coordinates)
            ;(log, )
            M02
        o3552 ENDIF
 
    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o3554 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o3554 ENDIF

    ;VERIFY SENSOR ROTATOR IN 180 DEGREES
        M66 P11 L3 Q0.1
        o3556 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Rotator not in 180 degrees)
            ;(log, )
            M02
        o3556 ENDIF

    ;VERIFY TUMBLER SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        G04 p3

        M66 P13 L4 Q0.1 (Check signal of Jaws not opened)
        o3558 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - ERROR IN CLOSING JAWS WITH COUPLING - opened)
            ;(log, )
            M02
        o3558 ENDIF

        M66 P12 L4 Q0.1 (Check signal of Jaws not closed)
        o3560 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - ERROR IN CLOSING JAWS WITH COUPLING - closed)
            ;(log, )
            M02
        o3560 ENDIF

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must NOT have coupling
        M66 P21 L3 Q0.1
        o3562 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Gripper Down - Coupling present)
            ;(log, )
            M02
        o3562 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o3564 IF [#5399 EQ -1]
                (debug, Tumbler down grabs - Gripper Down open routine error)
                ;(log, )
                M02
            o3564 ENDIF
   
    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    G1 y#<_tumbler_enter_down_y>	F#<_VEL_FAST>

    G1 z#<_tumbler_gripper_down_z>	F#<_VEL_FAST>

    G1 x#<_tumbler_aproximates_down_x>	F#<_VEL_FAST>

    G1 x[#<_tumbler_gripper_down_load_from_extract>+#<_tumbler_offset_x_measuring>]	F#<_VEL_SLOW>

    ;GRIPPER DOWN MEASURING ROUTINE
        o1600 CALL ;measuring routine gripper down
            o3566 IF [#5399 EQ -1]
                (debug, Tumbler down grabs - ERROR IN MEASURING GRIPPER DOWN ROUTINE)
                ;(log, )
                M02
            o3566 ENDIF
            #<_tumbler_gripper_down_x_error> = [#<_tumbler_gripper_down_x_meas_ref>-#<_gripper_down_value_measure>]
            (debug, Tumbler down - MEASURE DIF VS REF = #<_tumbler_gripper_down_x_error> )
            ;(log, )
            o3518 IF [ABS[#<_tumbler_gripper_down_x_error>] GT #<_tumbler_x_error_accepted>]
                (debug, Tumbler down grabs - measurement length exceeded error)
                ;(log, )
                ;M02
            o3518 ENDIF

    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o3570 IF [#5399 EQ -1]
                (debug, Tumbler down grabs - ERROR IN CLOSING GRIPPER DOWN WITH COUPLING)
                ;(log, )
                M02
            o3570 ENDIF

    ;OPEN TUMBLER JAWS
        M64 P03
        M65 P04
    
    ;VERIFY TUMBLER SENSORS JAWS OPEN
        M66 P13 L3 Q5
        o3572 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Jaws are not opened)
            ;(log, )
            M02
        o3572 ENDIF
   
    G1 x#<_tumbler_enter_x>	F#<_VEL_FAST>

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must have coupling
        M66 P21 L4 Q0.1
        o3574 IF [#5399 EQ -1]
            (debug, Tumbler down grabs - Gripper Down - Coupling not present)
            ;(log, )
            M02
        o3574 ENDIF

    G1 z#<_z_secure_position>	        F#<_VEL_FAST>
    G1 y#<_y_secure_position>	        F#<_VEL_FAST>

    #<_measuring_limit> = 20 ;we put it back to normal

o3550 ENDSUB










(**********************************************************************)
(***** ROUTINE LATHE                                              *****)
(**********************************************************************)

(**********************************************************************)
(***** ROUTINE LATHE START - gri down LEAVE / gri up EMPTY        *****)
(*****                                                            *****)
(**********************************************************************)

o3000 SUB

    ;(debug, *** WAIT UNTILL LATHE MACHINES THE PART ***)
    ;VERIFY M180=1
    ;M66 P51 L3 Q5.0 ; wait for the M code relay
    ;o3004 while [#5399 EQ -1]
    ;    ;VERIFY M180=1
    ;    M100 P2
    ;    M66 P51 L3 Q1 ; wait for the M code relay
    ;o3004 endwhile

    M64 P52 ; MFIN=1

    ;SET signal chuck clamp to 0
    M65 P43

    ;SET signal chuck unclamp to 0
    M65 P44

    ;SET signal spindle orientation 1 to 0
    M65 P46

    ;SET signal spindle orientation 2 to 0
    M65 P47

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
            o3005 IF [#5399 EQ -1]
                (debug, LATHE START - Not in Safe Position Y/Z coordinates)
                ;(log, )
                M02
            o3005 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o3006 IF [#5399 EQ -1]
            (debug, LATHE START - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o3006 ENDIF

    G1 x#<_lathe_enter1_x>	F#<_VEL_FAST>
    G1 y#<_lathe_enter1_y>	F#<_VEL_FAST>

    M65 P52 ; MFIN=0

    ;Verify Coupling Present in Gripper Down - must have coupling
        M66 P21 L4 Q0.1
        o3010 IF [#5399 EQ -1]
            (debug, LATHE START - Coupling not present in Gripper Down)
            ;(log, )
            M02
        o3010 ENDIF

    ;Verify Coupling NOT Present in Gripper Up - must NOT be present
        M66 P22 L3 Q0.1
        o3015 IF [#5399 EQ -1]
            (debug, LATHE START - Error Coupling present in Gripper Up)
            ;(log, )
            M02
        o3015 ENDIF

    (debug, *** WAIT UNTILL PRESS SYSTEM LINK 1 ***)

    ;SYSTEM LINK MODE ON
    M66 P55 L3 Q5

    o3016 while [#5399 EQ -1]
        ;SYSTEM LINK MODE ON
        M100 P55
        M66 P55 L3 Q1
    o3016 endwhile

    ;OPEN MOON ROOF
    M64 P13
    M65 P14

    ;VERIFY MOON ROOF OPEN SENSOR
        M66 P20 L3 Q10
        o3030 IF [#5399 EQ -1]
            (debug, LATHE START - Moon Roof Open Sensor not present)
            ;(log, )
            M02
        o3030 ENDIF

    ;MOON ROOF signals to 0
        M65 P13
        M65 P14

    (debug, *** WAIT UNTILL HOME POSITION ***)

    ;VERIFY Signal Machine Home position ON
        M66 P48 L3 Q5

        o3031 while [#5399 EQ -1]
            ;Machine Home position ON
            M100 P48
            M66 P48 L3 Q1
        o3031 endwhile

    (debug, *** WAIT UNTILL PRESS SYSTEM LINK 2 ***)

    ;SYSTEM LINK MODE ON
    M66 P55 L3 Q5

    o3032 while [#5399 EQ -1]
        ;SYSTEM LINK MODE ON
        M100 P55
        M66 P55 L3 Q1
    o3032 endwhile

    G4 P1

    ;SET Open Chuck
        M64 P44

    ;SET Spindle Orientation 1 ON
        M64 P46

    G1 z#<_lathe_enter1_z>	F#<_VEL_FAST>

    ;Spindle Orientation 1 Confirmation
        M66 P45 L3 Q5
        o3035 IF [#5399 EQ -1]
            (debug, LATHE START - NO Spindle Orientation 1 Confirmation)
            ;(log, )
            M02
        o3035 ENDIF

    ;Open Chuck Confirmation
        M66 P43 L3 Q5
        o3040 IF [#5399 EQ -1]
            (debug, LATHE START - NO Open Chuck Confirmation)
            ;(log, )
            M02
        o3040 ENDIF

    ;SET signal chuck unclamp to 0
    M65 P44

    ;SET signal spindle orientation 1 to 0
    M65 P46

    G1 z#<_lathe_gripper_down_center_z>	F#<_VEL_SLOW>
    G1 y#<_lathe_gripper_down_center_y>	F#<_VEL_SLOW>

    G1 x#<_lathe_gripper_down_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x#<_lathe_gripper_down_x_calculated>	F#<_VEL_SLOW>

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;open gripper down
            o3045 IF [#5399 EQ -1]
                (debug, LATHE START - Gripper Down open routine error)
                ;(log, )
                M02
            o3045 ENDIF

    ;SET Close Chuck
        M64 P43

    ;Close Chuck Confirmation
        M66 P42 L3 Q10	
        o3050 IF [#5399 EQ -1]
            (debug, LATHE START - NO Close Chuck Confirmation)
            ;(log, )
            M02
        o3050 ENDIF

    ;SET signal chuck clamp to 0
    M65 P43

    G1 x#<_lathe_enter1_x>	F#<_VEL_FAST>

    G1 y#<_lathe_enter1_y>	F#<_VEL_FAST>

    G1 z#<_z_secure_position> F#<_VEL_FAST>
    G1 y#<_y_secure_position> F#<_VEL_FAST>

    ;VERIFY GRIPPER DOWN SENSOR PRESENT COUPLING - must NOT have coupling
        M66 P21 L3 Q0.1
        o3055 IF [#5399 EQ -1]
            (debug, LATHE START - Gripper Down - Coupling present)
            ;(log, )
            M02
        o3055 ENDIF

    ;Close Moon Roof
    M64 P14
    M65 P13
    G4 P1
    M65 P14

o3000 ENDSUB

(**********************************************************************)
(***** ROUTINE LATHE PRODUCTION - gri down GRAB / gri up LEAVE    *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o3200 SUB

    ;(debug, *** WAIT UNTILL LATHE MACHINES THE PART ***)
    ;VERIFY M180=1
    ;M66 P51 L3 Q5.0 ; wait for the M code relay
    ;o3204 while [#5399 EQ -1]
    ;    ;VERIFY M180=1
    ;    M100 P2
    ;    M66 P51 L3 Q1 ; wait for the M code relay
    ;o3204 endwhile

    ;SET signal chuck clamp to 0
    M65 P43

    ;SET signal chuck unclamp to 0
    M65 P44

    ;SET signal spindle orientation 1 to 0
    M65 P46

    ;SET signal spindle orientation 2 to 0
    M65 P47

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
            o3205 IF [#5399 EQ -1]
                (debug, LATHE PRODUCTION - Not in Safe Position Y/Z coordinates)
                ;(log, )
                M02
            o3205 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o3206 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o3206 ENDIF

    G1 x#<_lathe_enter1_x>	F#<_VEL_FAST>
    G1 y#<_lathe_enter1_y>	F#<_VEL_FAST>

    M65 P52 ; MFIN=0

    ;-------------------- gripper down GRAB --------------------

    ;VERIFY SENSOR FOR COUPLING PRESENT IN GRIPPER DOWN
        M66 P21 L3 Q0.1
        o3210 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRD - ERROR Present Coupling in Gripper Down)
            ;(log, )
            M02
        o3210 ENDIF

    ;VERIFY SENSOR FOR COUPLING PRESENT IN GRIPPER UP
        M66 P22 L4 Q0.1
        o3215 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRD - NOT Present Coupling in Gripper UP)
            ;(log, )
            M02
        o3215 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;OPEN gripper down
            o3220 IF [#5399 EQ -1]
                (debug, LATHE PRODUCTION GRD - Gripper Down open routine error)
                ;(log, )
                M02
            o3220 ENDIF

    (debug, *** WAIT UNTILL SYSTEM LINK 1 ***)

    ;SYSTEM LINK MODE ON
    M66 P55 L3 Q5

    o3221 while [#5399 EQ -1]
        ;SYSTEM LINK MODE ON
        M100 P55
        M66 P55 L3 Q1
    o3221 endwhile

    ;OPEN MOON ROOF
    M64 P13
    M65 P14

    ;VERIFY MOON ROOF OPEN SENSOR
        M66 P20 L3 Q10
        o3235 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRD - Moon Roof Open Sensor not present)
            ;(log, )
            M02
        o3235 ENDIF

    ;MOON ROOF signals to 0
        M65 P13
        M65 P14

    (debug, *** WAIT UNTILL HOME POSITION ***)

    ;VERIFY Signal Machine Home position ON
        M66 P48 L3 Q5

        o3230 while [#5399 EQ -1]
            ;Machine Home position ON
            M100 P48
            M66 P48 L3 Q1
        o3230 endwhile

    (debug, *** WAIT UNTILL SYSTEM LINK 2 ***)

    ;SYSTEM LINK MODE ON
    M66 P55 L3 Q5

    o3231 while [#5399 EQ -1]
        ;SYSTEM LINK MODE ON
        M100 P55
        M66 P55 L3 Q1
    o3231 endwhile

    G4 P1      

    ;SET Spindle Orientation 1 ON
        M64 P46

    G1 z#<_lathe_enter1_z>	F#<_VEL_FAST>

    ;Spindle Orientation 1 Confirmation
        M66 P45 L3 Q5	
        o3240 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRD - NO Spindle Orientation 1 Confirmation)
            ;(log, )
            M02
        o3240 ENDIF

    ;SET signal spindle orientation 1 to 0
    M65 P46
  
    G1 z#<_lathe_gripper_down_center_z>	F#<_VEL_SLOW>
    G1 y#<_lathe_gripper_down_center_y>	F#<_VEL_SLOW>

    G1 x#<_lathe_gripper_down_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x[#<_lathe_gripper_down_x_calculated>+#<_lathe_offset_x_measuring>]	F#<_VEL_SLOW>

    ;GRIPPER DOWN MEASURING ROUTINE
        o1600 CALL ;measuring routine gripper down
            o3245 IF [#5399 EQ -1]
                (debug, LATHE PRODUCTION GRD - ERROR IN MEASURING GRIPPER DOWN ROUTINE)
                ;(log, )
                M02
            o3245 ENDIF
            #<_lathe_gripper_down_x_error> = [#<_lathe_gripper_down_x_meas_ref>-#<_gripper_down_value_measure>]
            (debug, LATHE PRODUCTION GRD - MEASURE DIF VS REF = #<_lathe_gripper_down_x_error> )
            ;(log, )
            o3250 IF [ABS[#<_lathe_gripper_down_x_error>] GT #<_lathe_gripper_down_x_error_accepted>]
                (debug, LATHE PRODUCTION GRD - measurement length exceeded error)
                ;(log, )
                ;M02
            o3250 ENDIF

    ;SET Open Chuck
        M64 P44

    ;Open Chuck Confirmation
        M66 P43 L3 Q10	
        o3260 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRD - NO Open Chuck Confirmation)
            ;(log, )
            M02
        o3260 ENDIF

    ;SET signal chuck unclamp to 0
    M65 P44

    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o3255 IF [#5399 EQ -1]
                (debug, LATHE PRODUCTION GRD - ERROR IN CLOSING GRIPPER DOWN WITH COUPLING)
                ;(log, )
                M02
            o3255 ENDIF

    G1 x#<_lathe_enter1_x>	F#<_VEL_MEDIUM>

    ;Verify Coupling Present in Gripper Down - must have coupling
        M66 P21 L4 Q0.1
        o3265 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRD - Coupling not present in Gripper Down)
            ;(log, )
            M02
        o3265 ENDIF

    ;-------------------- gripper up LEAVE --------------------

    ;SET Spindle Orientation 2 ON
        M64 P47 

    G1 z#<_lathe_enter3_z>	F#<_VEL_MEDIUM>
    
    G1 z#<_lathe_gripper_up_center_z>	F#<_VEL_SLOW>
    G1 y#<_lathe_gripper_up_center_y>	F#<_VEL_SLOW>

    ;Spindle Orientation 2 Confirmation
        M66 P44 L3 Q5	
        o3270 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRU - NO Spindle Orientation 2 Confirmation)
            ;(log, )
            M02
        o3270 ENDIF

    ;SET signal spindle orientation 2 to 0
    M65 P47

    G1 x#<_lathe_gripper_up_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x#<_lathe_gripper_up_x_calculated>	F#<_VEL_SLOW>

    ;OPEN GRIPPER UP, ALSO CHECKS SENSOR FOR JAWS OPENED
        o1750 CALL ;OPEN GRIPPER UP
            o3275 IF [#5399 EQ -1]
                (debug, LATHE PRODUCTION GRU - ERROR ROUTINE GRIPPER UP OPEN)
                ;(log, )
                M02
            o3275 ENDIF

    ;SET Close Chuck
        M64 P43

    ;Close Chuck Confirmation
        M66 P42 L3 Q10
        o3280 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRU - NO Close Chuck Confirmation)
            ;(log, )
            M02
        o3280 ENDIF

    ;SET signal chuck clamp to 0
    M65 P43

    G1 x#<_lathe_enter1_x>	F#<_VEL_FAST>

    G1 y#<_lathe_enter2_y>	F#<_VEL_FAST>

    G1 z#<_lathe_enter2_z>	F#<_VEL_FAST>

    G1 y#<_lathe_enter1_y>	F#<_VEL_FAST>

    G1 z#<_z_secure_position> F#<_VEL_FAST>
    G1 y#<_y_secure_position> F#<_VEL_FAST>

    ;Verify Coupling NOT Present in Gripper Up - must NOT be present
        M66 P22 L3 Q0.1
        o3285 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRU - ERROR Coupling present in Gripper Up)
            ;(log, )
            M02
        o3285 ENDIF

    ;Verify Coupling Present in Gripper Down - must have coupling
        M66 P21 L4 Q0.1
        o3290 IF [#5399 EQ -1]
            (debug, LATHE PRODUCTION GRU - ERROR Coupling NOT Present in Gripper Down)
            ;(log, )
            M02
        o3290 ENDIF

    ;Close Moon Roof
    M64 P14
    M65 P13
    G4 P1
    M65 P14

o3200 ENDSUB

(**********************************************************************)
(***** ROUTINE LATHE ENDS - gripper down GRAB / gripper up EMPTY  *****)
(***** MEASURE                                                    *****)
(**********************************************************************)

o3400 SUB

    ;(debug, *** WAIT UNTILL LATHE MACHINES THE PART ***)
    ;VERIFY M180=1
    ;M66 P51 L3 Q5.0 ; wait for the M code relay
    ;o3404 while [#5399 EQ -1]
    ;    ;VERIFY M180=1
    ;    M100 P2
    ;    M66 P51 L3 Q1 ; wait for the M code relay
    ;o3404 endwhile

    ;SET signal chuck clamp to 0
    M65 P43

    ;SET signal chuck unclamp to 0
    M65 P44

    ;SET signal spindle orientation 1 to 0
    M65 P46

    ;SET signal spindle orientation 2 to 0
    M65 P47

    ;VERIFY SAFE POSITION
        #5399 = 0
        o2000 CALL  ;SUBROUTINE CHECKS GANTRY IN SAFE POSITION
            o3405 IF [#5399 EQ -1]
                (debug, LATHE ENDS - Not in Safe Position Y/Z coordinates)
                ;(log, )
                M02
            o3405 ENDIF

    ;MASTER - VERIFY ROUTINE RUNNING
        M66 P62 L3 Q0.1
        o3406 IF [#5399 EQ -1]
            (debug, LATHE ENDS - PYTHON ROUTINE not running)
            ;(log, )
            M02
        o3406 ENDIF

    G1 x#<_lathe_enter1_x>	F#<_VEL_FAST>
    G1 y#<_lathe_enter1_y>	F#<_VEL_FAST>

    M65 P52 ; MFIN=0

    ;-------------------- gripper down GRAB --------------------

    ;VERIFY SENSOR FOR COUPLING PRESENT IN GRIPPER DOWN - MUST BE EMPTY
        M66 P21 L3 Q0.1
        o3410 IF [#5399 EQ -1]
            (debug, LATHE ENDS - ERROR Present Coupling in Gripper Down)
            ;(log, )
            M02
        o3410 ENDIF

    ;VERIFY SENSOR FOR COUPLING PRESENT IN GRIPPER UP - MUST BE EMPTY
        M66 P22 L3 Q0.1
        o3415 IF [#5399 EQ -1]
            (debug, LATHE ENDS - ERROR Present Coupling in Gripper UP)
            ;(log, )
            M02
        o3415 ENDIF

    ;ROUTINE OPEN GRIPPER DOWN
        o1700 CALL ;OPEN gripper down
            o3420 IF [#5399 EQ -1]
                (debug,  LATHE ENDS - Gripper Down open routine error)
                ;(log, )
                M02
            o3420 ENDIF

    (debug, LATHE ENDS *** WAIT UNTILL SYSTEM LINK 1 ***)

    ;SYSTEM LINK MODE ON
    M66 P55 L3 Q5

    o3421 while [#5399 EQ -1]
        ;SYSTEM LINK MODE ON
        M100 P55
        M66 P55 L3 Q1
    o3421 endwhile

    ;OPEN MOON ROOF
    M64 P13
    M65 P14

    ;VERIFY MOON ROOF OPEN SENSOR
        M66 P20 L3 Q10
        o3435 IF [#5399 EQ -1]
            (debug, LATHE ENDS - Moon Roof Open Sensor not present)
            ;(log, )
            M02
        o3435 ENDIF

    ;MOON ROOF signals to 0
        M65 P13
        M65 P14

    (debug, *** LATHE ENDS WAIT UNTILL HOME POSITION ***)

    ;VERIFY Signal Machine Home position ON
        M66 P48 L3 Q5

        o3430 while [#5399 EQ -1]
            ;Machine Home position ON
            M100 P48
            M66 P48 L3 Q1
        o3430 endwhile

    (debug, *** LATHE ENDS WAIT UNTILL SYSTEM LINK 2 ***)

    ;SYSTEM LINK MODE ON
    M66 P55 L3 Q5

    o3431 while [#5399 EQ -1]
        ;SYSTEM LINK MODE ON
        M100 P55
        M66 P55 L3 Q1
    o3431 endwhile

    G4 P1

    ;SET Spindle Orientation 1 ON
        M64 P46 

    G1 z#<_lathe_enter1_z>	F#<_VEL_FAST>

    ;Spindle Orientation 1 Confirmation
        M66 P45 L3 Q5
        o3440 IF [#5399 EQ -1]
            (debug, LATHE ENDS - NO Spindle Orientation 1 Confirmation)
            ;(log, )
            M02
        o3440 ENDIF
    
    ;SET signal spindle orientation 1 to 0
    M65 P46

    G1 z#<_lathe_gripper_down_center_z>	F#<_VEL_SLOW>
    G1 y#<_lathe_gripper_down_center_y>	F#<_VEL_SLOW>

    G1 x#<_lathe_gripper_down_aproximates_x>	F#<_VEL_MEDIUM>

    G1 x[#<_lathe_gripper_down_x_calculated>+#<_lathe_offset_x_measuring>]	F#<_VEL_SLOW>

    ;GRIPPER DOWN MEASURING ROUTINE
        o1600 CALL ;measuring routine gripper down
            o3445 IF [#5399 EQ -1]
                (debug,  LATHE ENDS - ERROR IN MEASURING GRIPPER DOWN ROUTINE)
                ;(log, )
                M02
            o3445 ENDIF
            #<_lathe_gripper_down_x_error> = [#<_lathe_gripper_down_x_meas_ref>-#<_gripper_down_value_measure>]
            (debug,  LATHE ENDS - MEASURE DIF VS REF = #<_lathe_gripper_down_x_error> )
            ;(log, )
            o3450 IF [ABS[#<_lathe_gripper_down_x_error>] GT #<_lathe_gripper_down_x_error_accepted>]
                (debug,  LATHE ENDS - measurement length exceeded error)
                ;(log, )
                ;M02
            o3450 ENDIF
    
    ;SET Open Chuck
    M64 P44 

    ;Open Chuck Confirmation
        M66 P43 L3 Q10	
        o3460 IF [#5399 EQ -1]
            (debug, LATHE ENDS - NO Open Chuck Confirmation)
            ;(log, )
            M02
        o3460 ENDIF

    ;SET signal chuck unclamp to 0
    M65 P44

    ;SUBROUTINE CLOSE GRIPPER DOWN WITH COUPLING, CHECK SENSORS JAWS OPEN & CLOSE NOT ACTUATED, WAIT SOME TIME
        o1900 CALL ;close gripper down with coupling
            o3455 IF [#5399 EQ -1]
                (debug,  LATHE ENDS - ERROR IN CLOSING GRIPPER DOWN WITH COUPLING)
                ;(log, )
                M02
            o3455 ENDIF

    G1 x#<_lathe_enter1_x>	F#<_VEL_FAST>
    G1 y#<_lathe_enter1_y>	F#<_VEL_FAST>

    ;Verify Coupling Present in Gripper Down - must have coupling
        M66 P21 L4 Q0.1
        o3465 IF [#5399 EQ -1]
            (debug, LATHE ENDS - ERROR Coupling NOT Present in Gripper Down)
            ;(log, )
            M02
        o3465 ENDIF

    G1 z#<_z_secure_position> F#<_VEL_FAST>
    G1 y#<_y_secure_position> F#<_VEL_FAST>

    ;Close Moon Roof
    M64 P14
    M65 P13
    G4 P1
    M65 P14

o3400 ENDSUB













(**********************************************************************)
(***** MEASURING ROUTINE gripper down                             *****)
(**********************************************************************)

o1600 SUB

    M64 P59 ;flag to measure with gripper down 1
    M65 P58 ;flag to measure with gripper up 0
    
    M66 P21 L3 Q0.1;check coupling present sensor is 0
    o1605 IF [#5399 EQ -1]
        (debug, ERROR gripper down - measuring starts with coupling present sensor actuated)
        ;(log, )
        M65 P59 ;flag to measure with gripper down 0
        M65 P58 ;flag to measure with gripper up 0
        o1600 RETURN
    o1605 END IF

    G04 P01

    #<pos_fin> = [#<_x>-#<_measuring_limit>]
    G38.2 x#<pos_fin> F#<_VEL_RTN_MEAS>
    
    o1610 IF [#5070 EQ 1]
        #<_gripper_down_value_measure>=#5061
        (debug, gripper down measured x coordinate #<_gripper_down_value_measure>)
        ;(log, )
        G1 X[#5420-#<_offset_after_measuring>] F#<_VEL_RTN_MEAS>
    o1610 ELSE
        (debug, measurement length exceeded)
        #5399 = -1
    o1610 END IF

    M65 P59 ;flag to measure with gripper down 0
    M65 P58 ;flag to measure with gripper up 0

o1600 ENDSUB


(**********************************************************************)
(***** MEASURING ROUTINE gripper up                               *****)
(**********************************************************************)

o1650 SUB

    #<pos_fin> = [#<_x>-#<_measuring_limit>]

    M65 P59 ;flag to measure with gripper down 0
    M64 P58 ;flag to measure with gripper up 1
    
    M66 P22 L3 Q0.1;check coupling present sensor is 0
    o1605 IF [#5399 EQ -1]
        (debug, ERROR gripper up - measuring starts with coupling present sensor actuated)
        ;(log, )
        M65 P59 ;flag to measure with gripper down 0
        M65 P58 ;flag to measure with gripper up 0
        o1600 RETURN
    o1605 END IF

    G04 P01

    #<pos_fin> = [#<_x>-#<_measuring_limit>]
    G38.2 x#<pos_fin> F#<_VEL_RTN_MEAS>

    o1610 IF [#5070 EQ 1]
        #<_gripper_up_value_measure>=#5061
        (debug, gripper up measured x coordinate #<_gripper_up_value_measure>)
        ;(log, )
        G1 X[#5420-#<_offset_after_measuring>] F#<_VEL_RTN_MEAS>
    o1610 ELSE
        (debug, measurement length exceeded)
        #5399 = -1
    o1610 END IF

    M65 P59 ;flag to measure with gripper down 0
    M65 P58 ;flag to measure with gripper up 0

o1650 ENDSUB


(**********************************************************************)
(***** ROUTINE ABRIR GRIPPER DOWN                                 *****)
(**********************************************************************)

o1700 SUB
    M64 P22
    M65 P21

    M66 P25 L3 Q5		(Signal of Jaws Opened)
    o1705 IF [#5399 EQ -1]
        (debug, ERROR: Gripper Down - fail to open Jaws)
        ;(log, )
    o1705 ENDIF

o1700 ENDSUB


(**********************************************************************)
(***** ROUTINE ABRIR GRIPPER UP                                   *****)
(**********************************************************************)

o1750 SUB
    M64 P23
    M65 P24

    M66 P26 L3 Q5		(Signal of Jaws Opened)
    o1755 IF [#5399 EQ -1]
        (debug, ERROR: Gripper UP - fail to open Jaws)
        ;(log, )
    o1755 ENDIF

o1750 ENDSUB


(**********************************************************************)
(***** ROUTINE CLOSE GRIPPER DOWN                                 *****)
(**********************************************************************)

o1800 SUB
    M65 P22
    M64 P21

    M66 P23 L3 Q5		(Signal of Jaws Closed)
    o1805 IF [#5399 EQ -1]
        (debug, ERROR: Gripper Down - fail to close Jaws)
        ;(log, )
    o1805 ENDIF

o1800 ENDSUB


(**********************************************************************)
(***** ROUTINE CLOSE GRIPPER UP                                   *****)
(**********************************************************************)

o1850 SUB
    M65 P23
    M64 P24

    M66 P24 L3 Q5		(Signal of Jaws Closed)
    o1855 IF [#5399 EQ -1]
        (debug, ERROR: Gripper UP - fail to close Jaws)
        ;(log, )
    o1855 ENDIF

o1850 ENDSUB


(**********************************************************************)
(***** ROUTINE CLOSE GRIPPER DOWN WITH COUPLING                   *****)
(**********************************************************************)

o1900 SUB
    M65 P22
    M64 P21

    G04 P2.5

    M66 P25 L4 Q5		(Signal of Jaws NOT Opened)
    o1905 IF [#5399 EQ -1]
        (debug, ERROR: Gripper Down - Close with coupling - Jaw Opened sensor activated)
        ;(log, )
        o1900 RETURN
    o1905 ENDIF
    
    M66 P23 L4 Q5		(Signal of Jaws NOT Closed)
    o1910 IF [#5399 EQ -1]
        (debug, ERROR: Gripper Down - Close with coupling - Jaw Closed sensor activated)
        ;(log, )
        o1900 RETURN
    o1910 ENDIF

    M66 P21 L4 Q3		(Signal of present coupling)
    o1915 IF [#5399 EQ -1]
        (debug, ERROR:  Gripper Down - Coupling present sensor not activated)
        ;(log, )
        o1900 RETURN
    o1915 ENDIF

o1900 ENDSUB


(**********************************************************************)
(***** ROUTINE CLOSE GRIPPER DOWN WITH COUPLING WITHOUT PRESENCE  *****)
(**********************************************************************)

o1925 SUB
    M65 P22
    M64 P21

    G04 P2.5

    M66 P25 L4 Q5		(Signal of Jaws NOT Opened)
    o1926 IF [#5399 EQ -1]
        (debug, ERROR: Gripper Down - Close with coupling NO PRESENCE - Jaw Opened sensor activated)
        ;(log, )
        o1900 RETURN
    o1926 ENDIF
    
    M66 P23 L4 Q5		(Signal of Jaws NOT Closed)
    o1927 IF [#5399 EQ -1]
        (debug, ERROR: Gripper Down - Close with coupling NO PRESENCE - Jaw Closed sensor activated)
        ;(log, )
        o1900 RETURN
    o1927 ENDIF


o1925 ENDSUB


(**********************************************************************)
(***** ROUTINE CLOSE GRIPPER UP WITH COUPLING                     *****)
(**********************************************************************)

o1950 SUB
    M65 P23
    M64 P24

    g04 p2.5

    M66 P26 L4 Q5		(Signal of Jaws NOT Opened)
    o1955 IF [#5399 EQ -1]
        (debug, ERROR: Gripper UP - Close with coupling - Jaw Opened sensor activated)
        ;(log, )
        o1950 RETURN
    o1955 ENDIF

    M66 P24 L4 Q5		(Signal of Jaws NOT Closed)
    o1960 IF [#5399 EQ -1]
        (debug, ERROR: Gripper UP - Close with coupling - Jaw Closed sensor activated)
        ;(log, )
        o1950 RETURN
    o1960 ENDIF

    M66 P22 L4 Q3		(Signal of present coupling)
    o1965 IF [#5399 EQ -1]
        (debug, ERROR:  Gripper UP - Coupling present sensor not activated)
        ;(log, )
        o1950 RETURN
    o1965 ENDIF

o1950 ENDSUB


(**********************************************************************)
(***** VERIFY SAFE POSITION WITH TOLERANCE                        *****)
(**********************************************************************)

o2000 SUB

    o2005 IF [#<_y> GT [#<_y_secure_position>+1] OR #<_y> LT [#<_y_secure_position>-1]]
        (debug, AXIS Y error, NOT IN SAFE POSITION)
        ;(log, )
        #5399 = -1
        o2000 RETURN
    o2005 ENDIF

    o2010 IF [#<_z> GT [#<_z_secure_position>+1] OR #<_z> LT [#<_z_secure_position>-1]]
        (debug, AXIS Z error, NOT IN SAFE POSITION)
        ;(log, )
        #5399 = -1
        o2000 RETURN
    o2010 ENDIF

o2000 ENDSUB


(**********************************************************************)
(***** OP10 SPARE=0 / M180=1                                      *****)
(**********************************************************************)

o2200 SUB
    ;(debug, OP10 )

    ;OP10 - CLOSED DOOR SENSOR
    ;M66 P19 L3 Q20
    ;o2205 IF [#5399 EQ -1]
    ;    (debug, OP10 - CLOSED DOOR SENSOR NOT PRESENT)
    ;    ;(log, )
    ;    M02
    ;o2205 ENDIF

    M65 P51 ; SPARE=0

    ;M64 P50 ; CYCLE START=1   

    ;G04 P0.5

    ;M65 P50 ; CYCLE START=0   

    ;VERIFY M180=1
    ;M66 P51 L3 Q5.0 ; wait for the M code relay
    ;o2210 IF [#5399 EQ -1]
    ;    (debug, OP10 - error in the program selection M180=0)
    ;    ;(log, )
    ;    M02
    ;o2210 ENDIF

    ;VERIFY M181=0
    ;M66 P52 L4 Q5.0 ; wait for the M code relay
    ;o2215 IF [#5399 EQ -1]
    ;    (debug, OP10 - error in the program selection M181=1)
    ;    ;(log, )
    ;    M02
    ;o2215 ENDIF
   
    ;M64 P52 ; MFIN=1

    ;VERIFY M180=0
    ;M66 P51 L4 Q5.0 ; wait for the M code relay
    ;o2220 IF [#5399 EQ -1]
    ;    (debug, OP10 - M180 did not went to 0)
    ;    ;(log, )
    ;    M02
    ;o2220 ENDIF

    ;M65 P52 ; MFIN=0

    ;CTRL_ch_of - okuma #operation finished - flag = 0
    ;M65 P53

o2200 ENDSUB


(**********************************************************************)
(----- OP20 SPARE=1 M181=1                                        -----)
(**********************************************************************)

o2150 SUB


    ;(debug, OP20 )

    ;;OP20 - CLOSED DOOR SENSOR
    ;M66 P19 L3 Q20
    ;o2154 IF [#5399 EQ -1]
    ;    (debug, OP20 - CLOSED DOOR SENSOR NOT PRESENT)
    ;    ;(log, )
    ;    M02
    ;o2154 ENDIF

    M64 P51 ;SPARE=1

    ;M64 P50 ;CYCLE START=1 

    ;G04 P0.5

    ;M65 P50 ;CYCLE START=0   

    ;VERIFY M180=0
    ;M66 P51 L4 Q5.0 ; wait for the M code relay
    ;o2155 IF [#5399 EQ -1]
    ;    (debug, OP20 - error in the program selection M180=1)
    ;    ;(log, )
    ;    M02
    ;o2155 ENDIF

    ;VERIFY M181=1
    ;M66 P52 L3 Q5.0 ; wait for the M code relay
    ;o2160 IF [#5399 EQ -1]
    ;    (debug, OP20 - error in the program selection M181=0)
    ;    ;(log, )
    ;    M02
    ;o2160 ENDIF

   
    ;M64 P52 ;MFIN=1

    ;VERIFY M181=0
    ;M66 P52 L4 Q5.0 ; wait for the M code relay
    ;o2120 IF [#5399 EQ -1]
    ;    (debug, OP20 - M181 did not went to 0)
    ;    ;(log, )
    ;    M02
    ;o2120 ENDIF

    ;M65 P52 ; MFIN=0

    ;CTRL_ch_of - okuma #operation finished - flag = 0
    ;M65 P53


o2150 ENDSUB

;