(**********************************************************************)
(***** TABLA DE CALCULOS                                          *****)
(**********************************************************************)

;NOT OD



;**** VALORES CARGADOS EN EL PANEL, Y QUE SE PASAN AL CODIGO G ****
#<_diametro_bruto>= 123.5
#<_diametro_torneado>= 123.5
#<_diametro_interno>= 100

#<_largo_bruto>= 243
#<_largo_op10>= 243
#<_largo_torneado>= 243



;**** VALORES DE CUPLA DE REFERENCIA, EN ESTE CASO D148.4 x L 240 ****
#<_diametro_referencia>= 148.4 
#<_largo_referencia>= 240 



;**** CORRECCIONES DE LARGO ****
#<_correccion_largo_bruto>= [#<_largo_bruto>-#<_largo_referencia>] 
#<_correccion_largo_torneado>= [#<_largo_torneado>-#<_largo_referencia>] 



;**** PS ES PARKING (usa d bruto) Y SOPLADOR (usa d bruto y torneado) ****

;VALOR TOMADO DEL EXCEL CON LOS DATOS DE LA CUPLA DE REFERENCIA, EN ESTE CASO D148.4 x L 240
#<_d_referencia_altura_ps>= 70.83

;VALORES CALCULADOS Y ESCRITOS POR EL PYTHON EN BASE A LOS DATOS CARGADOS POR PANEL 
#<_d_bruto_altura_ps>= 54.8913699957
#<_d_torneado_altura_ps>= 54.8913699957

;CORRECCIONES DE DIAMETRO
#<_d_bruto_correccion_altura_ps>= [#<_d_bruto_altura_ps>-#<_d_referencia_altura_ps>] ;correccion para cuando incide el d bruto
#<_d_torneado_correccion_altura_ps>= [#<_d_torneado_altura_ps>-#<_d_referencia_altura_ps>] ;correccion para cuando incide el d torn



;**** CD ES CARGA (usa d bruto) Y DESCARGA (usa d torneado) ****

;VALOR TOMADO DEL EXCEL CON LOS DATOS DE LA CUPLA DE REFERENCIA, EN ESTE CASO D148.4 x L 240
#<_d_referencia_altura_cd>= 90.58

;VALORES CALCULADOS Y ESCRITOS POR EL PYTHON EN BASE A LOS DATOS CARGADOS POR PANEL
#<_d_bruto_altura_cd>= 75.382830856
#<_d_torneado_altura_cd>= 75.382830856

;CORRECCIONES DE DIAMETRO
#<_d_bruto_correccion_altura_cd>= [#<_d_bruto_altura_cd>-#<_d_referencia_altura_cd>] ;correccion para cuando incide el d bruto
#<_d_torneado_correccion_altura_cd>= [#<_d_torneado_altura_cd>-#<_d_referencia_altura_cd>] ;correccion para cuando incide el d torn


;(**********************************************************************)
;(***** TABLA DE POSICIONES                                        *****)
;(**********************************************************************)



; ********** posicion segura **********
#<_y-pos-segura> = 0
#<_z-pos-segura> = 1350



; ********** medicion **********
#<_offset_luego_medir> = 4
#<_limite_medicion> = 12



; ********** Parking gripper_down y gripper_up ********** 
;(maneja cuplas en bruto)
#<_parking_aproxima_x>=320
#<_parking_gripper_down_dejar_x_calculado>=[232 + #<_correccion_largo_bruto>]
#<_parking_gripper_down_tomar_x_calculado>=[232 + #<_correccion_largo_bruto>]
#<_parking_gripper_up_tomar_x_calculado>=[237 + #<_correccion_largo_bruto>]
#<_parking_gripper_down_z_calculado>=[1318.3 + #<_d_bruto_correccion_altura_ps>]
#<_parking_gripper_up_z_calculado>=[1067.5 + #<_d_bruto_correccion_altura_ps>]
#<_parking_ingreso_x>=350
#<_parking_cambio_up_x>=520
#<_parking_gripper_down_ingreso_y>=372.2
#<_parking_gripper_up_ingreso_y>=370.5
#<_parking_offset_x_medicion>=4
#<_parking_z_offset>=8

;control de largos up (se completa con las primeras mediciones, y el error resultante)
#<_parking_gripper_up_x_med_ref>=[231 + #<_correccion_largo_bruto>]
#<_parking_gripper_up_x_error_admisible>=6

;control de largos up (se completa con las primeras mediciones, y el error resultante)
#<_parking_gripper_down_x_med_ref>=[230 + #<_correccion_largo_bruto>]
#<_parking_gripper_down_x_error_admisible>=6



; ********** Soplador gripper_down ********** 
;(maneja cuplas torneadas)

#<_soplador_aproxima_x>=2100
#<_soplador_gripper_down_dejar_x_calculado>=[2035 + #<_correccion_largo_torneado>]
#<_soplador_gripper_down_tomar_x_calculado>=[2033 + #<_correccion_largo_torneado>]
#<_soplador_gripper_down_z_calculado_torneado>=[1326 + #<_d_torneado_correccion_altura_ps>]
#<_soplador_ingreso_x>=2300
#<_soplador_ingreso_y>=371.1
#<_soplador_offset_x_medicion>=4
#<_soplador_z_offset>=8

;control de largos up (se completa con las primeras mediciones, y el error resultante)
#<_soplador_gripper_down_x_med_ref_torneado>=[2031.8 + #<_correccion_largo_torneado>]
#<_soplador_gripper_down_x_error_admisible>=6



; ********** Carga Gripper down **********
;(maneja cuplas en bruto)
#<_carga_aproxima_x>=350 
#<_carga_gripper_down_x_calculado>=[263 + #<_correccion_largo_bruto>] 
#<_carga_gripper_down_z_calculado>=[379 + #<_d_bruto_correccion_altura_cd>] ;siempre usa D BRUTO
#<_carga_ingreso_x>=400
#<_carga_ingreso_y>=168.6 ;todos los ingresos y ya son centrados
#<_carga_offset_x_medicion>=4
#<_carga_z_offset>=5

;control de largos up (se completa con las primeras mediciones, y el error resultante)
#<_carga_gripper_down_x_med_ref>=[265 + #<_correccion_largo_bruto>]
#<_carga_gripper_down_x_error_admisible>=6



; ********** Descarga gripper_down ********** 
;(maneja cuplas torneadas)
#<_descarga_aproxima_x>=320
#<_descarga_gripper_down_x_calculado>=[255 + 2 + #<_correccion_largo_torneado>]
#<_descarga_gripper_down_z_calculado>=[522.4 + #<_d_torneado_correccion_altura_cd>]
#<_descarga_ingreso_x>=530
#<_descarga_ingreso_intermedio_x>=350
#<_descarga_ingreso_intermedio_Z>=650
#<_descarga_ingreso_y>=454.5
#<_descarga_z_offset>=5



; ********** Volteador gripper_down ********** 
;(suponemos maneja cuplas en bruto porque es el diámetro mayor)

#<_volteador_gripper_down_extrae>=1022
;esta cota es la medida que se extrae hacia un extremo la cupla
;las extrae siempre a la misma medida que es lo máximo que se puede extraer la cupla más corta
;con eso ya alcanza para tomarlo con gripper up
;es: (valor X con gripper en centro volteador) + (largo cupla + corta) - (espesor mordaza volt / 2)
;es: 809+230-17=1022

#<_volteador_aproxima_down_x>=1050 ;ponemos valor cota extrae + plus
#<_volteador_aproxima_up_x>=1050 ;ponemos valor cota extrae + plus

#<_volteador_gripper_down_dejar_x_calculado>=[931 + #<_correccion_largo_bruto> / 2] 
;con la cupla tomada por gripper, venciendo resortes chapa, la deja en el centro del volteador

#<_volteador_gripper_down_tomar_x_calculado>=[931 + #<_correccion_largo_bruto> / 2] 
;en el extremo de la cupla que está a la mitad del volteador, se arrima hasta apoyar la chapa a 2mm del sensor

#<_volteador_gripper_up_tomar_x_calculado>=[1025 + #<_correccion_largo_bruto>]
;en el extremo de la cupla que está extraida (COTA EXTRAE), se arrima hasta apoyar la chapa a 2mm del sensor
;la correccion no es /2 porque es una cota fija donde esta la cupla, la de extrae

#<_volteador_gripper_down_z>=1296.8
#<_volteador_gripper_up_z>=1046
#<_volteador_ingreso_x>=1150
#<_volteador_ingreso_down_y>=441
#<_volteador_ingreso_up_y>=439.1
#<_volteador_offset_x_medicion>=4

;control de largos (se completa con las primeras mediciones, y el error resultante)
#<_volteador_gripper_down_x_med_ref>=[929.8 + #<_correccion_largo_bruto>]
#<_volteador_gripper_up_x_med_ref>=[1024.8 + #<_correccion_largo_bruto>]
#<_volteador_x_error_admisible>=6



; ********** Torno **********
; *** REVISAR
; AGREGAR COMPENSACIONES POR VARIACION DE LARGO ENTRE RAW MATERIAL - OP10 - OP20 ****

#<_torno_gripper_down_aproxima_x>=3000
#<_torno_gripper_down_centro_y>=329.2
#<_torno_gripper_down_centro_z>=288.2
#<_torno_gripper_down_x_calculado>=[2851.3 + #<_correccion_largo_bruto>]

#<_torno_gripper_up_aproxima_x>=3000
#<_torno_gripper_up_centro_y>=326.8
#<_torno_gripper_up_centro_z>=37.6
#<_torno_gripper_up_x_calculado>=[2850.6 + #<_correccion_largo_bruto>]

#<_torno_ingreso1_x>=3110
#<_torno_ingreso1_y>=233
#<_torno_ingreso1_z>=300
#<_torno_ingreso2_y>=150
#<_torno_ingreso2_z>=490
#<_torno_ingreso3_z>=60
#<_torno_offset_x_medicion>=4

;control de largos (se completa con las primeras mediciones, y el error resultante)
#<_torno_gripper_down_x_med_ref>=[2849.6 + #<_correccion_largo_bruto>]
#<_torno_gripper_down_x_error_admisible>=6



(**********************************************************************)
(***** TABLA DE VELOCIDADES                                       *****)
(**********************************************************************)

;#<_VEL_RAPIDA>=35000
;#<_VEL_MEDIA>=15000
;#<_VEL_LENTA>=3000
;#<_VEL_RTN_MEDIR>=400
#<_VEL_RAPIDA>=35000
#<_VEL_MEDIA>=15000
#<_VEL_LENTA>=3000
#<_VEL_RTN_MEDIR>=400

(**********************************************************************)
(***** ENCABEZADO                                                 *****)
(**********************************************************************)

G10 L2 P1 X0 Y0 Z0 ;offset a G54
G90 ;absolute distance
G54 ;zero
G64 P1 ;path blending(cont)
;M68 E0 Q30 ;cambia aceleracion X
;M68 E1 Q20 ;cambia aceleracion Y
;M68 E2 Q10 ;cambia aceleracion Z




(**********************************************************************)
(***** PROGRAMA TESTS                                             *****)
(**********************************************************************)

o800 CALL ;condiciones inciales

o1300 CALL ;RUTINA CARGA gripper down
o3000 CALL ;RUTINA TORNO INICIA - gripper down DEJAR
o2200 CALL ; **** OP10 ****

o1300 CALL ;RUTINA CARGA gripper down
o2100 CALL ;PARKING - DEJAR DOWN - TOMAR UP
o3200 CALL ;RUTINA TORNO MEDIO gripper down TOMAR / gripper up DEJAR
o2200 CALL ; **** OP10 ****

o1400 CALL ;RUTINA VOLTEADOR gripper down - sale up
o3200 CALL ;RUTINA TORNO MEDIO gripper down TOMAR / gripper up DEJAR
o2150 CALL ; ----- OP20 -----

o1400 CALL ;RUTINA VOLTEADOR gripper down - sale up
o3200 CALL ;RUTINA TORNO MEDIO gripper down TOMAR / gripper up DEJAR
o2150 CALL ; ----- OP20 -----
o1200 CALL ;soplador dejar down
o1250 CALL ;soplador tomar down
o1350 CALL ;RUTINA DESCARGA gripper down

o3400 CALL ;RUTINA TORNO TERMINA - gripper down TOMAR
o1200 CALL ;soplador dejar down
o1250 CALL ;soplador tomar down
o1350 CALL ;RUTINA DESCARGA gripper down

G4 P30

M02





(**********************************************************************)
(***** PROGRAMA COMPLETO                                          *****)
(**********************************************************************)

;o800 CALL ;condiciones inciales
;
;o1300 CALL ;RUTINA CARGA gripper down
;o3000 CALL ;RUTINA TORNO INICIA - gripper down DEJAR
;o2200 CALL ; **** OP10 ****
;
;#<_terminar> = 0
;
;o500 WHILE [#<_terminar> LT 10000]
;
;    o1300 CALL ;RUTINA CARGA gripper down
;    o2100 CALL ;PARKING - DEJAR DOWN - TOMAR UP
;    o3200 CALL ;RUTINA TORNO MEDIO gripper down TOMAR / gripper up DEJAR
;    o2200 CALL ; **** OP10 ****
;
;    o1400 CALL ;RUTINA VOLTEADOR gripper down - sale up
;    o3200 CALL ;RUTINA TORNO MEDIO gripper down TOMAR / gripper up DEJAR
;    o2150 CALL ; ----- OP20 -----
;
;    o1400 CALL ;RUTINA VOLTEADOR gripper down - sale up
;    o3200 CALL ;RUTINA TORNO MEDIO gripper down TOMAR / gripper up DEJAR
;    o2150 CALL ; ----- OP20 -----
;
;    o1200 CALL ;soplador dejar down
;    o1250 CALL ;soplador tomar down
;    o1350 CALL ;RUTINA DESCARGA gripper down
;    o1300 CALL ;RUTINA CARGA gripper down
;    o2100 CALL ;PARKING - DEJAR DOWN - TOMAR UP
;    o3200 CALL ;RUTINA TORNO MEDIO gripper down TOMAR / gripper up DEJAR
;    o2200 CALL ; **** OP10 ****
;
;    o1200 CALL ;soplador dejar down
;    o1250 CALL ;soplador tomar down
;    o1350 CALL ;RUTINA DESCARGA gripper down
;
;    #<_terminar> = [#<_terminar> + 1]
;
;    ;VERIFICAR Señal LAST CYCLE
;    M66 Pxx L3 Q0.1	;poner número de entrada
;    o116 IF [#5399 EQ 1]
;        #<_terminar> = 10001
;    o116 ENDIF
;
;o500 ENDWHILE
;
;o10 IF [#<_terminar> GT 10000]
;    o3400 CALL ;RUTINA TORNO TERMINA - gripper down TOMAR
;    O1500 CALL ;RUTINA VOLTEADOR gripper down - sale down
;    o3000 CALL ;RUTINA TORNO INICIA - gripper down DEJAR
;    o2150 CALL ; ----- OP20 -----
;
;    o3400 CALL ;RUTINA TORNO TERMINA - gripper down TOMAR
;    o1200 CALL ;soplador dejar down
;    o1250 CALL ;soplador tomar down
;    o1350 CALL ;RUTINA DESCARGA gripper down
;    M02
;o10 ENDIF

M02


;(**********************************************************************)
;(***** INICIALIZACION CHEQUEOS                                    *****)
;(**********************************************************************)

o800 SUB
; FLAGS A SETEAR
 
    ;pone en 1 el flag - CTRL_ch_of - okuma #operation finished
    ;PARA QUE NO ARRANQUE OKUMA ENTRAR
    M64 P53
    
    ;SENSOR PUERTA CERRADA
    M66 P19 L3 Q0.1
    o126 IF [#5399 EQ -1]
        (debug, INIT TORNO - SENSOR PUERTA CERRADA NO ACCIONADO)
        ;(log, )
        M02
    o126 ENDIF
    
    ;pone en 0 el flag - CTRL_ch_of - okuma #operation finished
    M65 P53

    ;Flag 01 Gantry en carga en 0
    M65 P63

    ;Flag 02 Gantry en descarga en 0
    M65 P62

    ;Flag 03 de accionar soplado en 0
    M65 P60

    ;Flag de NO accionar rutina python de soplado en 0 
    M65 P61

    ;Flag para medir con gripper down en 0
    M65 P59 

    ;Flag para medir con gripper up en 0
    M65 P58

    ;Señal 04 Robot fuera de torno en 1
    ;ROBOT/LOADER OUT OF MACHINE AREA=1
    ;M64 P48 
    ;SE SETEA AUTOMÁTICO, desde el HAL, CUANDO EL GANTRY SALE DE Z POS SEGURA

    ;SETEAR señal de robot loader alarm 1 (que es ok porque es NC)
    ;M64 P39
    ;SE SETEA AUTOMÁTICO, desde el HAL, CUANDO SE PRESIONA LA EMERGENCIA DEL GANTRY O TENEMOS ESTOP
    ;*** REVISAR
    ;VERIFICAR SI HAY UN MODO DE EMERGENCIA QUE PODEMOS SETERA DESDE ERRORES DEL CODIGO G

    ;SETEAR señal de CYCLE START en 0
    M65 P50

    ;SETEAR señal de request answer en 0 (MFIN=0)
    M65 P52
   
    ;SETEAR LOADER SYSTEM LINK/AUTO MODE=1
    ;ya esta ligada a gantry en automatico

    ;SETEAR señal de chuck clamp en 0
    M65 P43

    ;SETEAR señal de chuck unclamp en 0
    M65 P44

    ;SETEAR señal de spindle orientation 1 en 0
    M65 P46

    ;SETEAR señal de spindle orientation 2 en 0
    M65 P47

    G4 P5

; VERIFICA ENTRADAS Y POSICIONES, sino error

    ;POSICION SEGURA
    #5399 = 0
    o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
    o100 IF [#5399 EQ -1]
        (debug, INIT - CARGA gripper down - No en posición segura Y/Z para comenzar)
        ;(log, )
        M02
    o100 ENDIF

    ;Carga - Vertical - sensor de neumático arriba
    M66 P06 L3 Q0.1 ; espera tiempo de rutina de carga
    o101 IF [#5399 EQ -1]
        (debug, INIT - CARGA gripper down - Neumatico vertical de carga no esta arriba)
        ;(log, )
        M02
    o101 ENDIF

    ;Descarga - SENSOR DE VERTICAL DE DESCARGA ARRIBA y SENSOR DE CUPLA NO PRESENTE EN VERTICAL DE DESCARGA
    M66 P05 L3 Q0.1
    o103 IF [#5399 EQ -1]
        (debug, INIT - DESCARGA gripper down - Neumatico vertical de descarga no esta arriba)
        ;(log, )
        M02
    o103 ENDIF

    M66 P15 L3 Q0.1 ; n/c
    o104 IF [#5399 EQ -1]
        (debug, INIT - DESCARGA gripper down - Cupla presente en vertical)
        ;(log, )
        M02
    o104 ENDIF

    ;Descarga - Sensor de descarga completa no accionado (NC)
    M66 P01 L3 Q0.1 ; espera tiempo de rutina de descarga
    o105 IF [#5399 EQ -1]
        (debug, INIT - Bancal de descarga lleno)
        ;(log, )
        M02
    o105 ENDIF

    ;Soplado - Sensor de neumático en puerta abierta
    M66 P17 L3 Q0.1		(thctab.CTRL_blw_er | end routine python)
    o106 IF [#5399 EQ -1]
        (debug, INIT - SOPLADOR DOWN DEJAR - Puerta no esta abierta)
        ;(log, )
        M02
    o106 ENDIF

    ;Soplado - EV de soplado en 0
    M66 P28 L4 Q0.1
    o107 IF [#5399 EQ -1]
        (debug, INIT - SOPLADOR DOWN DEJAR - Soplador de aire encendido)
        ;(log, )
        M02
    o107 ENDIF

    ;Soplado - Sensor de cupla - cupla debe NO estar presente
    M66 P16 L4 Q0.1
    o108 IF [#5399 EQ -1]
        (debug, INIT - SOPLADOR DOWN DEJAR - Cupla presente en soplador)
        ;(log, )
        M02
    o108 ENDIF

    ;Parking - Sensor de cupla - NO debe haber cupla
    M66 P14 L3 Q0.1
    o109 IF [#5399 EQ -1]
        (debug, INIT - Parking - Cupla presente en parking)
        ;(log, )
        M02
    o109 ENDIF
    
    ;Volteador - VERIFICAR SENSOR MORDAZA ABIERTA
    M66 P13 L3 Q0.1
    o110 IF [#5399 EQ -1]
        (debug, INIT - Volteador - Mordaza cerrada)
        ;(log, )
        M02
    o110 ENDIF

    ;Volteador - VERIFICAR SENSOR GIRADOR EN 0 GRADOS
    M66 P10 L3 Q0.1
    o111 IF [#5399 EQ -1]
        (debug, INIT - Volteador - Girador no en posicion 0 grados)
        ;(log, )
        M02
    o111 ENDIF

    ;gripper_down - Sensor de mordaza abierta
    M66 P25 L3 Q0.1		(Chequea la senal de mordaza abierta)
    o112 IF [#5399 EQ -1]
        (debug, INIT - ERROR: gripper abajo no abierto)
        ;(log, )
        M02
    o112 ENDIF
        
    ;gripper_down - Sensor de cupla NO presente
    M66 P21 L3 Q0.1
    o113 IF [#5399 EQ -1]
        (debug, INIT - Cupla presente en gripper de abajo)
        ;(log, )
        M02
    o113 ENDIF

    ;gripper_up - Sensor de mordaza abierta
    M66 P26 L3 Q0.1		(Chequea la senal de mordaza abierta)
    o114 IF [#5399 EQ -1]
        (debug, INIT - ERROR: gripper arriba no abierto)
        ;(log, )
        M02
    o114 ENDIF

    ;gripper_up - Sensor de cupla NO presente
    M66 P22 L3 Q0.1
    o115 IF [#5399 EQ -1]
        (debug, INIT - Parking gripper down - Cupla presente en gripper de abajo - rutina up dejar)
        ;(log, )
        M02
    o115 ENDIF

    ;SYSTEM LINK MODE PRENDIDO
    M66 P55 L3 Q0.1
    o117 IF [#5399 EQ -1]
        (debug, INIT TORNO - Okuma no tiene system link prendido)
        ;(log, )
        M02
    o117 ENDIF
    
    ;Señal 02 torno en nc alarma en 1
    M66 P46 L3 Q0.1	
    o118 IF [#5399 EQ -1]
        (debug, INIT TORNO - Okuma se encuentra en alarma)
        ;(log, )
        M02
    o118 ENDIF

    ;CYCLE COMPLETE EN 1
    M66 P47 L3 Q0.1
    o119 IF [#5399 EQ -1]
        (debug, INIT TORNO - Okuma no finalizo el ciclo)
        ;(log, )
        M02
    o119 ENDIF

    ;MACHINE HOME POSITION EN 1
    ;M66 P48 L3 Q0.1
    ;o120 IF [#5399 EQ -1]
    ;    (debug, INIT TORNO - Okuma señal de machine home position no esta prendida)
    ;    ;(log, )
    ;    M02
    ;o120 ENDIF
    ;no va porque arrancamos con puerta cerrada

    ;CYCLE STOP REQUEST EN 1
    M66 P50 L3 Q0.1
    o121 IF [#5399 EQ -1]
        (debug, INIT TORNO - Okuma cycle stop activado)
        ;(log, )
        M02
    o121 ENDIF

    ;REQUEST 1 (M180) EN 0
    M66 P51 L4 Q0.1
    o122 IF [#5399 EQ -1]
        (debug, INIT TORNO - Okuma señal de m180 prendida)
        ;(log, )
        M02
    o122 ENDIF

    ;REQUEST 2 (M181) EN 0
    M66 P52 L4 Q0.1
    o123 IF [#5399 EQ -1]
        (debug, INIT TORNO - Okuma señal de m181 prendida)
        ;(log, )
        M02
    o123 ENDIF

    ;VERIFICAR PLATO DEL TORNO ABIERTO (la setea el torno, y la lee el Python / Código G)
    M66 P43 L3 Q0.1
    o124 IF [#5399 EQ -1]
        (debug, INIT TORNO - Okuma plato no esta abierto)
        ;(log, )
        M02
    o124 ENDIF

    ;Flag 58 de Gantry puede ingresar en 0 (la setea el Python, y la lee el Código G)
    ;M66 P29 L4 Q0.1
    ;o125 IF [#5399 EQ -1]
    ;    (debug, INIT gantry - flag de gantry puede ingresar no esta apagado)
    ;    ;(log, )
    ;    M02
    ;o125 ENDIF
    ;no se pone porque la rutina Okuma Entrar se ejecuta al principio

    ;VERIFICAR RUTINA DE PYTHON EN 1
    M66 P63 L3 Q0.1
    o127 IF [#5399 EQ -1]
        (debug, INIT PYTHON - Rutina master no esta corriendo)
        ;(log, )
        M02
    o127 ENDIF

o800 ENDSUB








(**********************************************************************)
(***** PARKING - DEJAR DOWN - TOMAR UP                            *****)
(**********************************************************************)

o2100 SUB

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
        o2105 IF [#5399 EQ -1]
            (debug, PARKING- No en posición segura Y/Z para comenzar - rutina down dejar)
            ;(log, )
            M02
        o2105 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN PARKING - no debe haber cupla
        M66 P14 L3 Q0.1
        o2110 IF [#5399 EQ -1]
            (debug, Parking - Cupla presente - rutina down dejar)
            ;(log, )
            M02
        o2110 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o2115 IF [#5399 EQ -1]
            (debug, Parking gripper down - Cupla no presente en gripper de abajo - rutina down dejar)
            ;(log, )
            M02
        o2115 ENDIF

    G1 x#<_parking_ingreso_x>	F#<_VEL_RAPIDA>
    G1 y#<_parking_gripper_down_ingreso_y>	F#<_VEL_RAPIDA>
    
    G1 z[#<_parking_gripper_down_z_calculado>+#<_parking_z_offset>] F#<_VEL_RAPIDA>
    
    G1 x#<_parking_aproxima_x>	F#<_VEL_MEDIA>
    
    G1 x#<_parking_gripper_down_dejar_x_calculado>	F#<_VEL_LENTA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN PARKING - debe haber cupla
        M66 P14 L4 Q0.1
        o2120 IF [#5399 EQ -1]
            (debug, Parking - Cupla no presente - rutina down dejar)
            ;(log, )
            M02
        o2120 ENDIF

    ;SUBRUTINA DE ABRIR gripper down
        o1700 CALL ;abrir gripper down
            o2125 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA PARKING DOWN DEJAR)
                ;(log, )
                M02
            o2125 ENDIF  

    G1 x#<_parking_cambio_up_x>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN PARKING - debe haber cupla
        M66 P14 L4 Q0.1
        o2130 IF [#5399 EQ -1]
            (debug, Parking - Cupla no presente - rutina down dejar)
            ;(log, )
            M02
        o2130 ENDIF

    ;VERIFICAR SENSOR DE CUPLA NO PRESENTE EN gripper down - sino error
        M66 P21 L3 Q0.1
        o2135 IF [#5399 EQ -1]
            (debug, Parking gripper down - Cupla presente en gripper de abajo - rutina down dejar)
            ;(log, )
            M02
        o2135 ENDIF

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper up - sino error
        M66 P22 L3 Q0.1
        o2140 IF [#5399 EQ -1]
            (debug, Parking gripper up - Cupla presente en gripper de arriba - rutina up tomar)
            ;(log, )
            M02
        o2140 ENDIF

    ;ABRIR GRIPPER DE ARRIBA, YA CHEQUEA QUE MORDAZAS ABRAN - sino error
        o1750 CALL ;abrir gripper up
            o2145 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA PARKING up TOMAR)
                ;(log, )
                M02
            o2145 ENDIF

    G1 y#<_parking_gripper_up_ingreso_y>	F#<_VEL_RAPIDA>
    
    G1 z#<_parking_gripper_up_z_calculado>	F#<_VEL_RAPIDA>
    
    G1 x#<_parking_ingreso_x>	F#<_VEL_RAPIDA>

    G1 x#<_parking_aproxima_x>	F#<_VEL_MEDIA>
    
    G1 x[#<_parking_gripper_up_tomar_x_calculado>+#<_parking_offset_x_medicion>]	F#<_VEL_LENTA>
    
    ;SUBRUTINA DE MEDICION gripper up
        o1650 CALL ;mide presencia cupla gripper up
            o2150 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA PARKING up TOMAR)
                ;(log, )
                M02
            o2150 ENDIF
            #<_parking_gripper_up_x_error> = [#<_parking_gripper_up_x_med_ref>-#<_gripper_up_cota_x_med>]
            (debug, PARKING UP TOMAR DIFERENCIA CON X REF = #<_parking_gripper_up_x_error> )
            ;(log, )
            o2155 IF [ABS[#<_parking_gripper_up_x_error>] GT #<_parking_gripper_up_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA PARKING UP TOMAR)
                ;(log, )
                M02
            o2155 ENDIF

    ;SUBRUTINA CERRAR gripper up CON PIEZA, VERIFICAR gripper up SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1950 CALL ;cerrar pieza gripper up
            o2160 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA PARKING UP TOMAR)
                ;(log, )
                M02
            o2160 ENDIF

    ;hace una diagonal en X y Z
    G1 x#<_parking_ingreso_x> z[#<_parking_gripper_up_z_calculado>+#<_parking_z_offset>]	F#<_VEL_RAPIDA>
    
    G1 z#<_z-pos-segura>	        F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura>	        F#<_VEL_RAPIDA>
    
    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN PARKING - NO debe haber cupla
        M66 P14 L3 Q0.1
        o2165 IF [#5399 EQ -1]
            (debug, Parking - Cupla presente parking - rutina up tomar)
            ;(log, )
            M02
        o2165 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper up - sino error
        M66 P22 L4 Q0.1
        o2170 IF [#5399 EQ -1]
            (debug, Parking - Cupla no presente en gripper - rutina up tomar)
            ;(log, )
            M02
        o2170 ENDIF

o2100 ENDSUB








(**********************************************************************)
(***** RUTINA SOPLADOR GRIPPER DOWN DEJAR                         *****)
(**********************************************************************)

o1200 SUB

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
        o1201 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR- No en posición segura Y/Z para comenzar)
            ;(log, )
            M02
        o1201 ENDIF
    
    ;paso 10 verifica flag soplado concluido en 0
        M66 P27 L4 Q10		(thctab.CTRL_blw_er | end routine python)
        o1205 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Soplado con exceso de demora)
            ;(log, )
            M02
        o1205 ENDIF
    
    ;paso 20 verifica sensor de puerta abierta
        M66 P17 L3 Q0.1
        o1210 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Puerta no esta abierta)
            ;(log, )
            M02
        o1210 ENDIF

    ;paso 30 verifica sensor de cupla presente - cupla debe NO estar presente
        M66 P16 L4 Q0.1
        o1215 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Cupla presente en soplador)
            ;(log, )
            M02
        o1215 ENDIF

    ;paso 40 verifica soplador de aire apagado
        M66 P28 L4 Q0.1
        o1220 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Soplador de aire encendido)
            ;(log, )
            M02
        o1220 ENDIF

    ;paso 50 verifica presencia de cupla en gripper gripper down
        M66 P21 L4 Q0.1
        o1225 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1225 ENDIF

    ;SUBRUTINA DE CERRAR gripper up
        o1850 CALL
            o1226 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA SOPLADOR DOWN DEJAR)
                ;(log, )
                M02
            o1226 ENDIF

    ;SETEAR Flag 03 de accionar soplado en 0
        M65 P60

    ;SETEAR Flag de NO accionar rutina python de soplado en 1
        M64 P61
    

    G1 x#<_soplador_ingreso_x>	F#<_VEL_RAPIDA>
    G1 y#<_soplador_ingreso_y>	F#<_VEL_RAPIDA>

    G1 z[#<_soplador_gripper_down_z_calculado_torneado>+#<_soplador_z_offset>]	F#<_VEL_RAPIDA>

    G1 x#<_soplador_aproxima_x>	F#<_VEL_MEDIA>

    G1 x#<_soplador_gripper_down_dejar_x_calculado>	F#<_VEL_LENTA>

    ;SUBRUTINA DE ABRIR DOWN
        o1700 CALL ;abrir gripper down
            o1231 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA SOPLADOR DOWN DEJAR)
                ;(log, )
                M02
            o1231 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN SOPLADOR - cupla debe estar presente
        M66 P16 L3 Q0.1
        o1230 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Cupla no presente en soplador)
            ;(log, )
            M02
        o1230 ENDIF

    G1 x#<_soplador_ingreso_x>	F#<_VEL_RAPIDA>

    G1 z#<_z-pos-segura>	        F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura>	        F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN SOPLADOR - cupla debe estar presente
        M66 P16 L3 Q0.1
        o1235 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Cupla no presente en soplador)
            ;(log, )
            M02
        o1235 ENDIF

    ;VERIFICAR SENSOR DE CUPLA NO PRESENTE EN GRIPPER DOWN - sino error
        M66 P21 L3 Q0.1
        o1240 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN DEJAR - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o1240 ENDIF

    ;SETEAR Flag 03 de accionar soplado en 1
        M64 P60

    ;SETEAR Flag de NO accionar rutina python de soplado en 0
        M65 P61

o1200 ENDSUB


(**********************************************************************)
(***** RUTINA SOPLADOR GRIPPER DOWN TOMAR                         *****)
(***** MIDE                                                       *****)
(**********************************************************************)

o1250 SUB

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
        o1251 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - No en posición segura Y/Z para comenzar)
            ;(log, )
            M02
        o1251 ENDIF

    ;VERIFICAR Flag 55 de soplado concluido en 1 (lo setea el Python, y lo lee el código G)
        M66 P27 L3 Q40
        o1270 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - Soplado con exceso de demora)
            ;(log, )
            M02
        o1270 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN SOPLADOR - cupla debe estar presente
        M66 P16 L3 Q0.1
        o1255 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - Cupla no presente en soplador)
            ;(log, )
            M02
        o1255 ENDIF

    ;VERIFICAR SENSOR DE NEUMÁTICO EN PUERTA ABIERTA
        M66 P17 L3 Q0.1		(thctab.CTRL_blw_er | end routine python)
        o1260 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - Puerta no esta abierta)
            ;(log, )
            M02
        o1260 ENDIF

    ;VERIFICAR EV DE SOPLADO APAGADA
        M66 P28 L4 Q0.1
        o1265 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - Soplador de aire encendido)
            ;(log, )
            M02
        o1265 ENDIF

    ;SUBRUTINA DE ABRIR DOWN
        o1700 CALL ;abrir gripper down
            o1266 IF [#5399 EQ -1]
            (debug, ERROR EN RUTINA SOPLADOR DOWN TOMAR)
            ;(log, )
            M02
            o1266 ENDIF

    ;VERIFICAR SENSOR DE CUPLA NO PRESENTE EN GRIPPER gripper up - sino error
        M66 P22 L3 Q0.1
        o1275 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - Cupla presente en gripper superior)
            ;(log, )
            M02
        o1275 ENDIF

    ;SUBRUTINA DE CERRAR gripper up
        o1850 CALL ;cerrar gripper up
            o1276 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA SOPLADOR DOWN TOMAR)
                ;(log, )
                M02
            o1276 ENDIF

    G1 x#<_soplador_ingreso_x>	F#<_VEL_RAPIDA>

    ;SETEAR Flag de NO accionar rutina python de soplado en 1
        M64 P61

    G1 y#<_soplador_ingreso_y>	F#<_VEL_RAPIDA>

    G1 z#<_soplador_gripper_down_z_calculado_torneado>	F#<_VEL_RAPIDA>

    G1 x#<_soplador_aproxima_x>	F#<_VEL_MEDIA>

    G1 x[#<_soplador_gripper_down_tomar_x_calculado>+#<_soplador_offset_x_medicion>]	F#<_VEL_LENTA>

    ;SUBRUTINA DE MEDICION gripper down
        o1600 CALL ;mide presencia cupla gripper down
            o1277 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA SOPLADOR DOWN TOMAR)
                ;(log, )
                M02
            o1277 ENDIF
            #<_soplador_gripper_down_x_error> = [#<_soplador_gripper_down_x_med_ref_torneado>-#<_gripper_down_cota_x_med>]
            (debug, SOPLADOR DOWN TOMAR DIFERENCIA CON X REF = #<_soplador_gripper_down_x_error> )
            ;(log, )
            o1071 IF [ABS[#<_soplador_gripper_down_x_error>] GT #<_soplador_gripper_down_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA SOPLADOR DOWN TOMAR)
                ;(log, )
                M02
            o1071 ENDIF

    ;SUBRUTINA CERRAR gripper down CON PIEZA, VERIFICAR gripper down SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1900 CALL ;cerrar pieza gripper down
            o1278 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA SOPLADOR DOWN TOMAR)
                ;(log, )
                M02
            o1278 ENDIF

    G1 x#<_soplador_ingreso_x> z[#<_soplador_gripper_down_z_calculado_torneado>+#<_soplador_z_offset>] 	F#<_VEL_RAPIDA>

    G1 z#<_z-pos-segura>	        F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura>	        F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN SOPLADOR - cupla debe NO estar presente
        M66 P16 L4 Q0.1
        o1280 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - Cupla presente en soplador)
            ;(log, )
            M02
        o1280 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o1285 IF [#5399 EQ -1]
            (debug, SOPLADOR DOWN TOMAR - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1285 ENDIF

    ;SETEAR Flag 03 de accionar soplado en 0
        M65 P60

    ;SETEAR Flag de NO accionar rutina python de soplado en 0
        M65 P61

    ;ABRIR GRIPPER DE ARRIBA, YA CHEQUEA QUE MORDAZAS ABRAN - sino error
    ;    o1750 CALL ;abrir gripper up
    ;        o1286 IF [#5399 EQ -1]
    ;            (debug, ERROR EN RUTINA SOPLADOR - rutina tomar)
    ;            ;(log, )
    ;            M02
    ;        o1286 ENDIF
    ;no uso este esquema porque espera que abra para terminar la rutina
    
    ;ABRIR GRIPPER DE ARRIBA
    ;solo doy la orden y sigo a la proxima rutina
    M65 P23
    M64 P24

o1250 ENDSUB







(**********************************************************************)
(***** RUTINA CARGA gripper down                                  *****)
(***** MIDE                                                       *****)
(**********************************************************************)

o1300 SUB

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
        o1301 IF [#5399 EQ -1]
            (debug, CARGA gripper down - No en posición segura Y/Z para comenzar)
            ;(log, )
            M02
        o1301 ENDIF

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper down - sino error
        M66 P21 L3 Q0.1
        o1302 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o1302 ENDIF

    ;VERIFICAR SENSOR MORDAZA ABIERTA EN VOLTEADOR - sino error
        M66 P13 L3 Q0.1
        o1303 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Mordaza cerrada)
            ;(log, )
            M02
        o1303 ENDIF

    ;VERIFICAR SENSOR GIRADOR EN 0 GRADOS - sino error
        M66 P10 L3 Q0.1
        o1304 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Girador no en posicion 0 grados)
            ;(log, )
            M02
        o1304 ENDIF

    ;Parking Sensor de cupla - NO debe haber cupla
        M66 P14 L3 Q0.1
        o1305 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Cupla presente en parking)
            ;(log, )
            M02
        o1305 ENDIF

    ;SUBRUTINA DE ABRIR DOWN
        o1700 CALL ;abrir gripper down
            o1306 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA CARGA gripper down)
                ;(log, )
                M02
            o1306 ENDIF

    G1 x#<_carga_ingreso_x>	F#<_VEL_RAPIDA>
    G1 y#<_carga_ingreso_y>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE VERTICAL DE CARGA ARRIBA y SENSOR DE CUPLA PRESENTE EN VERTICAL DE CARGA - sino esperar
        M66 P06 L3 Q10 ; espera tiempo de rutina de carga
        o1310 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Neumatico vertical de carga no esta arriba)
            ;(log, )
            M02
        o1310 ENDIF

        M66 P07 L3 Q1 ; n/o
        o1315 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Cupla no presente en vertical de carga)
            ;(log, )
            M02
        o1315 ENDIF

    G1 z#<_carga_gripper_down_z_calculado>	F#<_VEL_RAPIDA>

    ;SETEAR Flag 01 Gantry en carga en 1
       M64 P63

    G1 x#<_carga_aproxima_x>	F#<_VEL_MEDIA>

    G1 x[#<_carga_gripper_down_x_calculado>+#<_carga_offset_x_medicion>]   F#<_VEL_LENTA>

    ;SUBRUTINA DE MEDICION gripper down
        o1600 CALL ;mide presencia cupla gripper down
            o1316 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA CARGA GRIPPER DOWN)
                ;(log, )
                M02
            o1316 ENDIF
            #<_carga_gripper_down_x_error> = [#<_carga_gripper_down_x_med_ref>-#<_gripper_down_cota_x_med>]
            (debug, CARGA GRIPPER DOWN TOMAR DIFERENCIA CON X REF = #<_carga_gripper_down_x_error> )
            ;(log, )
            o1317 IF [ABS[#<_carga_gripper_down_x_error>] GT #<_carga_gripper_down_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA CARGA GRIPPER DOWN)
                ;(log, )
                M02
            o1317 ENDIF            

    ;SUBRUTINA CERRAR gripper down CON PIEZA, VERIFICAR gripper down SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1900 CALL ;cerrar pieza gripper down
            o1318 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA CARGA gripper down)
                ;(log, )
                M02
            o1318 ENDIF

    G1 z[#<_carga_gripper_down_z_calculado>+#<_carga_z_offset>] F#<_VEL_RAPIDA>

    G1 x#<_carga_ingreso_x>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA no PRESENTE EN VERTICAL DE CARGA - sino error
        M66 P07 L4 Q0.1
        o1320 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Cupla presente en bancal carga)
            ;(log, )
            M02
        o1320 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o1325 IF [#5399 EQ -1]
            (debug, CARGA gripper down - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1325 ENDIF

    G1 z#<_z-pos-segura>	        F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura>	        F#<_VEL_RAPIDA>

    ;SETEAR Flag 01 Gantry en carga en 0
        M65 P63

o1300 ENDSUB


(**********************************************************************)
(***** RUTINA DESCARGA gripper down                               *****)
(**********************************************************************)

o1350 SUB

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
        o1351 IF [#5399 EQ -1]
            (debug, DESCARGA gripper down - No en posición segura Y/Z para comenzar)
            ;(log, )
            M02
        o1351 ENDIF
            
    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o1355 IF [#5399 EQ -1]
            (debug, DESCARGA gripper down - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1355 ENDIF

    G1 x#<_descarga_ingreso_x>	F#<_VEL_RAPIDA>
    G1 y#<_descarga_ingreso_y>	F#<_VEL_RAPIDA>

    G1 z#<_descarga_ingreso_intermedio_z>	F#<_VEL_RAPIDA>
    G1 x#<_descarga_ingreso_intermedio_x>	F#<_VEL_RAPIDA>

    G1 z[#<_descarga_gripper_down_z_calculado>+#<_descarga_z_offset>]	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE VERTICAL DE DESCARGA ARRIBA y SENSOR DE CUPLA NO PRESENTE EN VERTICAL DE DESCARGA - sino esperar
        M66 P05 L3 Q10 ; espera tiempo de rutina de descarga
        o1360 IF [#5399 EQ -1]
            (debug, DESCARGA gripper down - Neumatico vertical de carga no esta arriba)
            ;(log, )
            M02
        o1360 ENDIF

        M66 P15 L3 Q1 ; n/c
        o1365 IF [#5399 EQ -1]
            (debug, DESCARGA gripper down - Cupla presente en vertical)
            ;(log, )
            M02
        o1365 ENDIF

    ;SETEAR Flag 02 Gantry en descarga en 1 
        M64 P62

    G1 x#<_descarga_aproxima_x>	F#<_VEL_MEDIA>

    G1 x#<_descarga_gripper_down_x_calculado>	F#<_VEL_LENTA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN DESCARGA - sino error
        M66 P15 L4 Q0.1 ; n/c
        o1370 IF [#5399 EQ -1]
            (debug, DESCARGA gripper down - Cupla no presente)
            ;(log, )
            M02
        o1370 ENDIF

    ;SUBRUTINA DE ABRIR DOWN
        o1700 CALL ;abrir gripper down
            o1371 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA DESCARGA gripper down)
                ;(log, )
                M02
            o1371 ENDIF

    G1 x#<_descarga_ingreso_x>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN DESCARGA - sino error
        M66 P15 L4 Q0.1 ; n/c
        o1375 IF [#5399 EQ -1]
            (debug, DESCARGA gripper down - Cupla no presente)
            ;(log, )
            M02
        o1375 ENDIF

    ;VERIFICAR SENSOR DE CUPLA NO PRESENTE EN gripper down - sino error
        M66 P21 L3 Q0.1
        o1380 IF [#5399 EQ -1]
            (debug, DESCARGA gripper down - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o1380 ENDIF

    G1 z#<_z-pos-segura>	        F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura>	        F#<_VEL_RAPIDA>

    ;SETEAR Flag 02 Gantry en descarga en 0
        M65 P62

o1350 ENDSUB







(**********************************************************************)
(***** RUTINA VOLTEADOR gripper down - sale up                    *****)
(***** MIDE                                                       *****)
(**********************************************************************)

o1400 SUB

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
        o1401 IF [#5399 EQ -1]
            (debug, Volteador - No en posición segura Y/Z para comenzar)
            ;(log, )
            M02
        o1401 ENDIF

    ;VERIFICAR SENSOR MORDAZA ABIERTA EN VOLTEADOR - sino error
        M66 P13 L3 Q0.1
        o1405 IF [#5399 EQ -1]
            (debug, Volteador - Mordaza cerrada)
            ;(log, )
            M02
        o1405 ENDIF
    
    ;VERIFICAR SENSOR GIRADOR EN 0 GRADOS - sino error
        M66 P10 L3 Q0.1
        o1410 IF [#5399 EQ -1]
            (debug, Volteador - Girador no en posicion 0 grados)
            ;(log, )
            M02
        o1410 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o1415 IF [#5399 EQ -1]
            (debug, Volteador - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1415 ENDIF

    G1 x#<_volteador_ingreso_x>	F#<_VEL_RAPIDA>

    G1 y#<_volteador_ingreso_down_y>	F#<_VEL_RAPIDA>

    G1 z#<_volteador_gripper_down_z>	F#<_VEL_RAPIDA>

    G1 x#<_volteador_aproxima_down_x>	F#<_VEL_RAPIDA>

    G1 x#<_volteador_gripper_down_dejar_x_calculado>	F#<_VEL_MEDIA>

    ;CERRAR MORDAZAS VOLTEADOR
        M64 P04
        M65 P03
        
    ;VERIFICAR SENSORES DE MORDAZA ABIERTA Y CERRADA EN 0 - sino error
        G04 p3

        M66 P13 L4 Q0.1 (Chequea la senal de mordaza no abierta)
        o1420 IF [#5399 EQ -1]
            (debug, Volteador - Cierre con pieza volteador error en mordaza)
            ;(log, )
            M02
        o1420 ENDIF

        M66 P12 L4 Q0.1 (Chequea la senal de mordaza no cerrada)
        o1425 IF [#5399 EQ -1]
            (debug, Volteador - Cierre con pieza volteador error en mordaza)
            ;(log, )
            M02
        o1425 ENDIF
   
    ;SUBRUTINA DE ABRIR DOWN
        o1700 CALL ;abrir gripper down
            o1431 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR)
                ;(log, )
                M02
            o1431 ENDIF

    G1 x#<_volteador_ingreso_x>	F#<_VEL_RAPIDA>

    ;GIRAR VOLTEADOR A 180 GRADOS
        M64 P01
        M65 P02

    ;VERIFICAR SENSOR GIRADOR EN 180 GRADOS - sino error
        M66 P11 L3 Q5
        o1435 IF [#5399 EQ -1]
            (debug, Volteador - Girador no en 180 posicion correcta)
            ;(log, )
            M02
        o1435 ENDIF

    G1 x#<_volteador_aproxima_down_x>	F#<_VEL_RAPIDA>

    G1 x[#<_volteador_gripper_down_tomar_x_calculado>+#<_volteador_offset_x_medicion>]	F#<_VEL_LENTA>

    ;SUBRUTINA DE MEDICION gripper down
        o1600 CALL ;mide presencia cupla gripper down
            o1436 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR GRIPER DOWN)
                ;(log, )
                M02
            o1436 ENDIF
            #<_volteador_gripper_down_x_error> = [#<_volteador_gripper_down_x_med_ref>-#<_gripper_down_cota_x_med>]
            (debug, VOLTEADOR GRIPER DOWN DIFERENCIA CON X REF = #<_volteador_gripper_down_x_error> )
            ;(log, )
            o1437 IF [ABS[#<_volteador_gripper_down_x_error>] GT #<_volteador_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA VOLTEADOR GRIPER DOWN)
                ;(log, )
                M02
            o1437 ENDIF

    ;SUBRUTINA CERRAR gripper down CON PIEZA, VERIFICAR gripper down SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1900 CALL ;cerrar pieza gripper down
            o1438 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR)
                ;(log, )
                M02
            o1438 ENDIF

    ;ABRIR MORDAZAS VOLTEADOR
        M64 P03
        M65 P04
    
    ;VERIFICAR SENSORES DE MORDAZA ABIERTA DEL VOLTEADOR - sino error
        M66 P13 L3 Q5
        o1440 IF [#5399 EQ -1]
            (debug, Volteador - Mordazas no estan abiertas)
            ;(log, )
            M02
        o1440 ENDIF

    ; ************ DIFERENCIA ************

    G1 x#<_volteador_gripper_down_extrae>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o1445 IF [#5399 EQ -1]
            (debug, Volteador - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1445 ENDIF

    ;CERRAR MORDAZAS VOLTEADOR
        M64 P04
        M65 P03
        
    ;VERIFICAR SENSORES DE MORDAZA ABIERTA Y CERRADA EN 0 - sino error
        G04 p3

        M66 P13 L4 Q0.1 (Chequea la senal de mordaza no abierta)
        o1450 IF [#5399 EQ -1]
            (debug, Volteador - Cierre con pieza volteador error en mordaza)
            ;(log, )
            M02
        o1450 ENDIF

        M66 P12 L4 Q0.1 (Chequea la senal de mordaza no cerrada)
        o1455 IF [#5399 EQ -1]
            (debug, Volteador - Cierre con pieza volteador error en mordaza)
            ;(log, )
            M02
        o1455 ENDIF

    ;SUBRUTINA DE ABRIR DOWN
        o1700 CALL ;abrir gripper down
            o1456 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR)
                ;(log, )
                M02
            o1456 ENDIF
    
    G1 x#<_volteador_ingreso_x>	F#<_VEL_RAPIDA>

    G1 y#<_volteador_ingreso_up_y>	F#<_VEL_RAPIDA>

    G1 z#<_volteador_gripper_up_z>	F#<_VEL_RAPIDA>

    G1 x#<_volteador_aproxima_up_x>	F#<_VEL_RAPIDA>

    G1 x[#<_volteador_gripper_up_tomar_x_calculado>+#<_volteador_offset_x_medicion>]	F#<_VEL_LENTA>

    ;SUBRUTINA DE MEDICION gripper up
        o1650 CALL ;mide presencia cupla gripper up
            o1460 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR up TOMAR)
                ;(log, )
                M02
            o1460 ENDIF
            #<_volteador_gripper_up_x_error> = [#<_volteador_gripper_up_x_med_ref>-#<_gripper_up_cota_x_med>]
            (debug, VOLTEADOR UP TOMAR DIFERENCIA CON X REF = #<_volteador_gripper_up_x_error> )
            ;(log, )
            o1465 IF [ABS[#<_volteador_gripper_up_x_error>] GT #<_volteador_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA VOLTEADOR UP TOMAR)
                ;(log, )
                ;M02
            o1465 ENDIF    

    ;SUBRUTINA CERRAR gripper up CON PIEZA, VERIFICAR gripper up SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1950 CALL ;cerrar pieza gripper up
            o1467 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR UP TOMAR)
                ;(log, )
                M02
            o1467 ENDIF

    ;ABRIR MORDAZAS VOLTEADOR
        M64 P03
        M65 P04
    
    ;VERIFICAR SENSORES DE MORDAZA ABIERTA DEL VOLTEADOR - sino error
        M66 P13 L3 Q5
        o1469 IF [#5399 EQ -1]
            (debug, Volteador - Mordazas no estan abiertas)
            ;(log, )
            M02
        o1469 ENDIF

    G1 x#<_volteador_ingreso_x>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper up - sino error
        M66 P22 L4 Q0.1
        o1472 IF [#5399 EQ -1]
            (debug, VOLTEADOR - Cupla no presente en gripper - rutina up tomar)
            ;(log, )
            M02
        o1472 ENDIF

    G1 z#<_z-pos-segura>	        F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura>	        F#<_VEL_RAPIDA>

    ;GIRAR VOLTEADOR A 0 GRADOS
        M64 P02
        M65 P01
    ;(VERIFICA SENSOR EN LA PRÓXIMA EJECUCIÓN DE LA RUTINA)

o1400 ENDSUB


(**********************************************************************)
(***** RUTINA VOLTEADOR gripper down - sale down                  *****)
(***** MIDE                                                       *****)
(**********************************************************************)

o1500 SUB

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
        o1551 IF [#5399 EQ -1]
            (debug, Volteador - No en posición segura Y/Z para comenzar)
            ;(log, )
            M02
        o1551 ENDIF

    ;VERIFICAR SENSOR MORDAZA ABIERTA EN VOLTEADOR - sino error
        M66 P13 L3 Q0.1
        o1555 IF [#5399 EQ -1]
            (debug, Volteador - Mordaza cerrada)
            ;(log, )
            M02
        o1555 ENDIF
    
    ;VERIFICAR SENSOR GIRADOR EN 0 GRADOS - sino error
        M66 P10 L3 Q0.1
        o1560 IF [#5399 EQ -1]
            (debug, Volteador - Girador no en posicion 0 grados)
            ;(log, )
            M02
        o1560 ENDIF

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o1565 IF [#5399 EQ -1]
            (debug, Volteador - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1565 ENDIF

    G1 x#<_volteador_ingreso_x>	F#<_VEL_RAPIDA>

    G1 y#<_volteador_ingreso_down_y>	F#<_VEL_RAPIDA>

    G1 z#<_volteador_gripper_down_z>	F#<_VEL_RAPIDA>

    G1 x#<_volteador_aproxima_down_x>	F#<_VEL_RAPIDA>

    G1 x#<_volteador_gripper_down_dejar_x_calculado>	F#<_VEL_MEDIA>

    ;CERRAR MORDAZAS VOLTEADOR
        M64 P04
        M65 P03
        
    ;VERIFICAR SENSORES DE MORDAZA ABIERTA Y CERRADA EN 0 - sino error
        G04 p3

        M66 P13 L4 Q0.1 (Chequea la senal de mordaza no abierta)
        o1570 IF [#5399 EQ -1]
            (debug, Volteador - Cierre con pieza volteador error en mordaza)
            ;(log, )
            M02
        o1570 ENDIF

        M66 P12 L4 Q0.1 (Chequea la senal de mordaza no cerrada)
        o1575 IF [#5399 EQ -1]
            (debug, Volteador - Cierre con pieza volteador error en mordaza)
            ;(log, )
            M02
        o1575 ENDIF
   
    ;SUBRUTINA DE ABRIR DOWN
        o1700 CALL ;abrir gripper down
            o1581 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR)
                ;(log, )
                M02
            o1581 ENDIF

    G1 x#<_volteador_ingreso_x>	F#<_VEL_RAPIDA>

    ;GIRAR VOLTEADOR A 180 GRADOS
        M64 P01
        M65 P02

    ;VERIFICAR SENSOR GIRADOR EN 180 GRADOS - sino error
        M66 P11 L3 Q5
        o1585 IF [#5399 EQ -1]
            (debug, Volteador - Girador no en 180 posicion correcta)
            ;(log, )
            M02
        o1585 ENDIF

    G1 x#<_volteador_aproxima_down_x>	F#<_VEL_RAPIDA>

    G1 x[#<_volteador_gripper_down_tomar_x_calculado>+#<_volteador_offset_x_medicion>]	F#<_VEL_LENTA>

    ;SUBRUTINA DE MEDICION gripper down
        o1600 CALL ;mide presencia cupla gripper down
            o1586 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR GRIPER DOWN)
                ;(log, )
                M02
            o1586 ENDIF
            #<_volteador_gripper_down_x_error> = [#<_volteador_gripper_down_x_med_ref>-#<_gripper_down_cota_x_med>]
            (debug, VOLTEADOR GRIPER DOWN DIFERENCIA CON X REF = #<_volteador_gripper_down_x_error> )
            ;(log, )
            o1587 IF [ABS[#<_volteador_gripper_down_x_error>] GT #<_volteador_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA VOLTEADOR GRIPER DOWN)
                ;(log, )
                M02
            o1587 ENDIF

    ;SUBRUTINA CERRAR gripper down CON PIEZA, VERIFICAR gripper down SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1900 CALL ;cerrar pieza gripper down
            o1588 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA VOLTEADOR)
                ;(log, )
                M02
            o1588 ENDIF

    ;ABRIR MORDAZAS VOLTEADOR
        M64 P03
        M65 P04
    
    ;VERIFICAR SENSORES DE MORDAZA ABIERTA DEL VOLTEADOR - sino error
        M66 P13 L3 Q5
        o1590 IF [#5399 EQ -1]
            (debug, Volteador - Mordazas no estan abiertas)
            ;(log, )
            M02
        o1590 ENDIF
   
    G1 x#<_volteador_ingreso_x>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE CUPLA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o1595 IF [#5399 EQ -1]
            (debug, Volteador - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o1595 ENDIF

    G1 z#<_z-pos-segura>	        F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura>	        F#<_VEL_RAPIDA>

    ;GIRAR VOLTEADOR A 0 GRADOS
        M64 P02
        M65 P01
    ;(VERIFICA SENSOR EN LA PRÓXIMA EJECUCIÓN DE LA RUTINA)

o1500 ENDSUB







(**********************************************************************)
(***** RUTINA TORNO                                               *****)
(**********************************************************************)

(***********************************************************************)
(***** RUTINA TORNO INICIA - gripper down DEJAR                    *****)
(***** DEJA LA PIEZA CON GRIPPER DOWN)                             *****)
(***********************************************************************)

o3000 SUB

    ;pone en 0 el flag - CTRL_ch_of - okuma #operation finished
    M65 P53

  ;SETEAR señal de chuck clamp en 0
    M65 P43

    ;SETEAR señal de chuck unclamp en 0
    M65 P44

    ;SETEAR señal de spindle orientation 1 en 0
    M65 P46

    ;SETEAR señal de spindle orientation 2 en 0
    M65 P47

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
            o3005 IF [#5399 EQ -1]
                (debug, TORNO INICIA - No en posición segura Y/Z para comenzar)
                ;(log, )
                M02
            o3005 ENDIF

    G1 x#<_torno_ingreso1_x>	F#<_VEL_RAPIDA>
    G1 y#<_torno_ingreso1_y>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE PIEZA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o3010 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Cupla no presente en gripper de abajo)
            ;(log, )
            M02
        o3010 ENDIF

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper up - sino error
        M66 P22 L3 Q0.1
        o3015 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Cupla presente en gripper de arriba)
            ;(log, )
            M02
        o3015 ENDIF

    ;VERIFICAR Flag 58 de Gantry puede ingresar en 1 - sino ESPERAR
        M66 P29 L3 Q30		(thctab.CTRL_ch_ce | okuma can enter python)
        o3020 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Tiempo de espera maximo para ingresar exedido)
            ;(log, )
            M02
        o3020 ENDIF

    ;VERIFICAR Señal 05 Machine zero position en 1 - sino error
        M66 P48 L3 Q0.1	;cambiar entrada a mirar - RI_tor_home_confirm
        o3025 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Okuma no se encuentra en home)
            ;(log, )
            M02
        o3025 ENDIF

    ;VERIFICAR SENSOR DE NEUMÁTICO TECHO ABIERTO - sino error
        M66 P20 L3 Q0.1
        o3030 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Puerta del techo del okuma no esta abierta)
            ;(log, )
            M02
        o3030 ENDIF

    ;SETEAR Señal 04 Robot fuera de torno en 0 - ROBOT/LOADER OUT OF MACHINE AREA = 0
    ;    M65 P48 ;cambiar salida a setear - RI_tor_ofm
    ; SE SETEA AUTOMÁTICO CUANDO EL GANTRY SALE DE Z POS SEGURA

    ;SALIDA PARA ABRIR PLATO
        M64 P44

    ;SALIDA PARA ORIENTAR PLATO EN ANGULO PARA gripper down
        M64 P46 

    G1 z#<_torno_ingreso1_z>	F#<_VEL_RAPIDA>

    ;ENTRADA DE CONFIRMACION PLATO EN ANGULO PARA gripper down
        M66 P45 L3 Q5
        o3035 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Plato del torno no esta en posicion correcta)
            ;(log, )
            M02
        o3035 ENDIF

    ;ENTRADA DE CONFIRMACION PLATO ABIERTO PARA gripper down
        M66 P43 L3 Q5
        o3040 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Plato del torno no abierto)
            ;(log, )
            M02
        o3040 ENDIF

    ;SETEAR señal de chuck unclamp en 0
    M65 P44

    ;SETEAR señal de spindle orientation 1 en 0
    M65 P46

    G1 z#<_torno_gripper_down_centro_z>	F#<_VEL_LENTA>
    G1 y#<_torno_gripper_down_centro_y>	F#<_VEL_LENTA>

    G1 x#<_torno_gripper_down_aproxima_x>	F#<_VEL_MEDIA>

    G1 x#<_torno_gripper_down_x_calculado>	F#<_VEL_LENTA>

    ;SUBRUTINA DE ABRIR gripper down
        o1700 CALL ;abrir gripper down
            o3045 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO inicia down dejar)
                ;(log, )
                M02
            o3045 ENDIF

    ;SALIDA PARA CERRAR PLATO
        M64 P43

    ;ENTRADA DE CONFIRMACION PLATO CERRADO
        M66 P42 L3 Q10	
        o3050 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Falta confirmacion de plato cerrado)
            ;(log, )
            M02
        o3050 ENDIF

    ;SETEAR señal de chuck clamp en 0
    M65 P43

    G1 x#<_torno_ingreso1_x>	F#<_VEL_RAPIDA>

    G1 y#<_torno_ingreso1_y>	F#<_VEL_RAPIDA>

    G1 z#<_z-pos-segura> F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura> F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper down - sino error
        M66 P21 L3 Q0.1
        o3055 IF [#5399 EQ -1]
            (debug, TORNO inicia down dejar - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o3055 ENDIF

    ;SETEAR Señal 04 Robot fuera de torno en 1 - ROBOT/LOADER OUT OF MACHINE AREA = 1
    ;    M64 P48 ;cambiar salida a setear - RI_tor_ofm
    ; SE SETEA AUTOMÁTICO CUANDO EL GANTRY SALE DE Z POS SEGURA
    
    ;pone en 1 el flag - CTRL_ch_of - okuma #operation finished
    M64 P53

o3000 ENDSUB

(***********************************************************************)
(***** RUTINA TORNO MEDIO - gripper down TOMAR / gripper up DEJAR  *****)
(***** MIDE                                                        *****)
(***********************************************************************)

o3200 SUB

    ;pone en 0 el flag - CTRL_ch_of - okuma #operation finished
    M65 P53
  ;SETEAR señal de chuck clamp en 0
    M65 P43

    ;SETEAR señal de chuck unclamp en 0
    M65 P44

    ;SETEAR señal de spindle orientation 1 en 0
    M65 P46

    ;SETEAR señal de spindle orientation 2 en 0
    M65 P47

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
            o3205 IF [#5399 EQ -1]
                (debug, TORNO, TOMA GRD, DEJA GRU - No en posición segura Y/Z para comenzar)
                ;(log, )
                M02
            o3205 ENDIF

    G1 x#<_torno_ingreso1_x>	F#<_VEL_RAPIDA>
    G1 y#<_torno_ingreso1_y>	F#<_VEL_RAPIDA>

    ;-------------------- gripper down TOMAR --------------------

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper down - sino error
        M66 P21 L3 Q0.1
        o3210 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o3210 ENDIF

    ;VERIFICAR SENSOR DE PIEZA PRESENTE EN gripper up - sino error
        M66 P22 L4 Q0.1
        o3215 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Cupla no presente en gripper de arriba)
            ;(log, )
            M02
        o3215 ENDIF

    ;SUBRUTINA DE ABRIR gripper down
        o1700 CALL ;abrir gripper down
            o3220 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO INTERCAMBIO TOMA GRD)
                ;(log, )
                M02
            o3220 ENDIF

    ;VERIFICAR Flag 58 de Gantry puede ingresar en 1 - sino ESPERAR
        M66 P29 L3 Q30		(thctab.CTRL_ch_ce | okuma can enter python)
        o3225 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Tiempo de espera maximo para ingresar exedido)
            ;(log, )
            M02
        o3225 ENDIF

    ;VERIFICAR Señal 05 - MACHINE HOME POSITION = 1 - sino error
        M66 P48 L3 Q0.1	;cambiar entrada a mirar - RI_tor_home_confirm
        o3230 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Okuma no se encuentra en home)
            ;(log, )
            M02
        o3230 ENDIF
        
    ;VERIFICAR SENSOR DE NEUMÁTICO TECHO ABIERTO - sino error
        M66 P20 L3 Q0.1
        o3235 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Puerta del techo del okuma no esta abierta)
            ;(log, )
            M02
        o3235 ENDIF

    ;SETEAR Señal 04 Robot fuera de torno en 0 - ROBOT/LOADER OUT OF MACHINE AREA = 0
    ;    M65 P48 ;cambiar salida a setear - RI_tor_ofm
    ; SE SETEA AUTOMÁTICO CUANDO EL GANTRY SALE DE Z POS SEGURA

    ;SALIDA PARA ORIENTAR PLATO EN ANGULO PARA gripper down
        M64 P46

    G1 z#<_torno_ingreso1_z>	F#<_VEL_RAPIDA>

    ;ENTRADA DE CONFIRMACION PLATO EN ANGULO PARA gripper down
        M66 P45 L3 Q5	
        o3240 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Plato del torno no esta en posicion correcta)
            ;(log, )
            M02
        o3240 ENDIF

    ;SETEAR señal de spindle orientation 1 en 0
    M65 P46
  
    G1 z#<_torno_gripper_down_centro_z>	F#<_VEL_LENTA>
    G1 y#<_torno_gripper_down_centro_y>	F#<_VEL_LENTA>

    G1 x#<_torno_gripper_down_aproxima_x>	F#<_VEL_MEDIA>

    G1 x[#<_torno_gripper_down_x_calculado>+#<_torno_offset_x_medicion>]	F#<_VEL_LENTA>

    ;SUBRUTINA DE MEDICION gripper down
        o1600 CALL ;mide presencia cupla gripper down
            o3245 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO INTERCAMBIO TOMA GRD)
                ;(log, )
                M02
            o3245 ENDIF
            #<_torno_gripper_down_x_error> = [#<_torno_gripper_down_x_med_ref>-#<_gripper_down_cota_x_med>]
            (debug, TORNO INTERCAMBIO TOMA GRD DIFERENCIA CON X REF = #<_torno_gripper_down_x_error> )
            ;(log, )
            o3250 IF [ABS[#<_torno_gripper_down_x_error>] GT #<_torno_gripper_down_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA TORNO INTERCAMBIO TOMA GRD)
                ;(log, )
                M02
            o3250 ENDIF

    ;SUBRUTINA CERRAR gripper down CON PIEZA, VERIFICAR gripper down SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1900 CALL ;cerrar pieza gripper down
            o3255 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO INTERCAMBIO TOMA GRD)
                ;(log, )
                M02
            o3255 ENDIF

    ;SALIDA PARA ABRIR PLATO
        M64 P44

    ;ENTRADA DE CONFIRMACION PLATO ABIERTO
        M66 P43 L3 Q10	
        o3260 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Plato del torno no esta abierto)
            ;(log, )
            M02
        o3260 ENDIF

    ;SETEAR señal de chuck unclamp en 0
    M65 P44

    G1 x#<_torno_ingreso1_x>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE PIEZA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o3265 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO TOMA GRD - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o3265 ENDIF

    ;-------------------- gripper up DEJAR --------------------

    ;SALIDA PARA ORIENTAR PLATO EN ANGULO PARA gripper up
        M64 P47 

    G1 z#<_torno_ingreso3_z>	F#<_VEL_RAPIDA>
    
    G1 z#<_torno_gripper_up_centro_z>	F#<_VEL_LENTA>
    G1 y#<_torno_gripper_up_centro_y>	F#<_VEL_LENTA>

    ;ENTRADA DE CONFIRMACION PLATO EN ANGULO PARA gripper up
        M66 P44 L3 Q5	
        o3270 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO DEJA GRU - Plato del torno no esta en posicion correcta)
            ;(log, )
            M02
        o3270 ENDIF

    ;SETEAR señal de spindle orientation 2 en 0
    M65 P47

    G1 x#<_torno_gripper_up_aproxima_x>	F#<_VEL_MEDIA>

    G1 x#<_torno_gripper_up_x_calculado>	F#<_VEL_LENTA>

    ;ABRIR GRIPPER DE ARRIBA, YA CHEQUEA QUE MORDAZAS ABRAN - sino error
        o1750 CALL ;abrir gripper up
            o3275 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO INTERCAMBIO DEJA GRU)
                ;(log, )
                M02
            o3275 ENDIF

    ;SALIDA PARA CERRAR PLATO
        M64 P43

    ;ENTRADA DE CONFIRMACION PLATO CERRADO
        M66 P42 L3 Q10
        o3280 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO DEJA GRU - Plato del torno no cerrado)
            ;(log, )
            M02
        o3280 ENDIF

    ;SETEAR señal de chuck clamp en 0
    M65 P43

    G1 x#<_torno_ingreso1_x>	F#<_VEL_RAPIDA>

    G1 y#<_torno_ingreso2_y>	F#<_VEL_RAPIDA>

    G1 z#<_torno_ingreso2_z>	F#<_VEL_RAPIDA>

    G1 y#<_torno_ingreso1_y>	F#<_VEL_RAPIDA>

    G1 z#<_z-pos-segura> F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura> F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper up - sino error
        M66 P22 L3 Q0.1
        o3285 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO DEJA GRU - Cupla presente en gripper de arriba)
            ;(log, )
            M02
        o3285 ENDIF

    ;VERIFICAR SENSOR DE PIEZA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o3290 IF [#5399 EQ -1]
            (debug, TORNO INTERCAMBIO DEJA GRU - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o3290 ENDIF

    ;SETEAR Señal 04 Robot fuera de torno en 1 - ROBOT/LOADER OUT OF MACHINE AREA = 1
    ;    M64 P48 ;cambiar salida a setear - RI_tor_ofm
    ; SE SETEA AUTOMÁTICO CUANDO EL GANTRY SALE DE Z POS SEGURA
    
    ;pone en 1 el flag - CTRL_ch_of - okuma #operation finished
    M64 P53

o3200 ENDSUB

(***********************************************************************)
(***** RUTINA TORNO TERMINA - gripper down TOMAR / gripper up VACIO*****)
(***** MIDE                                                        *****)
(***********************************************************************)

o3400 SUB

    ;pone en 0 el flag - CTRL_ch_of - okuma #operation finished
    M65 P53

  ;SETEAR señal de chuck clamp en 0
    M65 P43

    ;SETEAR señal de chuck unclamp en 0
    M65 P44

    ;SETEAR señal de spindle orientation 1 en 0
    M65 P46

    ;SETEAR señal de spindle orientation 2 en 0
    M65 P47

    ;VERIFICAR POSICION SEGURA
        #5399 = 0
        o2000 CALL ;SUBRUTINA PARA VERIFICAR QUE SE ENCUENTRA EN POSICIÓN SEGURA
            o3405 IF [#5399 EQ -1]
                (debug, TORNO TOMAR GRU - No en posición segura Y/Z para comenzar)
                ;(log, )
                M02
            o3405 ENDIF

    G1 x#<_torno_ingreso1_x>	F#<_VEL_RAPIDA>
    G1 y#<_torno_ingreso1_y>	F#<_VEL_RAPIDA>

    ;-------------------- gripper down TOMAR --------------------

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper down - sino error
        M66 P21 L3 Q0.1
        o3410 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o3410 ENDIF

    ;VERIFICAR SENSOR DE PIEZA NO PRESENTE EN gripper up - sino error
        M66 P22 L3 Q0.1
        o3415 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Cupla presente en gripper de arriba)
            ;(log, )
            M02
        o3415 ENDIF

    ;SUBRUTINA DE ABRIR gripper down
        o1700 CALL ;abrir gripper down
            o3420 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO TOMAR GRU)
                ;(log, )
                M02
            o3420 ENDIF
    
    ;VERIFICAR Flag 58 de Gantry puede ingresar en 1 - sino ESPERAR
        M66 P29 L3 Q30		(thctab.CTRL_ch_ce | okuma can enter python)
        o3425 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Tiempo de espera maximo para ingresar exedido)
            ;(log, )
            M02
        o3425 ENDIF

    ;VERIFICAR Señal 05 - MACHINE HOME POSITION = 1 - sino error
        M66 P48 L3 Q0.1	;cambiar entrada a mirar - RI_tor_home_confirm
        o3430 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Okuma no se encuentra en home)
            ;(log, )
            M02
        o3430 ENDIF

    ;VERIFICAR SENSOR DE NEUMÁTICO TECHO ABIERTO - sino error
        M66 P20 L3 Q0.1
        o3435 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Puerta del techo del okuma no esta abierta)
            ;(log, )
            M02
        o3435 ENDIF

    ;SETEAR Señal 04 Robot fuera de torno en 0 - ROBOT/LOADER OUT OF MACHINE AREA = 0
    ;    M65 P48 ;cambiar salida a setear - RI_tor_ofm
    ; SE SETEA AUTOMÁTICO CUANDO EL GANTRY SALE DE Z POS SEGURA

    ;SALIDA PARA ORIENTAR PLATO EN ANGULO PARA gripper down
        M64 P46 

        G1 z#<_torno_ingreso1_z>	F#<_VEL_RAPIDA>

    ;ENTRADA DE CONFIRMACION PLATO EN ANGULO PARA gripper down
        M66 P45 L3 Q5
        o3440 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Plato del torno no esta en posicion correcta)
            ;(log, )
            M02
        o3440 ENDIF
    
    ;SETEAR señal de spindle orientation 1 en 0
    M65 P46

    G1 z#<_torno_gripper_down_centro_z>	F#<_VEL_LENTA>
    G1 y#<_torno_gripper_down_centro_y>	F#<_VEL_LENTA>

    G1 x#<_torno_gripper_down_aproxima_x>	F#<_VEL_MEDIA>

    G1 x[#<_torno_gripper_down_x_calculado>+#<_torno_offset_x_medicion>]	F#<_VEL_LENTA>

    ;SUBRUTINA DE MEDICION gripper down
        o1600 CALL ;mide presencia cupla gripper down
            o3445 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO TOMAR GRU)
                ;(log, )
                M02
            o3445 ENDIF
            #<_torno_gripper_down_x_error> = [#<_torno_gripper_down_x_med_ref>-#<_gripper_down_cota_x_med>]
            (debug, TORNO TOMAR GRU DIFERENCIA CON X REF = #<_torno_gripper_down_x_error> )
            ;(log, )
            o3450 IF [ABS[#<_torno_gripper_down_x_error>] GT #<_torno_gripper_down_x_error_admisible>]
                (debug, EXCESO ERROR ADMISIBLE EN X, EN RUTINA TORNO TOMAR GRU)
                ;(log, )
                M02
            o3450 ENDIF

    ;SUBRUTINA CERRAR gripper down CON PIEZA, VERIFICAR gripper down SENSORES ABIERTO Y CERRADO NO ACCIONADOS, ESPERAR TIEMPO
        o1900 CALL ;cerrar pieza gripper down
            o3455 IF [#5399 EQ -1]
                (debug, ERROR EN RUTINA TORNO TOMAR GRU)
                ;(log, )
                M02
            o3455 ENDIF

    ;SALIDA PARA ABRIR PLATO
        M64 P44 

    ;ENTRADA DE CONFIRMACION PLATO ABIERTO
        M66 P43 L3 Q10	
        o3460 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Plato del torno no esta en posicion correcta)
            ;(log, )
            M02
        o3460 ENDIF

    ;SETEAR señal de chuck unclamp en 0
    M65 P44

    G1 x#<_torno_ingreso1_x>	F#<_VEL_RAPIDA>
    G1 y#<_torno_ingreso1_y>	F#<_VEL_RAPIDA>

    ;VERIFICAR SENSOR DE PIEZA PRESENTE EN gripper down - sino error
        M66 P21 L4 Q0.1
        o3465 IF [#5399 EQ -1]
            (debug, TORNO TOMAR GRU - Cupla presente en gripper de abajo)
            ;(log, )
            M02
        o3465 ENDIF

    G1 z#<_z-pos-segura> F#<_VEL_RAPIDA>
    G1 y#<_y-pos-segura> F#<_VEL_RAPIDA>

    ;SETEAR Señal 04 Robot fuera de torno en 1 - ROBOT/LOADER OUT OF MACHINE AREA = 1
    ;    M64 P48 ;cambiar salida a setear - RI_tor_ofm
    ; SE SETEA AUTOMÁTICO CUANDO EL GANTRY SALE DE Z POS SEGURA

    ;pone en 1 el flag - CTRL_ch_of - okuma #operation finished
    M64 P53

o3400 ENDSUB








(**********************************************************************)
(***** RUTINA MEDICION gripper down                               *****)
(**********************************************************************)

o1600 SUB

    M64 P59 ;levanta flag para medir con gripper down
    M65 P58 ;apaga flag para medir con gripper up
    
    M66 P21 L3 Q0.1;sensor de gripper down ya accionado
    o1605 IF [#5399 EQ -1]
        (debug, sensor de gripper down ya accionado)
        ;(log, )
        M65 P59 ;apaga flag para medir con gripper down
        M65 P58 ;apaga flag para medir con gripper up
        o1600 RETURN
    o1605 END IF

    G04 P01

    #<pos_fin> = [#<_x>-#<_limite_medicion>]
    G38.2 x#<pos_fin> F#<_VEL_RTN_MEDIR>
    
    o1610 IF [#5070 EQ 1]
        #<_gripper_down_cota_x_med>=#5061
        (debug, gripper down cota x medida #<_gripper_down_cota_x_med>)
        ;(log, )
        G1 X[#5420-#<_offset_luego_medir>] F#<_VEL_RTN_MEDIR>
    o1610 ELSE
        (debug, exceso de largo medido)
        #5399 = -1
    o1610 END IF

    M65 P59 ;apaga flag para medir con gripper down
    M65 P58 ;apaga flag para medir con gripper up

o1600 ENDSUB


(**********************************************************************)
(***** RUTINA MEDICION gripper up                                 *****)
(**********************************************************************)

o1650 SUB

    #<pos_fin> = [#<_x>-#<_limite_medicion>]

    M65 P59 ;apaga flag para medir con gripper down
    M64 P58 ;levanta flag para medir con gripper up
    
    M66 P22 L3 Q0.1;chequeo sensor de que no este la cupla en gripper
    o1605 IF [#5399 EQ -1]
        (debug, sensor de gripper up ya accionado)
        ;(log, )
        M65 P59 ;apaga flag para medir con gripper down
        M65 P58 ;apaga flag para medir con gripper up
        o1600 RETURN
    o1605 END IF

    G04 P01

    #<pos_fin> = [#<_x>-#<_limite_medicion>]
    G38.2 x#<pos_fin> F#<_VEL_RTN_MEDIR>

    o1610 IF [#5070 EQ 1]
        #<_gripper_up_cota_x_med>=#5061
        (debug, gripper up cota x medida #<_gripper_up_cota_x_med>)
        ;(log, )
        G1 X[#5420-#<_offset_luego_medir>] F#<_VEL_RTN_MEDIR>
    o1610 ELSE
        (debug, exceso de largo medido)
        #5399 = -1
    o1610 END IF

    M65 P59 ;apaga flag para medir con gripper down
    M65 P58 ;apaga flag para medir con gripper up

o1650 ENDSUB


(**********************************************************************)
(***** RUTINA ABRIR GRIPPER DOWN                                  *****)
(**********************************************************************)

o1700 SUB
    M64 P22
    M65 P21

    M66 P25 L3 Q5		(Chequea la senal de mordaza abierta)
    o1705 IF [#5399 EQ -1]
        (debug, ERROR: falla apertura gripper abajo)
        ;(log, )
    o1705 ENDIF

o1700 ENDSUB


(**********************************************************************)
(***** RUTINA ABRIR GRIPPER UP                                    *****)
(**********************************************************************)

o1750 SUB
    M64 P23
    M65 P24

    M66 P26 L3 Q5		(Chequea la senal de mordaza abierta)
    o1755 IF [#5399 EQ -1]
        (debug, ERROR: falla apertura gripper arriba)
        ;(log, )
    o1755 ENDIF

o1750 ENDSUB


(**********************************************************************)
(***** RUTINA CERRAR GRIPPER DOWN                                 *****)
(**********************************************************************)

o1800 SUB
    M65 P22
    M64 P21

    M66 P23 L3 Q5		(Chequea la senal de mordaza cerrada)
    o1805 IF [#5399 EQ -1]
        (debug, ERROR: falla cerrar gripper abajo)
        ;(log, )
    o1805 ENDIF

o1800 ENDSUB


(**********************************************************************)
(***** RUTINA CERRAR GRIPPER UP                                   *****)
(**********************************************************************)

o1850 SUB
    M65 P23
    M64 P24

    M66 P24 L3 Q5		(Chequea la senal de mordaza cerrada)
    o1855 IF [#5399 EQ -1]
        (debug, ERROR: falla cierre gripper arriba)
        ;(log, )
    o1855 ENDIF

o1850 ENDSUB


(**********************************************************************)
(***** RUTINA CERRAR GRIPPER DOWN CON PIEZA                       *****)
(**********************************************************************)

o1900 SUB
    M65 P22
    M64 P21

    G04 P2.5

    M66 P25 L4 Q5		(Chequea la senal de mordaza no abierta)
    o1905 IF [#5399 EQ -1]
        (debug, ERROR: Cierre con pieza gripper down)
        ;(log, )
        o1900 RETURN
    o1905 ENDIF
    
    M66 P23 L4 Q5		(Chequea la senal de mordaza no cerrada)
    o1910 IF [#5399 EQ -1]
        (debug, ERROR: Cierre con pieza gripper down)
        ;(log, )
        o1900 RETURN
    o1910 ENDIF

    M66 P21 L4 Q3		(Chequea la senal de pieza presente)
    o1915 IF [#5399 EQ -1]
        (debug, ERROR: Cupla no presente gripper down)
        ;(log, )
        o1900 RETURN
    o1915 ENDIF

o1900 ENDSUB


(**********************************************************************)
(***** RUTINA CERRAR GRIPPER UP CON PIEZA                         *****)
(**********************************************************************)

o1950 SUB
    M65 P23
    M64 P24

    g04 p2.5

    M66 P26 L4 Q5		(Chequea la senal de mordaza no abierta)
    o1955 IF [#5399 EQ -1]
        (debug, ERROR: Cierre con pieza UP)
        ;(log, )
        o1950 RETURN
    o1955 ENDIF

    M66 P24 L4 Q5		(Chequea la senal de mordaza no cerrada)
    o1960 IF [#5399 EQ -1]
        (debug, ERROR: Cierre con pieza UP)
        ;(log, )
        o1950 RETURN
    o1960 ENDIF

    M66 P22 L4 Q3		(Chequea la senal de pieza presente)
    o1965 IF [#5399 EQ -1]
        (debug, ERROR: Cupla no presente UP)
        ;(log, )
        o1950 RETURN
    o1965 ENDIF

o1950 ENDSUB


(**********************************************************************)
(***** VERIFICAR POSICION SEGURA CON TOLERANCIA                   *****)
(**********************************************************************)

o2000 SUB

    o2005 IF [#<_y> GT [#<_y-pos-segura>+1] OR #<_y> LT [#<_y-pos-segura>-1]]
        (debug, error eje Y fuera de posicion segura)
        ;(log, )
        #5399 = -1
        o2000 RETURN
    o2005 ENDIF

    o2010 IF [#<_z> GT [#<_z-pos-segura>+1] OR #<_z> LT [#<_z-pos-segura>-1]]
        (debug, error eje Z fuera de posicion segura)
        ;(log, )
        #5399 = -1
        o2000 RETURN
    o2010 ENDIF

o2000 ENDSUB


(**********************************************************************)
(***** OP10 SPARE=0 / M180=1                                      *****)
(**********************************************************************)

o2200 SUB
    ;(debug, OP10 )

    ;OP10 - SENSOR PUERTA CERRADA
    ;M66 P19 L3 Q20
    ;o2205 IF [#5399 EQ -1]
    ;    (debug, OP10 - SENSOR PUERTA CERRADA NO ACCIONADO)
    ;    ;(log, )
    ;    M02
    ;o2205 ENDIF

    M65 P51 ; baja SPARE=0

    M64 P50 ; levanta CYCLE START=1   

    ;G04 P0.5

    ;M65 P50 ; baja CYCLE START=0   

    ;VERIFICAR M180=1
    ;M66 P51 L3 Q5.0 ; espera tiempo a que levante el M
    ;o2210 IF [#5399 EQ -1]
    ;    (debug, OP10 - incongruencia en seleccion de programa M180=0)
    ;    ;(log, )
    ;    M02
    ;o2210 ENDIF

    ;VERIFICAR M181=0
    ;M66 P52 L4 Q5.0 ; espera tiempo a que baje el M
    ;o2215 IF [#5399 EQ -1]
    ;    (debug, OP10 - incongruencia en seleccion de programa M181=1)
    ;    ;(log, )
    ;    M02
    ;o2215 ENDIF
   
    ;M64 P52 ; levanta MFIN=1

    ;VERIFICAR M180=0
    ;M66 P51 L4 Q5.0 ; espera tiempo a que baje el M
    ;o2220 IF [#5399 EQ -1]
    ;    (debug, OP10 - no bajo el M180)
    ;    ;(log, )
    ;    M02
    ;o2220 ENDIF

    ;M65 P52 ; baja MFIN=0

    ;pone en 0 el flag - CTRL_ch_of - okuma #operation finished
    ;M65 P53

o2200 ENDSUB


(**********************************************************************)
(----- OP20 SPARE=1 M181=1                                        -----)
(**********************************************************************)

o2150 SUB


    ;(debug, OP20 )

    ;;OP20 - SENSOR PUERTA CERRADA
    ;M66 P19 L3 Q20
    ;o2154 IF [#5399 EQ -1]
    ;    (debug, OP20 - SENSOR PUERTA CERRADA NO ACCIONADO)
    ;    ;(log, )
    ;    M02
    ;o2154 ENDIF

    M64 P51 ;levanta SPARE=1

    M64 P50 ;levanta CYCLE START=1 

    ;G04 P0.5

    ;M65 P50 ; baja CYCLE START=0   

    ;VERIFICAR M180=0
    ;M66 P51 L4 Q5.0 ; espera tiempo a que baje el M
    ;o2155 IF [#5399 EQ -1]
    ;    (debug, OP20 - incongruencia en seleccion de programa M180=1)
    ;    ;(log, )
    ;    M02
    ;o2155 ENDIF

    ;VERIFICAR M181=1
    ;M66 P52 L3 Q5.0 ; espera tiempo a que levante el M
    ;o2160 IF [#5399 EQ -1]
    ;    (debug, OP20 - incongruencia en seleccion de programa M181=0)
    ;    ;(log, )
    ;    M02
    ;o2160 ENDIF

   
    ;M64 P52 ; levanta MFIN=1

    ;VERIFICAR M181=0
    ;M66 P52 L4 Q5.0 ; espera tiempo a que baje el M
    ;o2120 IF [#5399 EQ -1]
    ;    (debug, OP20 - no bajo el M181)
    ;    ;(log, )
    ;    M02
    ;o2120 ENDIF

    ;M65 P52 ; baja MFIN=0

    ;pone en 0 el flag - CTRL_ch_of - okuma #operation finished
    ;M65 P53


o2150 ENDSUB